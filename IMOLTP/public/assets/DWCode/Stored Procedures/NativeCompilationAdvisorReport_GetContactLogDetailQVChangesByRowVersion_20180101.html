<?xml version="1.0" encoding="utf-8"?>
<html>
  <head>
    <title>Native Compilation Advisor evaluation results for [DWCode].[GetContactLogDetailQVChangesByRowVersion]</title>
  </head>
  <body>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 14pt;">
      <b>Native Compilation Advisor evaluation results for [DWCode].[GetContactLogDetailQVChangesByRowVersion]</b>
    </p>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 10pt;">
      <b>Report Date/Time:</b>1/1/2018 5:12 PM<br /></p>
    <table border="1" cellpadding="5" cellspacing="0" STYLE="font-family: Verdana, Arial, sans-serif; font-size: 9pt;">
      <tr style="background-color:Silver">
        <th colspan="1" align="center">Transact-SQL Element</th>
        <th align="center">Transact-SQL Code</th>
        <th align="center">Line Number</th>
      </tr>
      <tr valign="top">
        <td colspan="1">SET OPTION ON</td>
        <td colspan="1">SET NOCOUNT ON</td>
        <td>2</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">SET XACT_ABORT ON</td>
        <td>3</td>
      </tr>
      <tr valign="top">
        <td colspan="1">COALESCE</td>
        <td colspan="1">COALESCE (scld.Direction, cld.Direction, 3)</td>
        <td>24</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">APPLY</td>
        <td colspan="1">(SELECT   Contact_ID,
          CONVERT (BIT, MAX(IsReprocessed)) AS IsReprocessed
 FROM     (SELECT TOP 10000 Contact_ID,
                            1 AS IsReprocessed
           FROM   DM.ContactLogReprocess
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   Staging.Contact_Log_Header
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   Staging.Contact_Log_DetailQV
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
           UNION ALL
           SELECT Master_Contact_ID AS Contact_ID,
                  0 AS IsReprocessed
           FROM   Staging.Contact_Log_DetailQV
           WHERE  Master_Contact_ID &lt;&gt; Contact_ID
                  AND Contact_State IN (2, 7, 3)
                  AND ReskillIndicator = 4
                  AND Agent_No IS NOT NULL
                  AND RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   Staging.Contact_Log_Footer
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   Staging.Agent_Log_DetailQV AS sald
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
                  AND sald.Contact_ID IS NOT NULL
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   dbo.Contact_Log_Dispositions
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   dbo.IVRHistory
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
                  AND LastTouched &gt;= '2016-10-01 00:00:00.000') AS dst
 GROUP BY Contact_ID) AS flt
LEFT OUTER JOIN
Staging.Contact_Log_Header AS sclh
ON flt.Contact_ID = sclh.Contact_ID
LEFT OUTER JOIN
dbo.Contact_Log_Header AS clh
ON CASE WHEN sclh.Contact_ID IS NULL THEN flt.Contact_ID END = clh.Contact_ID
LEFT OUTER JOIN
Staging.Contact_Log_DetailQV AS scld
ON flt.Contact_ID = scld.Contact_ID
LEFT OUTER JOIN
dbo.Contact_Log_DetailQV AS cld
ON CASE WHEN scld.Contact_ID IS NULL THEN flt.Contact_ID END = cld.Contact_ID
LEFT OUTER JOIN
Staging.Contact_Log_Footer AS sclf
ON flt.Contact_ID = sclf.Contact_ID
LEFT OUTER JOIN
dbo.Contact_Log_Footer AS clf
ON CASE WHEN sclf.Contact_ID IS NULL THEN flt.Contact_ID END = clf.Contact_ID OUTER APPLY (SELECT   TOP 1 child.Contact_ID,
                                                                                                          child.Agent_No,
                                                                                                          child.HeaderStartDate
                                                                                           FROM     staging.Contact_Log_DetailQV AS child
                                                                                           WHERE    child.Master_Contact_Id = flt.Contact_Id
                                                                                                    AND child.Contact_State IN (2, 7, 3)
                                                                                                    AND child.ReskillIndicator = 4
                                                                                                    AND child.Agent_No IS NOT NULL
                                                                                           ORDER BY child.StateIndex ASC) AS st OUTER APPLY (SELECT   TOP 1 child.Contact_ID,
                                                                                                                                                            child.Agent_No,
                                                                                                                                                            child.HeaderStartDate
                                                                                                                                             FROM     dbo.Contact_Log_DetailQV AS child WITH (INDEX (FI_Contact_Log_DetailQV_Master_Contact_ID_INCLUDE_Contact_ID_Agent_No_HeaderStartDate_StateIndex))
                                                                                                                                             WHERE    CASE WHEN st.Contact_ID IS NULL THEN flt.Contact_ID END = child.Master_Contact_Id
                                                                                                                                                      AND child.Contact_State IN (2, 7, 3)
                                                                                                                                                      AND child.ReskillIndicator = 4
                                                                                                                                                      AND child.Agent_No IS NOT NULL
                                                                                                                                             ORDER BY child.StateIndex ASC) AS t OUTER APPLY (SELECT   TOP 1 sald.Agent_Session_ID
                                                                                                                                                                                              FROM     Staging.Agent_Log_DetailQV AS sald
                                                                                                                                                                                              WHERE    sald.Contact_ID = flt.Contact_ID
                                                                                                                                                                                                       AND sald.Agent_No = ISNULL(scld.Agent_No, cld.Agent_No)
                                                                                                                                                                                                       AND sald.contact_ID IS NOT NULL
                                                                                                                                                                                              ORDER BY sald.StartDate) AS sa OUTER APPLY (SELECT   TOP 1 ald.Agent_Session_ID
                                                                                                                                                                                                                                          FROM     dbo.Agent_Log_DetailQV AS ald WITH (INDEX (FI_Agent_Log_DetailQV_Contact_ID_Agent_No_StartDate_INCLUDE_Agent_Session_ID))
                                                                                                                                                                                                                                          WHERE    CASE WHEN sa.Agent_Session_ID IS NULL THEN flt.Contact_ID END = ald.Contact_ID
                                                                                                                                                                                                                                                   AND CASE WHEN sa.Agent_Session_ID IS NULL THEN ISNULL(scld.Agent_No, cld.Agent_No) END = ald.Agent_No
                                                                                                                                                                                                                                                   AND ald.contact_ID IS NOT NULL
                                                                                                                                                                                                                                          ORDER BY ald.StartDate) AS a OUTER APPLY (SELECT   TOP 1 Disposition_Code
                                                                                                                                                                                                                                                                                    FROM     dbo.Contact_Log_Dispositions
                                                                                                                                                                                                                                                                                    WHERE    Contact_ID = flt.Contact_ID
                                                                                                                                                                                                                                                                                    ORDER BY Start_Date) AS cldisp OUTER APPLY (SELECT   TOP 1 Master_ID,
                                                                                                                                                                                                                                                                                                                                               Action_ID,
                                                                                                                                                                                                                                                                                                                                               Result
                                                                                                                                                                                                                                                                                                                                FROM     dbo.IVRHistory
                                                                                                                                                                                                                                                                                                                                WHERE    Contact_Id = flt.Contact_Id
                                                                                                                                                                                                                                                                                                                                         AND LastTouched &gt;= '2016-10-01 00:00:00.000'
                                                                                                                                                                                                                                                                                                                                ORDER BY CaptureDate DESC, IVRHistoryId DESC) AS h</td>
        <td>45</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">(SELECT   Contact_ID,
          CONVERT (BIT, MAX(IsReprocessed)) AS IsReprocessed
 FROM     (SELECT TOP 10000 Contact_ID,
                            1 AS IsReprocessed
           FROM   DM.ContactLogReprocess
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   Staging.Contact_Log_Header
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   Staging.Contact_Log_DetailQV
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
           UNION ALL
           SELECT Master_Contact_ID AS Contact_ID,
                  0 AS IsReprocessed
           FROM   Staging.Contact_Log_DetailQV
           WHERE  Master_Contact_ID &lt;&gt; Contact_ID
                  AND Contact_State IN (2, 7, 3)
                  AND ReskillIndicator = 4
                  AND Agent_No IS NOT NULL
                  AND RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   Staging.Contact_Log_Footer
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   Staging.Agent_Log_DetailQV AS sald
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
                  AND sald.Contact_ID IS NOT NULL
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   dbo.Contact_Log_Dispositions
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   dbo.IVRHistory
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
                  AND LastTouched &gt;= '2016-10-01 00:00:00.000') AS dst
 GROUP BY Contact_ID) AS flt
LEFT OUTER JOIN
Staging.Contact_Log_Header AS sclh
ON flt.Contact_ID = sclh.Contact_ID
LEFT OUTER JOIN
dbo.Contact_Log_Header AS clh
ON CASE WHEN sclh.Contact_ID IS NULL THEN flt.Contact_ID END = clh.Contact_ID
LEFT OUTER JOIN
Staging.Contact_Log_DetailQV AS scld
ON flt.Contact_ID = scld.Contact_ID
LEFT OUTER JOIN
dbo.Contact_Log_DetailQV AS cld
ON CASE WHEN scld.Contact_ID IS NULL THEN flt.Contact_ID END = cld.Contact_ID
LEFT OUTER JOIN
Staging.Contact_Log_Footer AS sclf
ON flt.Contact_ID = sclf.Contact_ID
LEFT OUTER JOIN
dbo.Contact_Log_Footer AS clf
ON CASE WHEN sclf.Contact_ID IS NULL THEN flt.Contact_ID END = clf.Contact_ID OUTER APPLY (SELECT   TOP 1 child.Contact_ID,
                                                                                                          child.Agent_No,
                                                                                                          child.HeaderStartDate
                                                                                           FROM     staging.Contact_Log_DetailQV AS child
                                                                                           WHERE    child.Master_Contact_Id = flt.Contact_Id
                                                                                                    AND child.Contact_State IN (2, 7, 3)
                                                                                                    AND child.ReskillIndicator = 4
                                                                                                    AND child.Agent_No IS NOT NULL
                                                                                           ORDER BY child.StateIndex ASC) AS st OUTER APPLY (SELECT   TOP 1 child.Contact_ID,
                                                                                                                                                            child.Agent_No,
                                                                                                                                                            child.HeaderStartDate
                                                                                                                                             FROM     dbo.Contact_Log_DetailQV AS child WITH (INDEX (FI_Contact_Log_DetailQV_Master_Contact_ID_INCLUDE_Contact_ID_Agent_No_HeaderStartDate_StateIndex))
                                                                                                                                             WHERE    CASE WHEN st.Contact_ID IS NULL THEN flt.Contact_ID END = child.Master_Contact_Id
                                                                                                                                                      AND child.Contact_State IN (2, 7, 3)
                                                                                                                                                      AND child.ReskillIndicator = 4
                                                                                                                                                      AND child.Agent_No IS NOT NULL
                                                                                                                                             ORDER BY child.StateIndex ASC) AS t OUTER APPLY (SELECT   TOP 1 sald.Agent_Session_ID
                                                                                                                                                                                              FROM     Staging.Agent_Log_DetailQV AS sald
                                                                                                                                                                                              WHERE    sald.Contact_ID = flt.Contact_ID
                                                                                                                                                                                                       AND sald.Agent_No = ISNULL(scld.Agent_No, cld.Agent_No)
                                                                                                                                                                                                       AND sald.contact_ID IS NOT NULL
                                                                                                                                                                                              ORDER BY sald.StartDate) AS sa OUTER APPLY (SELECT   TOP 1 ald.Agent_Session_ID
                                                                                                                                                                                                                                          FROM     dbo.Agent_Log_DetailQV AS ald WITH (INDEX (FI_Agent_Log_DetailQV_Contact_ID_Agent_No_StartDate_INCLUDE_Agent_Session_ID))
                                                                                                                                                                                                                                          WHERE    CASE WHEN sa.Agent_Session_ID IS NULL THEN flt.Contact_ID END = ald.Contact_ID
                                                                                                                                                                                                                                                   AND CASE WHEN sa.Agent_Session_ID IS NULL THEN ISNULL(scld.Agent_No, cld.Agent_No) END = ald.Agent_No
                                                                                                                                                                                                                                                   AND ald.contact_ID IS NOT NULL
                                                                                                                                                                                                                                          ORDER BY ald.StartDate) AS a OUTER APPLY (SELECT   TOP 1 Disposition_Code
                                                                                                                                                                                                                                                                                    FROM     dbo.Contact_Log_Dispositions
                                                                                                                                                                                                                                                                                    WHERE    Contact_ID = flt.Contact_ID
                                                                                                                                                                                                                                                                                    ORDER BY Start_Date) AS cldisp</td>
        <td>45</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">(SELECT   Contact_ID,
          CONVERT (BIT, MAX(IsReprocessed)) AS IsReprocessed
 FROM     (SELECT TOP 10000 Contact_ID,
                            1 AS IsReprocessed
           FROM   DM.ContactLogReprocess
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   Staging.Contact_Log_Header
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   Staging.Contact_Log_DetailQV
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
           UNION ALL
           SELECT Master_Contact_ID AS Contact_ID,
                  0 AS IsReprocessed
           FROM   Staging.Contact_Log_DetailQV
           WHERE  Master_Contact_ID &lt;&gt; Contact_ID
                  AND Contact_State IN (2, 7, 3)
                  AND ReskillIndicator = 4
                  AND Agent_No IS NOT NULL
                  AND RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   Staging.Contact_Log_Footer
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   Staging.Agent_Log_DetailQV AS sald
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
                  AND sald.Contact_ID IS NOT NULL
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   dbo.Contact_Log_Dispositions
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   dbo.IVRHistory
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
                  AND LastTouched &gt;= '2016-10-01 00:00:00.000') AS dst
 GROUP BY Contact_ID) AS flt
LEFT OUTER JOIN
Staging.Contact_Log_Header AS sclh
ON flt.Contact_ID = sclh.Contact_ID
LEFT OUTER JOIN
dbo.Contact_Log_Header AS clh
ON CASE WHEN sclh.Contact_ID IS NULL THEN flt.Contact_ID END = clh.Contact_ID
LEFT OUTER JOIN
Staging.Contact_Log_DetailQV AS scld
ON flt.Contact_ID = scld.Contact_ID
LEFT OUTER JOIN
dbo.Contact_Log_DetailQV AS cld
ON CASE WHEN scld.Contact_ID IS NULL THEN flt.Contact_ID END = cld.Contact_ID
LEFT OUTER JOIN
Staging.Contact_Log_Footer AS sclf
ON flt.Contact_ID = sclf.Contact_ID
LEFT OUTER JOIN
dbo.Contact_Log_Footer AS clf
ON CASE WHEN sclf.Contact_ID IS NULL THEN flt.Contact_ID END = clf.Contact_ID OUTER APPLY (SELECT   TOP 1 child.Contact_ID,
                                                                                                          child.Agent_No,
                                                                                                          child.HeaderStartDate
                                                                                           FROM     staging.Contact_Log_DetailQV AS child
                                                                                           WHERE    child.Master_Contact_Id = flt.Contact_Id
                                                                                                    AND child.Contact_State IN (2, 7, 3)
                                                                                                    AND child.ReskillIndicator = 4
                                                                                                    AND child.Agent_No IS NOT NULL
                                                                                           ORDER BY child.StateIndex ASC) AS st OUTER APPLY (SELECT   TOP 1 child.Contact_ID,
                                                                                                                                                            child.Agent_No,
                                                                                                                                                            child.HeaderStartDate
                                                                                                                                             FROM     dbo.Contact_Log_DetailQV AS child WITH (INDEX (FI_Contact_Log_DetailQV_Master_Contact_ID_INCLUDE_Contact_ID_Agent_No_HeaderStartDate_StateIndex))
                                                                                                                                             WHERE    CASE WHEN st.Contact_ID IS NULL THEN flt.Contact_ID END = child.Master_Contact_Id
                                                                                                                                                      AND child.Contact_State IN (2, 7, 3)
                                                                                                                                                      AND child.ReskillIndicator = 4
                                                                                                                                                      AND child.Agent_No IS NOT NULL
                                                                                                                                             ORDER BY child.StateIndex ASC) AS t OUTER APPLY (SELECT   TOP 1 sald.Agent_Session_ID
                                                                                                                                                                                              FROM     Staging.Agent_Log_DetailQV AS sald
                                                                                                                                                                                              WHERE    sald.Contact_ID = flt.Contact_ID
                                                                                                                                                                                                       AND sald.Agent_No = ISNULL(scld.Agent_No, cld.Agent_No)
                                                                                                                                                                                                       AND sald.contact_ID IS NOT NULL
                                                                                                                                                                                              ORDER BY sald.StartDate) AS sa OUTER APPLY (SELECT   TOP 1 ald.Agent_Session_ID
                                                                                                                                                                                                                                          FROM     dbo.Agent_Log_DetailQV AS ald WITH (INDEX (FI_Agent_Log_DetailQV_Contact_ID_Agent_No_StartDate_INCLUDE_Agent_Session_ID))
                                                                                                                                                                                                                                          WHERE    CASE WHEN sa.Agent_Session_ID IS NULL THEN flt.Contact_ID END = ald.Contact_ID
                                                                                                                                                                                                                                                   AND CASE WHEN sa.Agent_Session_ID IS NULL THEN ISNULL(scld.Agent_No, cld.Agent_No) END = ald.Agent_No
                                                                                                                                                                                                                                                   AND ald.contact_ID IS NOT NULL
                                                                                                                                                                                                                                          ORDER BY ald.StartDate) AS a</td>
        <td>45</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">(SELECT   Contact_ID,
          CONVERT (BIT, MAX(IsReprocessed)) AS IsReprocessed
 FROM     (SELECT TOP 10000 Contact_ID,
                            1 AS IsReprocessed
           FROM   DM.ContactLogReprocess
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   Staging.Contact_Log_Header
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   Staging.Contact_Log_DetailQV
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
           UNION ALL
           SELECT Master_Contact_ID AS Contact_ID,
                  0 AS IsReprocessed
           FROM   Staging.Contact_Log_DetailQV
           WHERE  Master_Contact_ID &lt;&gt; Contact_ID
                  AND Contact_State IN (2, 7, 3)
                  AND ReskillIndicator = 4
                  AND Agent_No IS NOT NULL
                  AND RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   Staging.Contact_Log_Footer
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   Staging.Agent_Log_DetailQV AS sald
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
                  AND sald.Contact_ID IS NOT NULL
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   dbo.Contact_Log_Dispositions
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   dbo.IVRHistory
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
                  AND LastTouched &gt;= '2016-10-01 00:00:00.000') AS dst
 GROUP BY Contact_ID) AS flt
LEFT OUTER JOIN
Staging.Contact_Log_Header AS sclh
ON flt.Contact_ID = sclh.Contact_ID
LEFT OUTER JOIN
dbo.Contact_Log_Header AS clh
ON CASE WHEN sclh.Contact_ID IS NULL THEN flt.Contact_ID END = clh.Contact_ID
LEFT OUTER JOIN
Staging.Contact_Log_DetailQV AS scld
ON flt.Contact_ID = scld.Contact_ID
LEFT OUTER JOIN
dbo.Contact_Log_DetailQV AS cld
ON CASE WHEN scld.Contact_ID IS NULL THEN flt.Contact_ID END = cld.Contact_ID
LEFT OUTER JOIN
Staging.Contact_Log_Footer AS sclf
ON flt.Contact_ID = sclf.Contact_ID
LEFT OUTER JOIN
dbo.Contact_Log_Footer AS clf
ON CASE WHEN sclf.Contact_ID IS NULL THEN flt.Contact_ID END = clf.Contact_ID OUTER APPLY (SELECT   TOP 1 child.Contact_ID,
                                                                                                          child.Agent_No,
                                                                                                          child.HeaderStartDate
                                                                                           FROM     staging.Contact_Log_DetailQV AS child
                                                                                           WHERE    child.Master_Contact_Id = flt.Contact_Id
                                                                                                    AND child.Contact_State IN (2, 7, 3)
                                                                                                    AND child.ReskillIndicator = 4
                                                                                                    AND child.Agent_No IS NOT NULL
                                                                                           ORDER BY child.StateIndex ASC) AS st OUTER APPLY (SELECT   TOP 1 child.Contact_ID,
                                                                                                                                                            child.Agent_No,
                                                                                                                                                            child.HeaderStartDate
                                                                                                                                             FROM     dbo.Contact_Log_DetailQV AS child WITH (INDEX (FI_Contact_Log_DetailQV_Master_Contact_ID_INCLUDE_Contact_ID_Agent_No_HeaderStartDate_StateIndex))
                                                                                                                                             WHERE    CASE WHEN st.Contact_ID IS NULL THEN flt.Contact_ID END = child.Master_Contact_Id
                                                                                                                                                      AND child.Contact_State IN (2, 7, 3)
                                                                                                                                                      AND child.ReskillIndicator = 4
                                                                                                                                                      AND child.Agent_No IS NOT NULL
                                                                                                                                             ORDER BY child.StateIndex ASC) AS t OUTER APPLY (SELECT   TOP 1 sald.Agent_Session_ID
                                                                                                                                                                                              FROM     Staging.Agent_Log_DetailQV AS sald
                                                                                                                                                                                              WHERE    sald.Contact_ID = flt.Contact_ID
                                                                                                                                                                                                       AND sald.Agent_No = ISNULL(scld.Agent_No, cld.Agent_No)
                                                                                                                                                                                                       AND sald.contact_ID IS NOT NULL
                                                                                                                                                                                              ORDER BY sald.StartDate) AS sa</td>
        <td>45</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">(SELECT   Contact_ID,
          CONVERT (BIT, MAX(IsReprocessed)) AS IsReprocessed
 FROM     (SELECT TOP 10000 Contact_ID,
                            1 AS IsReprocessed
           FROM   DM.ContactLogReprocess
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   Staging.Contact_Log_Header
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   Staging.Contact_Log_DetailQV
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
           UNION ALL
           SELECT Master_Contact_ID AS Contact_ID,
                  0 AS IsReprocessed
           FROM   Staging.Contact_Log_DetailQV
           WHERE  Master_Contact_ID &lt;&gt; Contact_ID
                  AND Contact_State IN (2, 7, 3)
                  AND ReskillIndicator = 4
                  AND Agent_No IS NOT NULL
                  AND RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   Staging.Contact_Log_Footer
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   Staging.Agent_Log_DetailQV AS sald
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
                  AND sald.Contact_ID IS NOT NULL
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   dbo.Contact_Log_Dispositions
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   dbo.IVRHistory
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
                  AND LastTouched &gt;= '2016-10-01 00:00:00.000') AS dst
 GROUP BY Contact_ID) AS flt
LEFT OUTER JOIN
Staging.Contact_Log_Header AS sclh
ON flt.Contact_ID = sclh.Contact_ID
LEFT OUTER JOIN
dbo.Contact_Log_Header AS clh
ON CASE WHEN sclh.Contact_ID IS NULL THEN flt.Contact_ID END = clh.Contact_ID
LEFT OUTER JOIN
Staging.Contact_Log_DetailQV AS scld
ON flt.Contact_ID = scld.Contact_ID
LEFT OUTER JOIN
dbo.Contact_Log_DetailQV AS cld
ON CASE WHEN scld.Contact_ID IS NULL THEN flt.Contact_ID END = cld.Contact_ID
LEFT OUTER JOIN
Staging.Contact_Log_Footer AS sclf
ON flt.Contact_ID = sclf.Contact_ID
LEFT OUTER JOIN
dbo.Contact_Log_Footer AS clf
ON CASE WHEN sclf.Contact_ID IS NULL THEN flt.Contact_ID END = clf.Contact_ID OUTER APPLY (SELECT   TOP 1 child.Contact_ID,
                                                                                                          child.Agent_No,
                                                                                                          child.HeaderStartDate
                                                                                           FROM     staging.Contact_Log_DetailQV AS child
                                                                                           WHERE    child.Master_Contact_Id = flt.Contact_Id
                                                                                                    AND child.Contact_State IN (2, 7, 3)
                                                                                                    AND child.ReskillIndicator = 4
                                                                                                    AND child.Agent_No IS NOT NULL
                                                                                           ORDER BY child.StateIndex ASC) AS st OUTER APPLY (SELECT   TOP 1 child.Contact_ID,
                                                                                                                                                            child.Agent_No,
                                                                                                                                                            child.HeaderStartDate
                                                                                                                                             FROM     dbo.Contact_Log_DetailQV AS child WITH (INDEX (FI_Contact_Log_DetailQV_Master_Contact_ID_INCLUDE_Contact_ID_Agent_No_HeaderStartDate_StateIndex))
                                                                                                                                             WHERE    CASE WHEN st.Contact_ID IS NULL THEN flt.Contact_ID END = child.Master_Contact_Id
                                                                                                                                                      AND child.Contact_State IN (2, 7, 3)
                                                                                                                                                      AND child.ReskillIndicator = 4
                                                                                                                                                      AND child.Agent_No IS NOT NULL
                                                                                                                                             ORDER BY child.StateIndex ASC) AS t</td>
        <td>45</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">(SELECT   Contact_ID,
          CONVERT (BIT, MAX(IsReprocessed)) AS IsReprocessed
 FROM     (SELECT TOP 10000 Contact_ID,
                            1 AS IsReprocessed
           FROM   DM.ContactLogReprocess
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   Staging.Contact_Log_Header
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   Staging.Contact_Log_DetailQV
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
           UNION ALL
           SELECT Master_Contact_ID AS Contact_ID,
                  0 AS IsReprocessed
           FROM   Staging.Contact_Log_DetailQV
           WHERE  Master_Contact_ID &lt;&gt; Contact_ID
                  AND Contact_State IN (2, 7, 3)
                  AND ReskillIndicator = 4
                  AND Agent_No IS NOT NULL
                  AND RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   Staging.Contact_Log_Footer
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   Staging.Agent_Log_DetailQV AS sald
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
                  AND sald.Contact_ID IS NOT NULL
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   dbo.Contact_Log_Dispositions
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
           UNION ALL
           SELECT Contact_ID,
                  0 AS IsReprocessed
           FROM   dbo.IVRHistory
           WHERE  RowVersion &gt; CONVERT (ROWVERSION, @RowVersionFrom)
                  AND RowVersion &lt;= CONVERT (ROWVERSION, @RowVersionTo)
                  AND LastTouched &gt;= '2016-10-01 00:00:00.000') AS dst
 GROUP BY Contact_ID) AS flt
LEFT OUTER JOIN
Staging.Contact_Log_Header AS sclh
ON flt.Contact_ID = sclh.Contact_ID
LEFT OUTER JOIN
dbo.Contact_Log_Header AS clh
ON CASE WHEN sclh.Contact_ID IS NULL THEN flt.Contact_ID END = clh.Contact_ID
LEFT OUTER JOIN
Staging.Contact_Log_DetailQV AS scld
ON flt.Contact_ID = scld.Contact_ID
LEFT OUTER JOIN
dbo.Contact_Log_DetailQV AS cld
ON CASE WHEN scld.Contact_ID IS NULL THEN flt.Contact_ID END = cld.Contact_ID
LEFT OUTER JOIN
Staging.Contact_Log_Footer AS sclf
ON flt.Contact_ID = sclf.Contact_ID
LEFT OUTER JOIN
dbo.Contact_Log_Footer AS clf
ON CASE WHEN sclf.Contact_ID IS NULL THEN flt.Contact_ID END = clf.Contact_ID OUTER APPLY (SELECT   TOP 1 child.Contact_ID,
                                                                                                          child.Agent_No,
                                                                                                          child.HeaderStartDate
                                                                                           FROM     staging.Contact_Log_DetailQV AS child
                                                                                           WHERE    child.Master_Contact_Id = flt.Contact_Id
                                                                                                    AND child.Contact_State IN (2, 7, 3)
                                                                                                    AND child.ReskillIndicator = 4
                                                                                                    AND child.Agent_No IS NOT NULL
                                                                                           ORDER BY child.StateIndex ASC) AS st</td>
        <td>45</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">CASE</td>
        <td colspan="1">CASE WHEN sclh.Contact_ID IS NULL THEN flt.Contact_ID END</td>
        <td>140</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN scld.Contact_ID IS NULL THEN flt.Contact_ID END</td>
        <td>146</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN sclf.Contact_ID IS NULL THEN flt.Contact_ID END</td>
        <td>152</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN st.Contact_ID IS NULL THEN flt.Contact_ID END</td>
        <td>166</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN sa.Agent_Session_ID IS NULL THEN flt.Contact_ID END</td>
        <td>186</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN sa.Agent_Session_ID IS NULL THEN ISNULL(scld.Agent_No, cld.Agent_No) END</td>
        <td>187</td>
      </tr>
    </table>
  </body>
</html>