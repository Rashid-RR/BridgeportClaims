<?xml version="1.0" encoding="utf-8"?>
<html>
  <head>
    <title>Native Compilation Advisor evaluation results for [DWCode].[IC_Reports_EmailInterruptions]</title>
  </head>
  <body>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 14pt;">
      <b>Native Compilation Advisor evaluation results for [DWCode].[IC_Reports_EmailInterruptions]</b>
    </p>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 10pt;">
      <b>Report Date/Time:</b>1/1/2018 5:10 PM<br /></p>
    <table border="1" cellpadding="5" cellspacing="0" STYLE="font-family: Verdana, Arial, sans-serif; font-size: 9pt;">
      <tr style="background-color:Silver">
        <th colspan="1" align="center">Transact-SQL Element</th>
        <th align="center">Transact-SQL Code</th>
        <th align="center">Line Number</th>
      </tr>
      <tr valign="top">
        <td colspan="1">SET OPTION ON</td>
        <td colspan="1">SET NOCOUNT ON</td>
        <td>2</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">SELECT INTO</td>
        <td colspan="1">SELECT s.Skill_No,
       s.Skill_Name,
       s.campaign_no
INTO   #AccessibleSkillList
FROM   dbo.Skills AS s
       INNER JOIN
       dbo.fn_GetDataRoleFilterItems(@profileID, 'campaigns') AS v
       ON v.intValue = s.Campaign_no
          OR v.intValue = 0
       INNER JOIN
       dbo.fn_Split(@SkillNoList, ',') AS sl
       ON ISNULL(sl.value, s.Skill_No) = s.Skill_No
       INNER JOIN
       dbo.fn_Split(@CampaignNoList, ',') AS cl
       ON ISNULL(cl.value, s.Campaign_No) = s.Campaign_no
WHERE  s.bus_no = @busno</td>
        <td>37</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">SELECT   t.Contact_ID,
         t.Primary_ID,
         t.Name,
         ISNULL(dt1.InterruptedCount, 0) AS InterruptedCount,
         ISNULL(dt1.InterruptedDuration, 0) AS InterruptedDuration,
         ISNULL(dt2.HandleTime, 0) AS HandleTime,
         CASE WHEN dt3.Media_type = 4 THEN ISNULL(dt3.InterruptedCount, 0) ELSE 0 END AS CallsInterrupted,
         CASE WHEN dt3.Media_type = 3 THEN ISNULL(dt3.InterruptedCount, 0) ELSE 0 END AS ChatsInterrupted
INTO     #ContactsToQuery_Both
FROM     #MainData AS t
         LEFT OUTER JOIN
         (SELECT   qv.Contact_ID,
                   COUNT(qv.Contact_ID) AS InterruptedCount,
                   ISNULL(SUM(qv.duration), 0) AS InterruptedDuration
          FROM     dbo.Contact_Log_DetailQV AS qv
          WHERE    qv.Bus_No = @BusNo
                   AND qv.StartDate BETWEEN @StartDate AND @EndDate
                   AND qv.contact_state = 12
          GROUP BY qv.Contact_ID) AS dt1
         ON dt1.Contact_ID = t.Contact_ID
         LEFT OUTER JOIN
         (SELECT   qv.Contact_ID,
                   SUM(ISNULL(qv.Duration, 0)) AS HandleTime
          FROM     dbo.Agent_Log_DetailQV AS qv
                   INNER JOIN
                   dbo.Outstates AS o
                   ON o.outstate_code = qv.Outstate_Code
          WHERE    qv.Bus_No = @BusNo
                   AND qv.StartDate BETWEEN @StartDate AND @EndDate
                   AND qv.AgentStateId = 2
                   AND o.outstate_code &gt; 0
                   AND o.IsACW = 'T'
          GROUP BY qv.Contact_ID) AS dt2
         ON dt2.Contact_ID = t.Contact_ID
         LEFT OUTER JOIN
         (SELECT   cel.Contact_ID,
                   t.Media_Type,
                   COUNT(cel.Contact_ID) AS InterruptedCount
          FROM     dbo.ContactEventLog AS cel
                   INNER JOIN
                   #MainData AS t
                   ON t.Contact_ID = cel.Contact_ID
          WHERE    cel.ContactEventId = 2
                   AND t.Media_Type IN (3, 4)
          GROUP BY cel.Contact_ID, t.Media_Type) AS dt3
         ON dt3.Contact_ID = t.Contact_ID
ORDER BY t.Contact_ID</td>
        <td>99</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">SELECT   a.Primary_ID,
         a.Name,
         COUNT(a.Contact_ID) AS Emails_Handled,
         COUNT(ni.Contact_ID) AS Emails_Not_Interrupted,
         COUNT(i.Contact_ID) AS Emails_Interrupted,
         SUM(a.InterruptedCount) AS Total_No_Interruptions,
         SUM(a.InterruptedDuration) AS Interrupted_Time,
         SUM(i.HandleTime) AS Handle_Time_Interrupted,
         SUM(ni.HandleTime) AS Handle_Time_Not_Interrupted,
         SUM(a.CallsInterrupted) AS Calls_Interrupting,
         SUM(a.ChatsInterrupted) AS Chats_Interrupting
INTO     #ContactsToQuery_PreCalc_Both
FROM     #ContactsToQuery_Both AS a
         LEFT OUTER JOIN
         #ContactsToQuery_Both AS i
         ON a.Contact_ID = i.Contact_ID
            AND i.InterruptedCount &gt; 0
         LEFT OUTER JOIN
         #ContactsToQuery_Both AS ni
         ON a.contact_id = ni.contact_id
            AND ni.InterruptedCount = 0
GROUP BY a.Primary_ID, a.Name</td>
        <td>145</td>
      </tr>
      <tr valign="top">
        <td colspan="1">Table-valued functions</td>
        <td colspan="1">dbo.fn_GetDataRoleFilterItems(@profileID, 'campaigns') AS v</td>
        <td>42</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">dbo.fn_Split(@SkillNoList, ',') AS sl</td>
        <td>44</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">dbo.fn_Split(@CampaignNoList, ',') AS cl</td>
        <td>45</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">dbo.fn_Split(@AgentNoList, ',') AS al</td>
        <td>68</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">dbo.fn_Split(@TeamNoList, ',') AS tl</td>
        <td>69</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">dbo.fn_GetDataRoleFilterItems(@profileID, 'teams') AS v</td>
        <td>88</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">dbo.fn_Split(@AgentNoList, ',') AS al</td>
        <td>90</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">dbo.fn_Split(@TeamNoList, ',') AS tl</td>
        <td>91</td>
      </tr>
      <tr valign="top">
        <td colspan="1">One-part names</td>
        <td colspan="1">#MainData</td>
        <td>58</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#AccessibleSkillList AS sl</td>
        <td>66</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#MainData</td>
        <td>78</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#AccessibleSkillList AS sl</td>
        <td>86</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#MainData AS t</td>
        <td>108</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#MainData AS t</td>
        <td>137</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#ContactsToQuery_Both AS a</td>
        <td>157</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#ContactsToQuery_Both AS i</td>
        <td>158</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#ContactsToQuery_Both AS ni</td>
        <td>160</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#ContactsToQuery_PreCalc_Both AS a</td>
        <td>184</td>
      </tr>
      <tr valign="top">
        <td colspan="1">CASE</td>
        <td colspan="1">CASE WHEN dt3.Media_type = 4 THEN ISNULL(dt3.InterruptedCount, 0) ELSE 0 END</td>
        <td>105</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN dt3.Media_type = 3 THEN ISNULL(dt3.InterruptedCount, 0) ELSE 0 END</td>
        <td>106</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN Total_No_Interruptions &gt; 0 THEN Calls_Interrupting * 1.0 / Total_No_Interruptions ELSE 0 END</td>
        <td>175</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN Total_No_interruptions &gt; 0 THEN Chats_Interrupting * 1.0 / Total_No_Interruptions ELSE 0 END</td>
        <td>177</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN Emails_Interrupted &gt; 0 THEN Interrupted_Time * 1.0 / Emails_Interrupted ELSE 0 END</td>
        <td>179</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN Emails_Interrupted &gt; 0 THEN Handle_Time_Interrupted * 1.0 / Emails_Interrupted ELSE 0 END</td>
        <td>181</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN Emails_Not_Interrupted &gt; 0 THEN handle_time_not_interrupted * 1.0 / emails_not_interrupted ELSE 0 END</td>
        <td>183</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">nvarchar(MAX)</td>
        <td colspan="1">NVARCHAR (MAX)</td>
        <td>167</td>
      </tr>
    </table>
  </body>
</html>