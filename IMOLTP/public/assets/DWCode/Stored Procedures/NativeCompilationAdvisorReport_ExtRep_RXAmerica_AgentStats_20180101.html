<?xml version="1.0" encoding="utf-8"?>
<html>
  <head>
    <title>Native Compilation Advisor evaluation results for [DWCode].[ExtRep_RXAmerica_AgentStats]</title>
  </head>
  <body>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 14pt;">
      <b>Native Compilation Advisor evaluation results for [DWCode].[ExtRep_RXAmerica_AgentStats]</b>
    </p>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 10pt;">
      <b>Report Date/Time:</b>1/1/2018 5:10 PM<br /></p>
    <table border="1" cellpadding="5" cellspacing="0" STYLE="font-family: Verdana, Arial, sans-serif; font-size: 9pt;">
      <tr style="background-color:Silver">
        <th colspan="1" align="center">Transact-SQL Element</th>
        <th align="center">Transact-SQL Code</th>
        <th align="center">Line Number</th>
      </tr>
      <tr valign="top">
        <td colspan="1">SET OPTION ON</td>
        <td colspan="1">SET NOCOUNT ON</td>
        <td>3</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">SELECT INTO</td>
        <td colspan="1">SELECT l.Contact_Id,
       l.Master_Contact_Id,
       l.Bus_no,
       l.Contact_Code,
       r.Skill_No,
       r.Campaign_no,
       r.Agent_No,
       r.Team_No,
       l.start_date,
       l.QtrHour_Code,
       l.HalfHour_Code,
       s.sla,
       s.PreQueue_time,
       s.InQueue_time,
       s.Agent_time,
       s.PostQueue_time,
       s.Abandon_time,
       r.Abandon,
       r.To_addr,
       r.From_addr,
       s.Total_Time,
       r.End_Date,
       s.Hold_time,
       s.Release_Time
INTO   #Contact_Log
FROM   dbo.Contact_Log_Header AS l
       LEFT OUTER JOIN
       dbo.Contact_Log_Footer AS r
       ON r.Contact_ID = l.Contact_ID
       LEFT OUTER JOIN
       dbo.Contact_Log_Summary AS s
       ON s.Contact_ID = l.Contact_ID
WHERE  l.bus_no = @Bus_No
       AND l.start_date BETWEEN @start_date AND @end_date
       AND r.[agent_no] IN (SELECT [Agent_No]
                            FROM   [#AgentInfo])</td>
        <td>11</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">SELECT h.Agent_Session_ID,
       d.StateIndex,
       h.agent_no,
       h.team_no,
       h.bus_no,
       d.start_date,
       d.working,
       d.available,
       d.outstate_code,
       s.duration,
       d.log_state,
       d.skill_no,
       (CASE WHEN d.working IN (1, 2, 3, 4) THEN d.working WHEN d.working = 0 THEN (CASE WHEN d.available = 1 THEN d.working WHEN (d.outstate_code &gt; -1)
                                                                                                                                  AND (d.outstate_code &lt; 10) THEN 3 ELSE d.outstate_code END) END) AS State_Code
INTO   #Agent_Log
FROM   dbo.Agent_Log_Header AS h
       LEFT OUTER JOIN
       dbo.Agent_Log_Detail AS d
       ON d.Agent_Session_ID = h.Agent_Session_ID
       LEFT OUTER JOIN
       dbo.Agent_Log_Detail_Summary AS s
       ON s.Agent_Session_ID = d.Agent_Session_ID
          AND s.StateIndex = d.StateIndex
WHERE  h.bus_no = @Bus_No
       AND h.start_date BETWEEN @start_date AND @end_date
       AND h.[agent_no] IN (SELECT [Agent_No]
                            FROM   [#AgentInfo])</td>
        <td>44</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">SELECT outstate_code AS state_code,
       description
INTO   #dw_AgentState
FROM   dbo.outstates
WHERE  bus_no = @bus_no
UNION
SELECT 0,
       'Available'
UNION
SELECT 1,
       'ACD'
UNION
SELECT 2,
       'Outbound'
UNION
SELECT 3,
       'Unavailable'
UNION
SELECT -1,
       'Refused Contact'
UNION
SELECT -2,
       'Held Party Abandon'</td>
        <td>73</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">SELECT [Agent_No],
       a.[first_name] + ' ' + a.[last_name] AS Agent_Name
INTO   [#AgentInfo]
FROM   dbo.[Agents] AS a
       INNER JOIN
       dbo.[Team] AS t
       ON a.[team_no] = t.[team_no]
WHERE  t.[Bus_no] = @Bus_No
       AND (@team LIKE '%,' + CONVERT (NVARCHAR, t.[team_no]) + ',%'
            OR @team IS NULL)
       AND (@agent LIKE '%,' + CONVERT (NVARCHAR, a.[agent_no]) + ',%'
            OR @agent IS NULL)</td>
        <td>91</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">SELECT   cl.[agent_no],
         SUM(CASE WHEN s.Outbound_skill = 0 THEN 1 ELSE 0 END) AS ACD_Contacts,
         SUM(CASE WHEN s.Outbound_skill = 1 THEN 1 ELSE 0 END) AS Outbound_Contacts
INTO     [#AgentContacts]
FROM     #Contact_Log AS cl
         INNER JOIN
         [Skills] AS s
         ON cl.[skill_no] = s.[skill_no]
GROUP BY cl.[agent_no]</td>
        <td>106</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">SELECT   a.[agent_no],
         SUM(CASE WHEN a.[available] = 1
                       AND a.[Working] = 0 THEN (a.[duration] / 1000) ELSE 0 END) AS Avail_Time,
         SUM(CASE s.[Outbound_Skill] WHEN 0 THEN (a.[duration] / 1000) ELSE 0 END) AS ACD_Time,
         SUM(CASE s.[Outbound_Skill] WHEN 1 THEN (a.[duration] / 1000) ELSE 0 END) AS OB_Time
INTO     [#AgentTime]
FROM     #Agent_Log AS a
         LEFT OUTER JOIN
         [Skills] AS s
         ON a.[skill_no] = s.[skill_no]
GROUP BY a.[agent_no]</td>
        <td>118</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">SELECT   b.[agent_no],
         s.[description] AS UnavailableName,
         SUM(b.[duration]) AS UnavailableTime
INTO     [#AgentStates]
FROM     [dbo].[fn_dw_agent_byDay](@TimeZone, @start_date, @end_date, @Bus_No, NULL) AS b
         INNER JOIN
         #dw_AgentState AS s
         ON b.[agent_state_code] = s.[state_code]
WHERE    ((s.[state_code] = 3)
          OR (s.[state_code] &gt; 9))
         AND b.[agent_no] IN (SELECT [Agent_No]
                              FROM   [#AgentInfo])
GROUP BY b.[agent_no], s.[description]
ORDER BY b.[agent_no], s.[description]</td>
        <td>137</td>
      </tr>
      <tr valign="top">
        <td colspan="1">One-part names</td>
        <td colspan="1">[#AgentInfo]</td>
        <td>42</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">[#AgentInfo]</td>
        <td>71</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#Contact_Log AS cl</td>
        <td>114</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">[Skills] AS s</td>
        <td>115</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#Agent_Log AS a</td>
        <td>133</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">[Skills] AS s</td>
        <td>134</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#dw_AgentState AS s</td>
        <td>144</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">[#AgentInfo]</td>
        <td>148</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#AgentInfo AS i</td>
        <td>163</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#AgentStates AS s</td>
        <td>164</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#AgentContacts AS c</td>
        <td>165</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#AgentTime AS t</td>
        <td>166</td>
      </tr>
      <tr valign="top">
        <td colspan="1">CASE</td>
        <td colspan="1">CASE WHEN d.working IN (1, 2, 3, 4) THEN d.working WHEN d.working = 0 THEN (CASE WHEN d.available = 1 THEN d.working WHEN (d.outstate_code &gt; -1)
                                                                                                                          AND (d.outstate_code &lt; 10) THEN 3 ELSE d.outstate_code END) END</td>
        <td>56</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN d.available = 1 THEN d.working WHEN (d.outstate_code &gt; -1)
                                              AND (d.outstate_code &lt; 10) THEN 3 ELSE d.outstate_code END</td>
        <td>57</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN s.Outbound_skill = 0 THEN 1 ELSE 0 END</td>
        <td>107</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN s.Outbound_skill = 1 THEN 1 ELSE 0 END</td>
        <td>110</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN a.[available] = 1
          AND a.[Working] = 0 THEN (a.[duration] / 1000) ELSE 0 END</td>
        <td>119</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE s.[Outbound_Skill] WHEN 0 THEN (a.[duration] / 1000) ELSE 0 END</td>
        <td>124</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE s.[Outbound_Skill] WHEN 1 THEN (a.[duration] / 1000) ELSE 0 END</td>
        <td>128</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">LIKE</td>
        <td colspan="1">@team LIKE '%,' + CONVERT (NVARCHAR, t.[team_no]) + ',%'</td>
        <td>98</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">@agent LIKE '%,' + CONVERT (NVARCHAR, a.[agent_no]) + ',%'</td>
        <td>102</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">Table-valued functions</td>
        <td colspan="1">[dbo].[fn_dw_agent_byDay](@TimeZone, @start_date, @end_date, @Bus_No, NULL) AS b</td>
        <td>142</td>
      </tr>
      <tr valign="top">
        <td colspan="1">MAXDOP</td>
        <td colspan="1">MAXDOP 2</td>
        <td>169</td>
      </tr>
    </table>
  </body>
</html>