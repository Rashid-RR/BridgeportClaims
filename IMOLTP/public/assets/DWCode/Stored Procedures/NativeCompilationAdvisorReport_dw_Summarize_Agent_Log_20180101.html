<?xml version="1.0" encoding="utf-8"?>
<html>
  <head>
    <title>Native Compilation Advisor evaluation results for [DWCode].[dw_Summarize_Agent_Log]</title>
  </head>
  <body>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 14pt;">
      <b>Native Compilation Advisor evaluation results for [DWCode].[dw_Summarize_Agent_Log]</b>
    </p>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 10pt;">
      <b>Report Date/Time:</b>1/1/2018 5:09 PM<br /></p>
    <table border="1" cellpadding="5" cellspacing="0" STYLE="font-family: Verdana, Arial, sans-serif; font-size: 9pt;">
      <tr style="background-color:Silver">
        <th colspan="1" align="center">Transact-SQL Element</th>
        <th align="center">Transact-SQL Code</th>
        <th align="center">Line Number</th>
      </tr>
      <tr valign="top">
        <td colspan="1">SET OPTION ON</td>
        <td colspan="1">SET NOCOUNT ON</td>
        <td>1</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">SET XACT_ABORT ON</td>
        <td>2</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">SET FORCEPLAN ON</td>
        <td>98</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">OBJECT_ID</td>
        <td colspan="1">object_ID('tempdb..#ALD')</td>
        <td>6</td>
      </tr>
      <tr valign="top">
        <td colspan="1">SELECT INTO</td>
        <td colspan="1">SELECT ald.agent_Session_ID,
       ald.stateindex,
       ald.start_date,
       ald.outstate_code,
       ald.working,
       available,
       contact_ID
INTO   #ALD
FROM   Agent_Log_Detail AS ald
       INNER JOIN
       (SELECT DISTINCT Agent_Session_ID
        FROM   dw_agentsdetail_to_summarize
        WHERE  lasttouched &gt;= dateadd(day, -5, getutcdate())) AS d
       ON ald.Agent_Session_ID = d.Agent_Session_ID</td>
        <td>10</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">SELECT h.agent_no AS Agent_no,
       h.team_no AS Team_No,
       dw.Agent_Session_ID AS Agent_Session_ID,
       dw.StateIndex AS StateIndex,
       h.start_date AS start_date,
       dw.Contact_ID AS Contact_ID,
       h.bus_no AS bus_no
INTO   #tmpAgentDetailToSummarize
FROM   dbo.dw_agentsdetail_to_summarize AS dw
       INNER JOIN
       dbo.Agent_Log_Header AS h
       ON h.Agent_Session_ID = dw.Agent_Session_ID
       LEFT OUTER JOIN
       #ALD AS n
       ON n.Agent_Session_ID = dw.Agent_Session_ID
          AND n.StateIndex = dw.StateIndex + 1
WHERE  (n.Agent_Session_ID IS NOT NULL
        OR dw.Log_State = 2)</td>
        <td>21</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">SELECT dw.Agent_Session_ID AS Agent_Session_ID,
       dw.StateIndexCount AS StateIndexCount,
       h.start_date AS start_date,
       h.bus_no AS bus_no
INTO   #tmpAgentsToSummarize
FROM   dbo.dw_agents_to_summarize AS dw
       INNER JOIN
       dbo.Agent_Log_Header AS h
       ON h.Agent_Session_ID = dw.Agent_Session_ID
WHERE  ISNULL((SELECT COUNT(*)
               FROM   #ALD AS d
               WHERE  d.Agent_Session_ID = dw.Agent_Session_ID), 0) &gt;= dw.StateIndexCount
       OR (dw.Agent_Session_ID NOT IN (SELECT Agent_Session_ID
                                       FROM   Agent_Log_Summary
                                       WHERE  Agent_Session_ID = dw.Agent_Session_ID)
           AND dw.FailoverCount &gt; 0
           AND dw.lastTouched &lt; DATEADD(dd, -2, GETUTCDATE()))</td>
        <td>40</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">SELECT   t.Contact_ID,
         SUM(d.Duration) AS ACW_Time,
         MAX(t.bus_no) AS bus_no,
         MAX(t.start_date) AS Header_Start_Date
INTO     #tmpACW
FROM     #tmpAgentDetailToSummarize AS t
         INNER JOIN
         dbo.Agent_Log_Detail_Summary AS d
         ON d.Agent_Session_ID = t.Agent_Session_ID
            AND d.StateIndex = t.StateIndex
            AND d.Header_start_Date = t.Start_Date
WHERE    t.contact_id IS NOT NULL
         AND d.isACW = 'T'
GROUP BY t.Contact_ID</td>
        <td>140</td>
      </tr>
      <tr valign="top">
        <td colspan="1">One-part names</td>
        <td colspan="1">Agent_Log_Detail AS ald</td>
        <td>12</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">dw_agentsdetail_to_summarize</td>
        <td>13</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#ALD AS n</td>
        <td>31</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#ALD AS d</td>
        <td>48</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">Agent_Log_Summary</td>
        <td>51</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">s</td>
        <td>58</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#tmpAgentDetailToSummarize AS t</td>
        <td>59</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">s</td>
        <td>64</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#tmpAgentsToSummarize AS t</td>
        <td>65</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#tmpAgentsToSummarize AS t</td>
        <td>93</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#ALD AS d</td>
        <td>94</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#tmpAgentDetailToSummarize AS t</td>
        <td>126</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#ALD AS d</td>
        <td>127</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#ALD AS n</td>
        <td>129</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#tmpAgentDetailToSummarize AS t</td>
        <td>145</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#tmpACW AS a</td>
        <td>161</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">s</td>
        <td>168</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#tmpACW AS t</td>
        <td>171</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#tmpACW AS t</td>
        <td>211</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">dw</td>
        <td>219</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#tmpAgentDetailToSummarize AS t</td>
        <td>220</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">dw</td>
        <td>225</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#tmpAgentsToSummarize AS t</td>
        <td>226</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">DELETE with FROM clause</td>
        <td colspan="1">
FROM #tmpAgentDetailToSummarize AS t
     INNER JOIN
     dbo.Agent_Log_Detail_Summary AS s
     ON s.Agent_Session_ID = t.Agent_Session_ID
        AND s.Stateindex = t.StateIndex
        AND s.Header_start_Date = t.Start_Date</td>
        <td>59</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">
FROM #tmpAgentsToSummarize AS t
     INNER JOIN
     dbo.Agent_Log_Summary AS s
     ON s.Agent_Session_ID = t.Agent_Session_ID</td>
        <td>65</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">
FROM #tmpAgentDetailToSummarize AS t
     INNER JOIN
     dbo.dw_agentsdetail_to_summarize AS dw
     ON dw.Agent_Session_ID = t.Agent_Session_ID
        AND dw.StateIndex = t.StateIndex</td>
        <td>220</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">
FROM #tmpAgentsToSummarize AS t
     INNER JOIN
     dbo.dw_agents_to_summarize AS dw
     ON dw.Agent_Session_ID = t.Agent_Session_ID</td>
        <td>226</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">BEGIN TRANSACTION</td>
        <td colspan="1">BEGIN TRANSACTION</td>
        <td>73</td>
      </tr>
      <tr valign="top">
        <td colspan="1">CASE</td>
        <td colspan="1">CASE WHEN DATEDIFF(dd, t.start_date, d.start_date) &gt;= 24 THEN 2073600000 ELSE DATEDIFF(ms, t.start_date, d.start_date) END</td>
        <td>86</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN n.Agent_Session_ID IS NULL THEN 0 WHEN DATEDIFF(dd, d.start_date, n.start_date) &gt;= 24 THEN 2073600000 ELSE DATEDIFF(ms, d.start_date, n.start_date) END</td>
        <td>112</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN n.Agent_Session_ID IS NULL THEN d.Start_Date ELSE n.Start_Date END</td>
        <td>118</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">SET OPTION OFF</td>
        <td colspan="1">SET FORCEPLAN OFF</td>
        <td>134</td>
      </tr>
      <tr valign="top">
        <td colspan="1">UPDATE with FROM clause</td>
        <td colspan="1">
FROM #tmpACW AS t
     INNER JOIN
     dbo.Contact_Log_Summary AS s
     ON s.Contact_ID = t.Contact_ID</td>
        <td>171</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">COMMIT TRANSACTION</td>
        <td colspan="1">COMMIT TRANSACTION</td>
        <td>229</td>
      </tr>
    </table>
  </body>
</html>