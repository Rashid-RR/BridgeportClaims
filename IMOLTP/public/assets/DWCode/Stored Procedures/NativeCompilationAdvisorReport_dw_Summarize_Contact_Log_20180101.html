<?xml version="1.0" encoding="utf-8"?>
<html>
  <head>
    <title>Native Compilation Advisor evaluation results for [DWCode].[dw_Summarize_Contact_Log]</title>
  </head>
  <body>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 14pt;">
      <b>Native Compilation Advisor evaluation results for [DWCode].[dw_Summarize_Contact_Log]</b>
    </p>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 10pt;">
      <b>Report Date/Time:</b>1/1/2018 5:09 PM<br /></p>
    <table border="1" cellpadding="5" cellspacing="0" STYLE="font-family: Verdana, Arial, sans-serif; font-size: 9pt;">
      <tr style="background-color:Silver">
        <th colspan="1" align="center">Transact-SQL Element</th>
        <th align="center">Transact-SQL Code</th>
        <th align="center">Line Number</th>
      </tr>
      <tr valign="top">
        <td colspan="1">SET OPTION ON</td>
        <td colspan="1">SET NOCOUNT ON</td>
        <td>1</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">SET XACT_ABORT ON</td>
        <td>2</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">SET ANSI_WARNINGS ON</td>
        <td>250</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">SELECT INTO</td>
        <td colspan="1">SELECT dw.Contact_ID AS Contact_ID,
       dw.StateIndexCount AS StateIndexCount,
       h.Media_Type AS Media_Type,
       k.sla_seconds AS sla_seconds,
       f.Abandon AS Abandon,
       h.bus_no AS bus_no,
       h.QtrHour_code AS QtrHour_code,
       f.skill_no AS skill_no,
       h.contact_code AS contact_code,
       f.Agent_No AS Agent_No,
       f.Team_No AS Team_No,
       dbo.fn_CalcQtrHourDateTime(h.Start_Date) AS QtrHourStart_date,
       h.ReskillIndicator AS ReskillIndicator,
       h.Start_Date AS Header_Start_Date,
       k.useShortAbandonThreshold AS useShortAbandonThreshold,
       k.shortAbandonThreshold AS shortAbandonThreshold,
       k.includeShortAbandons AS includeShortAbandons,
       k.includeOtherAbandons AS includeOtherAbandons
INTO   #tmpContacts
FROM   dbo.dw_contacts_to_summarize AS dw
       INNER JOIN
       dbo.contact_log_header AS h
       ON h.contact_id = dw.contact_id
       INNER JOIN
       dbo.contact_log_footer AS f
       ON f.contact_id = dw.contact_id
       LEFT OUTER JOIN
       dbo.Skills AS k
       ON k.Skill_No = f.Skill_No
WHERE  ISNULL((SELECT COUNT(*)
               FROM   dbo.Contact_Log_Detail AS q
               WHERE  q.contact_id = dw.contact_id), 0) &gt;= dw.StateIndexCount
       AND h.Media_Type IS NOT NULL</td>
        <td>9</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">SELECT d.Contact_ID,
       d.StateIndex,
       (CASE WHEN n.Contact_ID IS NULL THEN 0 ELSE (CASE WHEN ABS(DATEDIFF(dd, d.start_date, n.Start_date)) &gt; 25 THEN @max_durationms WHEN ABS(DATEDIFF(hh, d.start_date, n.Start_date)) &gt; 597 THEN @max_durationms WHEN ABS(DATEDIFF(mi, d.start_date, n.Start_date)) &gt; 35792 THEN @max_durationms WHEN ABS(DATEDIFF(ss, d.start_date, n.start_date)) &gt; @max_duration THEN @max_durationms ELSE ABS(DATEDIFF(ms, d.start_date, n.start_date)) END) END) AS Duration,
       (CASE WHEN n.Contact_ID IS NULL THEN d.Start_Date ELSE n.Start_Date END) AS End_Date,
       t.Bus_No,
       t.Header_Start_Date
INTO   #tmpContact_Log_Detail_Summary
FROM   #tmpContacts AS t
       INNER JOIN
       dbo.Contact_Log_Detail AS d WITH (INDEX (PK_contact_log_detail))
       ON d.Contact_ID = t.Contact_ID
       LEFT OUTER JOIN
       dbo.Contact_Log_Detail AS n WITH (INDEX (PK_contact_log_detail))
       ON n.Contact_ID = t.Contact_ID
          AND n.StateIndex = d.StateIndex + 1</td>
        <td>71</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">SELECT a.Contact_ID,
       CASE WHEN (a.Abandon = 'Y'
                  AND a.useShortAbandonThreshold = 1
                  AND a.sla_dur &lt; a.shortAbandonThreshold) THEN 1 ELSE 0 END AS isShortAbandon,
       (CASE WHEN (a.sla_dur IS NULL)
                  OR (a.ReskillIndicator = 2)
                  OR (a.ReskillIndicator = 3)
                  OR (a.ReskillIndicator = 4)
                  OR (a.Abandon = 'Y'
                      AND a.Agent_Time = 0
                      AND a.useShortAbandonThreshold = 1
                      AND a.sla_dur &lt; a.shortAbandonThreshold
                      AND a.includeShortAbandons = 0)
                  OR (a.Abandon = 'Y'
                      AND a.Agent_Time = 0
                      AND a.sla_dur &gt;= a.shortAbandonThreshold
                      AND a.includeOtherAbandons = 0) THEN -1 WHEN (a.Abandon = 'Y'
                                                                    AND a.Agent_Time = 0
                                                                    AND a.useShortAbandonThreshold = 1
                                                                    AND a.sla_dur &lt; a.shortAbandonThreshold
                                                                    AND a.includeShortAbandons = 1)
                                                                   OR (a.Abandon = 'Y'
                                                                       AND a.Agent_Time = 0
                                                                       AND a.sla_dur &gt;= a.shortAbandonThreshold
                                                                       AND a.includeOtherAbandons = 1)
                                                                   OR (a.Abandon = 'Y'
                                                                       AND a.Agent_Time = 0
                                                                       AND a.useShortAbandonThreshold = 0
                                                                       AND a.includeOtherAbandons = 1)
                                                                   OR (a.sla_dur &gt;= a.sla_seconds) THEN 1 ELSE 0 END) AS sla,
       a.PreQueue_time,
       a.InQueue_time,
       a.Agent_time,
       a.ActiveTalk_time,
       a.PostQueue_time,
       (CASE WHEN a.Abandon = 'Y' THEN a.InQueue_time ELSE 0 END) AS Abandon_time,
       a.Release_time,
       a.Hold_Time,
       a.Hold_cnt,
       a.Conf_Time,
       a.bus_no,
       a.Header_Start_Date,
       a.Routing_Time,
       a.Callback_Time
INTO   #tmpContact_Log_Summary
FROM   (SELECT   t.Contact_ID,
                 MAX(t.bus_no) AS bus_no,
                 SUM(CASE WHEN m.contact_state IS NOT NULL THEN CONVERT (BIGINT, s.duration) ELSE NULL END) / 1000 AS sla_dur,
                 MAX(t.sla_seconds) AS sla_seconds,
                 ISNULL(SUM(CASE WHEN c.category1 = 'PreQueue' THEN CONVERT (BIGINT, s.duration) ELSE CONVERT (BIGINT, 0) END), 0) AS PreQueue_time,
                 ISNULL(SUM(CASE WHEN c.category1 = 'InQueue' THEN CONVERT (BIGINT, s.duration) ELSE CONVERT (BIGINT, 0) END), 0) AS InQueue_time,
                 ISNULL(SUM(CASE WHEN c.category1 = 'Agent' THEN CONVERT (BIGINT, s.duration) ELSE CONVERT (BIGINT, 0) END), 0) AS Agent_time,
                 ISNULL(SUM(CASE WHEN c.Contact_State = 4 THEN CONVERT (BIGINT, s.duration) ELSE CONVERT (BIGINT, 0) END), 0) AS ActiveTalk_time,
                 ISNULL(SUM(CASE WHEN c.category1 = 'PostQueue' THEN CONVERT (BIGINT, s.duration) ELSE CONVERT (BIGINT, 0) END), 0) AS PostQueue_time,
                 ISNULL(SUM(CASE WHEN c.category1 = 'Release' THEN CONVERT (BIGINT, s.duration) ELSE CONVERT (BIGINT, 0) END), 0) AS Release_time,
                 ISNULL(SUM(CASE WHEN c.Contact_State = 14 THEN CONVERT (BIGINT, s.duration) ELSE CONVERT (BIGINT, 0) END), 0) AS Conf_time,
                 ISNULL(SUM(CASE WHEN c.Contact_State = 8 THEN CONVERT (BIGINT, s.duration) ELSE CONVERT (BIGINT, 0) END), 0) AS Hold_time,
                 ISNULL(SUM(CASE WHEN c.Contact_State = 8 THEN 1 ELSE 0 END), 0) AS Hold_cnt,
                 MAX(t.Abandon) AS Abandon,
                 MAX(t.ReskillIndicator) AS ReskillIndicator,
                 MAX(t.Header_Start_Date) AS Header_Start_Date,
                 MAX(t.Skill_no) AS Skill_No,
                 MAX(CASE WHEN t.useShortAbandonThreshold = 0 THEN 0 ELSE 1 END) AS useShortAbandonThreshold,
                 MAX(t.shortAbandonThreshold) AS shortAbandonThreshold,
                 MAX(CASE WHEN t.includeShortAbandons = 0 THEN 0 ELSE 1 END) AS includeShortAbandons,
                 MAX(CASE WHEN t.includeOtherAbandons = 0 THEN 0 ELSE 1 END) AS includeOtherAbandons,
                 ISNULL(SUM(CASE WHEN d.Contact_State = 2 THEN CONVERT (BIGINT, s.duration) ELSE CONVERT (BIGINT, 0) END), 0) AS Routing_Time,
                 ISNULL(SUM(CASE WHEN d.Contact_State = 15 THEN CONVERT (BIGINT, s.duration) ELSE CONVERT (BIGINT, 0) END), 0) AS Callback_Time
        FROM     #tmpContacts AS t
                 INNER JOIN
                 dbo.Contact_Log_Detail AS d
                 ON d.Contact_ID = t.Contact_ID
                 INNER JOIN
                 dbo.Contact_Log_Detail_Summary AS s WITH (INDEX (PK_Contact_Log_Detail_Summary))
                 ON s.Contact_ID = d.Contact_ID
                    AND s.StateIndex = d.StateIndex
                 INNER JOIN
                 dbo.Contact_State AS c
                 ON c.contact_state = d.contact_state
                 LEFT OUTER JOIN
                 dbo.sla_media AS m
                 ON m.contact_state = d.contact_state
                    AND m.media_type = t.media_type
        GROUP BY t.Contact_ID) AS a
OPTION (FORCE ORDER)</td>
        <td>120</td>
      </tr>
      <tr valign="top">
        <td colspan="1">BEGIN TRANSACTION</td>
        <td colspan="1">BEGIN TRANSACTION</td>
        <td>51</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">CASE</td>
        <td colspan="1">CASE WHEN n.Contact_ID IS NULL THEN 0 ELSE (CASE WHEN ABS(DATEDIFF(dd, d.start_date, n.Start_date)) &gt; 25 THEN @max_durationms WHEN ABS(DATEDIFF(hh, d.start_date, n.Start_date)) &gt; 597 THEN @max_durationms WHEN ABS(DATEDIFF(mi, d.start_date, n.Start_date)) &gt; 35792 THEN @max_durationms WHEN ABS(DATEDIFF(ss, d.start_date, n.start_date)) &gt; @max_duration THEN @max_durationms ELSE ABS(DATEDIFF(ms, d.start_date, n.start_date)) END) END</td>
        <td>74</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN ABS(DATEDIFF(dd, d.start_date, n.Start_date)) &gt; 25 THEN @max_durationms WHEN ABS(DATEDIFF(hh, d.start_date, n.Start_date)) &gt; 597 THEN @max_durationms WHEN ABS(DATEDIFF(mi, d.start_date, n.Start_date)) &gt; 35792 THEN @max_durationms WHEN ABS(DATEDIFF(ss, d.start_date, n.start_date)) &gt; @max_duration THEN @max_durationms ELSE ABS(DATEDIFF(ms, d.start_date, n.start_date)) END</td>
        <td>75</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN n.Contact_ID IS NULL THEN d.Start_Date ELSE n.Start_Date END</td>
        <td>86</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN (a.Abandon = 'Y'
           AND a.useShortAbandonThreshold = 1
           AND a.sla_dur &lt; a.shortAbandonThreshold) THEN 1 ELSE 0 END</td>
        <td>122</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN (a.sla_dur IS NULL)
          OR (a.ReskillIndicator = 2)
          OR (a.ReskillIndicator = 3)
          OR (a.ReskillIndicator = 4)
          OR (a.Abandon = 'Y'
              AND a.Agent_Time = 0
              AND a.useShortAbandonThreshold = 1
              AND a.sla_dur &lt; a.shortAbandonThreshold
              AND a.includeShortAbandons = 0)
          OR (a.Abandon = 'Y'
              AND a.Agent_Time = 0
              AND a.sla_dur &gt;= a.shortAbandonThreshold
              AND a.includeOtherAbandons = 0) THEN -1 WHEN (a.Abandon = 'Y'
                                                            AND a.Agent_Time = 0
                                                            AND a.useShortAbandonThreshold = 1
                                                            AND a.sla_dur &lt; a.shortAbandonThreshold
                                                            AND a.includeShortAbandons = 1)
                                                           OR (a.Abandon = 'Y'
                                                               AND a.Agent_Time = 0
                                                               AND a.sla_dur &gt;= a.shortAbandonThreshold
                                                               AND a.includeOtherAbandons = 1)
                                                           OR (a.Abandon = 'Y'
                                                               AND a.Agent_Time = 0
                                                               AND a.useShortAbandonThreshold = 0
                                                               AND a.includeOtherAbandons = 1)
                                                           OR (a.sla_dur &gt;= a.sla_seconds) THEN 1 ELSE 0 END</td>
        <td>125</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN a.Abandon = 'Y' THEN a.InQueue_time ELSE 0 END</td>
        <td>167</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN m.contact_state IS NOT NULL THEN CONVERT (BIGINT, s.duration) ELSE NULL END</td>
        <td>185</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN c.category1 = 'PreQueue' THEN CONVERT (BIGINT, s.duration) ELSE CONVERT (BIGINT, 0) END</td>
        <td>190</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN c.category1 = 'InQueue' THEN CONVERT (BIGINT, s.duration) ELSE CONVERT (BIGINT, 0) END</td>
        <td>194</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN c.category1 = 'Agent' THEN CONVERT (BIGINT, s.duration) ELSE CONVERT (BIGINT, 0) END</td>
        <td>198</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN c.Contact_State = 4 THEN CONVERT (BIGINT, s.duration) ELSE CONVERT (BIGINT, 0) END</td>
        <td>202</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN c.category1 = 'PostQueue' THEN CONVERT (BIGINT, s.duration) ELSE CONVERT (BIGINT, 0) END</td>
        <td>206</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN c.category1 = 'Release' THEN CONVERT (BIGINT, s.duration) ELSE CONVERT (BIGINT, 0) END</td>
        <td>210</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN c.Contact_State = 14 THEN CONVERT (BIGINT, s.duration) ELSE CONVERT (BIGINT, 0) END</td>
        <td>214</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN c.Contact_State = 8 THEN CONVERT (BIGINT, s.duration) ELSE CONVERT (BIGINT, 0) END</td>
        <td>218</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN c.Contact_State = 8 THEN 1 ELSE 0 END</td>
        <td>222</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN t.useShortAbandonThreshold = 0 THEN 0 ELSE 1 END</td>
        <td>229</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN t.includeShortAbandons = 0 THEN 0 ELSE 1 END</td>
        <td>231</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN t.includeOtherAbandons = 0 THEN 0 ELSE 1 END</td>
        <td>232</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN d.Contact_State = 2 THEN CONVERT (BIGINT, s.duration) ELSE CONVERT (BIGINT, 0) END</td>
        <td>233</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN d.Contact_State = 15 THEN CONVERT (BIGINT, s.duration) ELSE CONVERT (BIGINT, 0) END</td>
        <td>236</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN SOURCE.PreQueue_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.PreQueue_time) ELSE @max_durationms END</td>
        <td>258</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN SOURCE.InQueue_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.InQueue_time) ELSE @max_durationms END</td>
        <td>261</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN SOURCE.Agent_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Agent_time) ELSE @max_durationms END</td>
        <td>264</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN SOURCE.ActiveTalk_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.ActiveTalk_time) ELSE @max_durationms END</td>
        <td>267</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN SOURCE.PostQueue_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.PostQueue_time) ELSE @max_durationms END</td>
        <td>270</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN SOURCE.Abandon_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Abandon_time) ELSE @max_durationms END</td>
        <td>273</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN SOURCE.Release_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Release_time) ELSE @max_durationms END</td>
        <td>276</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN SOURCE.Hold_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Hold_time) ELSE @max_durationms END</td>
        <td>279</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN SOURCE.Conf_Time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Conf_Time) ELSE @max_durationms END</td>
        <td>283</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN SOURCE.Routing_Time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Routing_Time) ELSE @max_durationms END</td>
        <td>287</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN SOURCE.Callback_Time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Callback_Time) ELSE @max_durationms END</td>
        <td>290</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN SOURCE.PreQueue_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.PreQueue_time) ELSE @max_durationms END</td>
        <td>317</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN SOURCE.InQueue_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.InQueue_time) ELSE @max_durationms END</td>
        <td>320</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN SOURCE.Agent_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Agent_time) ELSE @max_durationms END</td>
        <td>323</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN SOURCE.ActiveTalk_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.ActiveTalk_time) ELSE @max_durationms END</td>
        <td>326</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN SOURCE.PostQueue_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.PostQueue_time) ELSE @max_durationms END</td>
        <td>329</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN SOURCE.Abandon_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Abandon_time) ELSE @max_durationms END</td>
        <td>332</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN SOURCE.Release_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Release_time) ELSE @max_durationms END</td>
        <td>335</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN SOURCE.Hold_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Hold_time) ELSE @max_durationms END</td>
        <td>338</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN SOURCE.Conf_Time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Conf_Time) ELSE @max_durationms END</td>
        <td>343</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN SOURCE.Routing_Time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Routing_Time) ELSE @max_durationms END</td>
        <td>350</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN SOURCE.Callback_Time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Callback_Time) ELSE @max_durationms END</td>
        <td>353</td>
      </tr>
      <tr valign="top">
        <td colspan="1">One-part names</td>
        <td colspan="1">#tmpContacts AS t</td>
        <td>93</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#tmpContact_Log_Detail_Summary AS SOURCE</td>
        <td>100</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#tmpContacts AS t</td>
        <td>239</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#tmpContact_Log_Summary AS SOURCE</td>
        <td>253</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">dw</td>
        <td>363</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#tmpContacts AS t</td>
        <td>365</td>
      </tr>
      <tr valign="top">
        <td colspan="1">MERGE</td>
        <td colspan="1">MERGE INTO dbo.Contact_Log_Detail_Summary
 AS TARGET
USING #tmpContact_Log_Detail_Summary AS SOURCE ON TARGET.Contact_ID = SOURCE.Contact_ID
                                                  AND TARGET.StateIndex = SOURCE.StateIndex
WHEN MATCHED THEN UPDATE 
SET TARGET.Duration          = SOURCE.Duration,
    TARGET.End_Date          = SOURCE.End_Date,
    TARGET.Bus_No            = SOURCE.Bus_No,
    TARGET.Header_Start_Date = SOURCE.Header_Start_Date
WHEN NOT MATCHED THEN INSERT (Contact_ID, StateIndex, Duration, End_Date, Bus_No, Header_Start_Date) VALUES (SOURCE.Contact_ID, SOURCE.StateIndex, SOURCE.Duration, SOURCE.End_Date, SOURCE.Bus_No, SOURCE.Header_Start_Date)</td>
        <td>99</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">MERGE INTO dbo.Contact_Log_Detail_Summary
 AS TARGET
USING #tmpContact_Log_Detail_Summary AS SOURCE ON TARGET.Contact_ID = SOURCE.Contact_ID
                                                  AND TARGET.StateIndex = SOURCE.StateIndex
WHEN MATCHED THEN UPDATE 
SET TARGET.Duration          = SOURCE.Duration,
    TARGET.End_Date          = SOURCE.End_Date,
    TARGET.Bus_No            = SOURCE.Bus_No,
    TARGET.Header_Start_Date = SOURCE.Header_Start_Date
WHEN NOT MATCHED THEN INSERT (Contact_ID, StateIndex, Duration, End_Date, Bus_No, Header_Start_Date) VALUES (SOURCE.Contact_ID, SOURCE.StateIndex, SOURCE.Duration, SOURCE.End_Date, SOURCE.Bus_No, SOURCE.Header_Start_Date)</td>
        <td>99</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">MERGE INTO dbo.Contact_Log_Summary
 AS TARGET
USING #tmpContact_Log_Summary AS SOURCE ON TARGET.Contact_ID = SOURCE.Contact_ID
WHEN MATCHED THEN UPDATE 
SET TARGET.sla                   = SOURCE.sla,
    TARGET.PreQueue_time         = CASE WHEN SOURCE.PreQueue_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.PreQueue_time) ELSE @max_durationms END,
    TARGET.InQueue_time          = CASE WHEN SOURCE.InQueue_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.InQueue_time) ELSE @max_durationms END,
    TARGET.Agent_time            = CASE WHEN SOURCE.Agent_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Agent_time) ELSE @max_durationms END,
    TARGET.ActiveTalk_time       = CASE WHEN SOURCE.ActiveTalk_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.ActiveTalk_time) ELSE @max_durationms END,
    TARGET.PostQueue_time        = CASE WHEN SOURCE.PostQueue_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.PostQueue_time) ELSE @max_durationms END,
    TARGET.Abandon_time          = CASE WHEN SOURCE.Abandon_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Abandon_time) ELSE @max_durationms END,
    TARGET.Release_time          = CASE WHEN SOURCE.Release_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Release_time) ELSE @max_durationms END,
    TARGET.Hold_time             = CASE WHEN SOURCE.Hold_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Hold_time) ELSE @max_durationms END,
    TARGET.Hold_cnt              = SOURCE.Hold_cnt,
    TARGET.Conf_Time             = CASE WHEN SOURCE.Conf_Time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Conf_Time) ELSE @max_durationms END,
    TARGET.DateContactWarehoused = GETUTCDATE(),
    TARGET.Routing_Time          = CASE WHEN SOURCE.Routing_Time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Routing_Time) ELSE @max_durationms END,
    TARGET.Callback_Time         = CASE WHEN SOURCE.Callback_Time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Callback_Time) ELSE @max_durationms END
WHEN NOT MATCHED THEN INSERT (Contact_Id, sla, PreQueue_time, InQueue_time, Agent_time, ActiveTalk_time, PostQueue_time, Abandon_time, Release_time, Hold_time, Hold_cnt, ACW_Time, Conf_Time, DateContactWarehoused, bus_no, Header_Start_Date, isShortAbandon, Routing_Time, Callback_Time) VALUES (SOURCE.Contact_Id, SOURCE.sla, CASE WHEN SOURCE.PreQueue_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.PreQueue_time) ELSE @max_durationms END, CASE WHEN SOURCE.InQueue_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.InQueue_time) ELSE @max_durationms END, CASE WHEN SOURCE.Agent_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Agent_time) ELSE @max_durationms END, CASE WHEN SOURCE.ActiveTalk_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.ActiveTalk_time) ELSE @max_durationms END, CASE WHEN SOURCE.PostQueue_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.PostQueue_time) ELSE @max_durationms END, CASE WHEN SOURCE.Abandon_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Abandon_time) ELSE @max_durationms END, CASE WHEN SOURCE.Release_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Release_time) ELSE @max_durationms END, CASE WHEN SOURCE.Hold_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Hold_time) ELSE @max_durationms END, SOURCE.Hold_cnt, 0, CASE WHEN SOURCE.Conf_Time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Conf_Time) ELSE @max_durationms END, GETUTCDATE(), SOURCE.bus_no, SOURCE.Header_Start_Date, SOURCE.isShortAbandon, CASE WHEN SOURCE.Routing_Time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Routing_Time) ELSE @max_durationms END, CASE WHEN SOURCE.Callback_Time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Callback_Time) ELSE @max_durationms END)</td>
        <td>252</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">MERGE INTO dbo.Contact_Log_Summary
 AS TARGET
USING #tmpContact_Log_Summary AS SOURCE ON TARGET.Contact_ID = SOURCE.Contact_ID
WHEN MATCHED THEN UPDATE 
SET TARGET.sla                   = SOURCE.sla,
    TARGET.PreQueue_time         = CASE WHEN SOURCE.PreQueue_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.PreQueue_time) ELSE @max_durationms END,
    TARGET.InQueue_time          = CASE WHEN SOURCE.InQueue_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.InQueue_time) ELSE @max_durationms END,
    TARGET.Agent_time            = CASE WHEN SOURCE.Agent_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Agent_time) ELSE @max_durationms END,
    TARGET.ActiveTalk_time       = CASE WHEN SOURCE.ActiveTalk_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.ActiveTalk_time) ELSE @max_durationms END,
    TARGET.PostQueue_time        = CASE WHEN SOURCE.PostQueue_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.PostQueue_time) ELSE @max_durationms END,
    TARGET.Abandon_time          = CASE WHEN SOURCE.Abandon_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Abandon_time) ELSE @max_durationms END,
    TARGET.Release_time          = CASE WHEN SOURCE.Release_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Release_time) ELSE @max_durationms END,
    TARGET.Hold_time             = CASE WHEN SOURCE.Hold_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Hold_time) ELSE @max_durationms END,
    TARGET.Hold_cnt              = SOURCE.Hold_cnt,
    TARGET.Conf_Time             = CASE WHEN SOURCE.Conf_Time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Conf_Time) ELSE @max_durationms END,
    TARGET.DateContactWarehoused = GETUTCDATE(),
    TARGET.Routing_Time          = CASE WHEN SOURCE.Routing_Time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Routing_Time) ELSE @max_durationms END,
    TARGET.Callback_Time         = CASE WHEN SOURCE.Callback_Time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Callback_Time) ELSE @max_durationms END
WHEN NOT MATCHED THEN INSERT (Contact_Id, sla, PreQueue_time, InQueue_time, Agent_time, ActiveTalk_time, PostQueue_time, Abandon_time, Release_time, Hold_time, Hold_cnt, ACW_Time, Conf_Time, DateContactWarehoused, bus_no, Header_Start_Date, isShortAbandon, Routing_Time, Callback_Time) VALUES (SOURCE.Contact_Id, SOURCE.sla, CASE WHEN SOURCE.PreQueue_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.PreQueue_time) ELSE @max_durationms END, CASE WHEN SOURCE.InQueue_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.InQueue_time) ELSE @max_durationms END, CASE WHEN SOURCE.Agent_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Agent_time) ELSE @max_durationms END, CASE WHEN SOURCE.ActiveTalk_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.ActiveTalk_time) ELSE @max_durationms END, CASE WHEN SOURCE.PostQueue_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.PostQueue_time) ELSE @max_durationms END, CASE WHEN SOURCE.Abandon_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Abandon_time) ELSE @max_durationms END, CASE WHEN SOURCE.Release_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Release_time) ELSE @max_durationms END, CASE WHEN SOURCE.Hold_time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Hold_time) ELSE @max_durationms END, SOURCE.Hold_cnt, 0, CASE WHEN SOURCE.Conf_Time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Conf_Time) ELSE @max_durationms END, GETUTCDATE(), SOURCE.bus_no, SOURCE.Header_Start_Date, SOURCE.isShortAbandon, CASE WHEN SOURCE.Routing_Time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Routing_Time) ELSE @max_durationms END, CASE WHEN SOURCE.Callback_Time &lt; @max_durationms THEN CONVERT (INT, SOURCE.Callback_Time) ELSE @max_durationms END)</td>
        <td>252</td>
      </tr>
      <tr valign="top">
        <td colspan="1">SET OPTION OFF</td>
        <td colspan="1">SET ANSI_WARNINGS OFF</td>
        <td>118</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">DELETE with FROM clause</td>
        <td colspan="1">
FROM #tmpContacts AS t, dbo.dw_contacts_to_summarize AS dw</td>
        <td>364</td>
      </tr>
      <tr valign="top">
        <td colspan="1">COMMIT TRANSACTION</td>
        <td colspan="1">COMMIT TRANSACTION</td>
        <td>371</td>
      </tr>
    </table>
  </body>
</html>