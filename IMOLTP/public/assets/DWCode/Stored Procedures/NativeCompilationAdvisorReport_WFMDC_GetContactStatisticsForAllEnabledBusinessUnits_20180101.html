<?xml version="1.0" encoding="utf-8"?>
<html>
  <head>
    <title>Native Compilation Advisor evaluation results for [DWCode].[WFMDC_GetContactStatisticsForAllEnabledBusinessUnits]</title>
  </head>
  <body>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 14pt;">
      <b>Native Compilation Advisor evaluation results for [DWCode].[WFMDC_GetContactStatisticsForAllEnabledBusinessUnits]</b>
    </p>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 10pt;">
      <b>Report Date/Time:</b>1/1/2018 5:11 PM<br /></p>
    <table border="1" cellpadding="5" cellspacing="0" STYLE="font-family: Verdana, Arial, sans-serif; font-size: 9pt;">
      <tr style="background-color:Silver">
        <th colspan="1" align="center">Transact-SQL Element</th>
        <th align="center">Transact-SQL Code</th>
        <th align="center">Line Number</th>
      </tr>
      <tr valign="top">
        <td colspan="1">SET OPTION ON</td>
        <td colspan="1">SET NOCOUNT ON</td>
        <td>3</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">SELECT INTO</td>
        <td colspan="1">SELECT DISTINCT bu.Business_Unit_Name,
                bu.Bus_No
INTO   #WFM_BUs
FROM   dbo.Business_Unit AS bu
       INNER JOIN
       dbo.ProductTeamAssignments AS pta
       ON pta.Bus_No = bu.Bus_No
       INNER JOIN
       dbo.Business_Unit_Verint_Server AS buvs
       ON buvs.Bus_No = bu.Bus_No
WHERE  pta.ProductID IN (26, 24, 18, 20)
       AND buvs.VerintServerID = @VerintServerID
       AND (@BU_To_Load IS NULL
            OR bu.Bus_No = @BU_To_Load)</td>
        <td>40</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">SELECT *
INTO   #IntervalStartDates
FROM   (SELECT ISNULL(dq.START_DATE, @startdate) AS StartDate
        FROM   #WFM_BUs AS wbu
               LEFT OUTER JOIN
               dbo.dw_POC_ByQtrHour AS dq
               ON wbu.Bus_No = dq.Bus_No
                  AND dq.start_date &gt;= @startdate
                  AND dq.start_date &lt; @enddate
        UNION
        SELECT ISNULL(dq.START_DATE, @previousstartdate) AS StartDate
        FROM   #WFM_BUs AS wbu
               LEFT OUTER JOIN
               dbo.dw_POC_ByQtrHour AS dq
               ON wbu.Bus_No = dq.Bus_No
                  AND dq.start_date &gt;= @previousstartdate
                  AND dq.start_date &lt; @previousenddate) AS ww</td>
        <td>51</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">SELECT DISTINCT bu.Bus_No,
                ps.StartDate
INTO   #Combined
FROM   #WFM_BUs AS bu CROSS JOIN #IntervalStartDates AS ps</td>
        <td>67</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">SELECT   c.Bus_No,
         c.StartDate AS StartDate,
         s.skill_no,
         s.Skill_Name,
         m.Media_Name AS MediaTypeName,
         m.Media_Type AS MediaTypeID,
         CASE WHEN (s.Outbound_Skill = 1) THEN SUM(ISNULL(dq.Total_Cnt, 0)) ELSE SUM(ISNULL(dq.InQueue_Cnt, 0)) END - CASE WHEN (s.WFOCountReskills = 1) THEN 0 ELSE SUM(ISNULL(dq.ReSkill_Cnt, 0)) END AS CallCount,
         SUM(ISNULL(dq.Agent_Cnt, 0)) AS Handled,
         CASE WHEN SUM(ISNULL(Agent_Cnt, 0)) = 0 THEN 0 ELSE SUM(ISNULL(Agent_Time, 0) + ISNULL(ACW_Time, 0)) / SUM(ISNULL(Agent_Cnt, 0)) END AS AverageHandleTime,
         SUM(ISNULL(Abandon_Cnt, 0)) AS AbandonCount,
         CASE WHEN SUM(ISNULL(In_SLA, 0) + ISNULL(Out_SLA, 0)) = 0 THEN 0 ELSE SUM(CAST (In_SLA AS FLOAT)) / SUM(CAST (In_SLA AS FLOAT) + CAST (Out_SLA AS FLOAT)) * 100 END AS ServiceLevel,
         CASE WHEN SUM(ISNULL(InQueue_Cnt, 0)) = 0 THEN 0 ELSE SUM(ISNULL(InQueue_Time, 0)) / SUM(ISNULL(InQueue_Cnt, 0)) END AS AverageSpeedOfAnswer,
         SUM(ISNULL(PreQueue_Time, 0)) + SUM(ISNULL(InQueue_Time, 0)) + SUM(ISNULL(Agent_Time, 0)) + SUM(ISNULL(PostQueue_Time, 0)) AS TotalContactTime
INTO     #WFM_CSI_Results
FROM     #Combined AS c
         LEFT OUTER JOIN
         dbo.dw_POC_ByQtrHour AS dq
         ON c.Bus_No = dq.Bus_No
            AND c.StartDate = dq.Start_Date
         LEFT OUTER JOIN
         dbo.Business_Unit AS bu
         ON bu.Bus_No = dq.Bus_No
         LEFT OUTER JOIN
         dbo.Skills AS s
         ON s.Skill_No = dq.Skill_No
            AND COALESCE (s.IsNaturalCalling, 0) = 0
            AND COALESCE (s.IsDialer, 0) = 0
         LEFT OUTER JOIN
         dbo.Media AS m
         ON m.Media_Type = s.Media_Type
GROUP BY s.WFOCountReskills, c.Bus_No, c.StartDate, s.skill_no, s.Skill_Name, m.Media_Name, m.Media_Type, s.Outbound_Skill</td>
        <td>74</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">SELECT ww.Bus_No,
       ww.Contact_ID
INTO   #LiveContacts
FROM   (SELECT DISTINCT rcl.contact_id,
                        rcl.Bus_No
        FROM   dbo.RT_Contact_Log AS rcl
               INNER JOIN
               #WFM_BUs AS wu
               ON wu.Bus_No = rcl.Bus_no
        WHERE  (rcl.Start_Date &gt;= @startdate
                AND rcl.Start_Date &lt; @enddate)
        UNION ALL
        SELECT DISTINCT pcl.Contact_Id,
                        pcl.Bus_No
        FROM   dbo.PersistentContactLog AS pcl
               INNER JOIN
               dbo.Contact_Log_Detail AS cld
               ON cld.contact_id = pcl.Contact_Id
               INNER JOIN
               #WFM_BUs AS wu
               ON wu.Bus_No = pcl.Bus_no
        WHERE  (pcl.Start_Date &gt;= @startdate
                AND pcl.Start_Date &lt; @enddate)) AS ww</td>
        <td>106</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">SELECT   ww.Bus_No,
         ww.skill_no,
         ww.QtrStartDate,
         ww.Skill_Name,
         ww.Media_Type AS MediaTypeID,
         ww.Media_Name AS MediaTypeName,
         COUNT(ww.contact_id) AS ContactCount
INTO     #LiveContacts2
FROM     (SELECT DISTINCT cld.contact_id,
                          cld.Bus_No,
                          cld.skill_no,
                          s.Skill_Name,
                          m.Media_Name,
                          m.Media_Type,
                          DWCode.dbo.fn_CalcQtrHourDateTime(cld.start_date) AS QtrStartDate
          FROM   #LiveContacts AS rcl
                 INNER JOIN
                 dbo.Contact_Log_Detail AS cld
                 ON cld.contact_id = rcl.Contact_Id
                 INNER JOIN
                 dbo.Contact_State AS cs
                 ON cs.contact_state = cld.contact_state
                    AND cs.category1 = 'InQueue'
                 INNER JOIN
                 dbo.Skills AS s
                 ON s.Skill_No = cld.skill_no
                 INNER JOIN
                 dbo.Media AS m
                 ON m.Media_Type = s.Media_Type
          WHERE  m.Media_Type IN (1, 4)) AS ww
GROUP BY ww.Bus_No, ww.skill_no, ww.QtrStartDate, ww.skill_name, ww.Media_Name, ww.Media_Type</td>
        <td>126</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">SELECT tt.*
INTO   #FinalStats
FROM   (SELECT Bus_No,
               StartDate,
               Skill_No,
               Skill_Name,
               MediaTypeName,
               MediaTypeID,
               CallCount,
               Handled,
               AverageHandleTime,
               AbandonCount,
               ServiceLevel,
               AverageSpeedOfAnswer,
               TotalContactTime
        FROM   #WFM_CSI_Results AS csi
        UNION ALL
        SELECT lc.Bus_No,
               lc.QtrStartDate AS StartDate,
               lc.skill_no,
               lc.Skill_Name,
               lc.MediaTypeName,
               lc.MediaTypeID,
               lc.ContactCount AS CallCount,
               0 AS Handled,
               0 AS AverageHandleTime,
               0 AS AbandonCount,
               0 AS ServiceLevel,
               0 AS AverageSpeedOfAnswer,
               0 AS TotalContactTime
        FROM   #LiveContacts2 AS lc
               LEFT OUTER JOIN
               #WFM_CSI_Results AS wcr
               ON wcr.Bus_No = lc.Bus_No
                  AND wcr.Skill_No = lc.skill_no
                  AND wcr.StartDate = lc.QtrStartDate
        WHERE  wcr.Bus_No IS NULL) AS tt</td>
        <td>164</td>
      </tr>
      <tr valign="top">
        <td colspan="1">*</td>
        <td colspan="1">SELECT *
INTO   #IntervalStartDates
FROM   (SELECT ISNULL(dq.START_DATE, @startdate) AS StartDate
        FROM   #WFM_BUs AS wbu
               LEFT OUTER JOIN
               dbo.dw_POC_ByQtrHour AS dq
               ON wbu.Bus_No = dq.Bus_No
                  AND dq.start_date &gt;= @startdate
                  AND dq.start_date &lt; @enddate
        UNION
        SELECT ISNULL(dq.START_DATE, @previousstartdate) AS StartDate
        FROM   #WFM_BUs AS wbu
               LEFT OUTER JOIN
               dbo.dw_POC_ByQtrHour AS dq
               ON wbu.Bus_No = dq.Bus_No
                  AND dq.start_date &gt;= @previousstartdate
                  AND dq.start_date &lt; @previousenddate) AS ww</td>
        <td>51</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">SELECT tt.*
INTO   #FinalStats
FROM   (SELECT Bus_No,
               StartDate,
               Skill_No,
               Skill_Name,
               MediaTypeName,
               MediaTypeID,
               CallCount,
               Handled,
               AverageHandleTime,
               AbandonCount,
               ServiceLevel,
               AverageSpeedOfAnswer,
               TotalContactTime
        FROM   #WFM_CSI_Results AS csi
        UNION ALL
        SELECT lc.Bus_No,
               lc.QtrStartDate AS StartDate,
               lc.skill_no,
               lc.Skill_Name,
               lc.MediaTypeName,
               lc.MediaTypeID,
               lc.ContactCount AS CallCount,
               0 AS Handled,
               0 AS AverageHandleTime,
               0 AS AbandonCount,
               0 AS ServiceLevel,
               0 AS AverageSpeedOfAnswer,
               0 AS TotalContactTime
        FROM   #LiveContacts2 AS lc
               LEFT OUTER JOIN
               #WFM_CSI_Results AS wcr
               ON wcr.Bus_No = lc.Bus_No
                  AND wcr.Skill_No = lc.skill_no
                  AND wcr.StartDate = lc.QtrStartDate
        WHERE  wcr.Bus_No IS NULL) AS tt</td>
        <td>164</td>
      </tr>
      <tr valign="top">
        <td colspan="1">One-part names</td>
        <td colspan="1">#WFM_BUs AS wbu</td>
        <td>55</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#WFM_BUs AS wbu</td>
        <td>61</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#WFM_BUs AS bu</td>
        <td>70</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#IntervalStartDates AS ps</td>
        <td>71</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#Combined AS c</td>
        <td>89</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#WFM_BUs AS wu</td>
        <td>113</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#WFM_BUs AS wu</td>
        <td>122</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#LiveContacts AS rcl</td>
        <td>142</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">wcr</td>
        <td>157</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#WFM_CSI_Results AS wcr</td>
        <td>159</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#LiveContacts2 AS yy</td>
        <td>160</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#WFM_CSI_Results AS csi</td>
        <td>180</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#LiveContacts2 AS lc</td>
        <td>197</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#WFM_CSI_Results AS wcr</td>
        <td>198</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">fs1</td>
        <td>203</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#FinalStats AS fs1</td>
        <td>204</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#FinalStats AS fs2</td>
        <td>208</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#WFM_BUs AS bu</td>
        <td>227</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#FinalStats AS fs</td>
        <td>228</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">CASE</td>
        <td colspan="1">CASE WHEN (s.Outbound_Skill = 1) THEN SUM(ISNULL(dq.Total_Cnt, 0)) ELSE SUM(ISNULL(dq.InQueue_Cnt, 0)) END</td>
        <td>80</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN (s.WFOCountReskills = 1) THEN 0 ELSE SUM(ISNULL(dq.ReSkill_Cnt, 0)) END</td>
        <td>80</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN SUM(ISNULL(Agent_Cnt, 0)) = 0 THEN 0 ELSE SUM(ISNULL(Agent_Time, 0) + ISNULL(ACW_Time, 0)) / SUM(ISNULL(Agent_Cnt, 0)) END</td>
        <td>82</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN SUM(ISNULL(In_SLA, 0) + ISNULL(Out_SLA, 0)) = 0 THEN 0 ELSE SUM(CAST (In_SLA AS FLOAT)) / SUM(CAST (In_SLA AS FLOAT) + CAST (Out_SLA AS FLOAT)) * 100 END</td>
        <td>84</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN SUM(ISNULL(InQueue_Cnt, 0)) = 0 THEN 0 ELSE SUM(ISNULL(InQueue_Time, 0)) / SUM(ISNULL(InQueue_Cnt, 0)) END</td>
        <td>86</td>
      </tr>
      <tr valign="top">
        <td colspan="1">COALESCE</td>
        <td colspan="1">COALESCE (s.IsNaturalCalling, 0)</td>
        <td>94</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">COALESCE (s.IsDialer, 0)</td>
        <td>95</td>
      </tr>
      <tr valign="top">
        <td colspan="1">UPDATE with FROM clause</td>
        <td colspan="1">
FROM #WFM_CSI_Results AS wcr
     LEFT OUTER JOIN
     #LiveContacts2 AS yy
     ON yy.Bus_No = wcr.Bus_No
        AND yy.skill_no = wcr.Skill_No
        AND yy.QtrStartDate = wcr.StartDate</td>
        <td>159</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">DELETE with FROM clause</td>
        <td colspan="1">
FROM #FinalStats AS fs1</td>
        <td>204</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">
FROM #FinalStats AS fs2</td>
        <td>208</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">Subquery</td>
        <td colspan="1">(SELECT *
 FROM   #FinalStats AS fs2
 WHERE  fs2.StartDate = fs1.StartDate
        AND fs2.Bus_No = fs1.Bus_No
        AND skill_no &lt;&gt; 0)</td>
        <td>206</td>
      </tr>
    </table>
  </body>
</html>