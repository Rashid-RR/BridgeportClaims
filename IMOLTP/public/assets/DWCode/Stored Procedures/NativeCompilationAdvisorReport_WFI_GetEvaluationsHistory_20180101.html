<?xml version="1.0" encoding="utf-8"?>
<html>
  <head>
    <title>Native Compilation Advisor evaluation results for [DWCode].[WFI_GetEvaluationsHistory]</title>
  </head>
  <body>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 14pt;">
      <b>Native Compilation Advisor evaluation results for [DWCode].[WFI_GetEvaluationsHistory]</b>
    </p>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 10pt;">
      <b>Report Date/Time:</b>1/1/2018 5:11 PM<br /></p>
    <table border="1" cellpadding="5" cellspacing="0" STYLE="font-family: Verdana, Arial, sans-serif; font-size: 9pt;">
      <tr style="background-color:Silver">
        <th colspan="1" align="center">Transact-SQL Element</th>
        <th align="center">Transact-SQL Code</th>
        <th align="center">Line Number</th>
      </tr>
      <tr valign="top">
        <td colspan="1">SET OPTION ON</td>
        <td colspan="1">SET NOCOUNT ON</td>
        <td>2</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">Table-valued functions</td>
        <td colspan="1">dbo.fn_GetWfiEvaluations(@SecurityProfileID, @BusNo) AS eval</td>
        <td>43</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">dbo.fn_GetWfiRules(@SecurityProfileID, @BusNo) AS r</td>
        <td>94</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">One-part names</td>
        <td colspan="1">WFIEvaluationSkills AS Evalskill</td>
        <td>62</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CTESkillCSV AS evalskill</td>
        <td>97</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#EvalsHistory</td>
        <td>122</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#EvalsHistory</td>
        <td>124</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">WFIRuleAgent AS ra</td>
        <td>131</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#Rules AS r</td>
        <td>132</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">WFIRuleTeam AS rt</td>
        <td>139</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#Rules AS r</td>
        <td>140</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">WFIRuleSkill AS rs</td>
        <td>147</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#Rules AS r</td>
        <td>148</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">WFIRuleInputs AS i</td>
        <td>167</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">WFIDataPoint AS d</td>
        <td>168</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#Rules AS r</td>
        <td>169</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">WFIActionEmailAgentSupervisor AS supEmail</td>
        <td>179</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#Rules AS r</td>
        <td>180</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">WFIActionEmailAgent AS emailAgent</td>
        <td>190</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">WFIActionEmailContent AS c</td>
        <td>191</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#Rules AS r</td>
        <td>192</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">WFIActionAgentMsg AS agentMsg</td>
        <td>202</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#Rules AS r</td>
        <td>203</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">WFIActionEmailTeam AS emailTeam</td>
        <td>213</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">WFIActionEmailContent AS c</td>
        <td>214</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#Rules AS r</td>
        <td>215</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">WFIActionEmailExternal AS emailExternal</td>
        <td>224</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#Rules AS r</td>
        <td>225</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">WFIActionManageSkill AS manageSkill</td>
        <td>235</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#Rules AS r</td>
        <td>236</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">WFIActionVerintCoaching AS coaching</td>
        <td>247</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#Rules AS r</td>
        <td>248</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">WFIActionVerintELearning AS eLearning</td>
        <td>257</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#Rules AS r</td>
        <td>258</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">WFIActionVerintELearning AS eLearning</td>
        <td>267</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">WFIActionVerintLesson AS lesson</td>
        <td>268</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#Rules AS r</td>
        <td>269</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">WFIActionVerintELearning AS eLearning</td>
        <td>277</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">WFIActionVerintBlock AS block</td>
        <td>278</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#Rules AS r</td>
        <td>279</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">WFIActionManageSkillAssignments AS manageSkill</td>
        <td>291</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#Rules AS r</td>
        <td>292</td>
      </tr>
      <tr valign="top">
        <td colspan="1">SELECT INTO</td>
        <td colspan="1">WITH   CTESkillCSV
AS     (SELECT   WFIEvaluationID,
                 STUFF((SELECT ',' + CONVERT (VARCHAR, es.Skill_No)
                        FROM   @EvalSkill AS es
                        WHERE  es.WFIEvaluationID = evs.WFIEvaluationID
                        FOR    XML PATH ('')), 1, 1, '') AS SkillNo,
                 STUFF((SELECT ',' + es.Skill_Name
                        FROM   @EvalSkill AS es
                        WHERE  es.WFIEvaluationID = evs.WFIEvaluationID
                        FOR    XML PATH ('')), 1, 1, '') AS SkillName
        FROM     @EvalSkill AS evs
        GROUP BY evs.WFIEvaluationID)
SELECT DISTINCT dbo.fn_ConvertUTCToTargetTimeZone(eval.CreateDate, @TimeZone) AS EvaluationDate,
                r.RuleID,
                r.RuleName,
                r.RuleDescription,
                r.CompoundLogic,
                eval.AgentNo,
                (CASE eval.AgentNo WHEN -1 THEN 'All Agents' ELSE a.First_Name + ISNULL(' ' + a.Last_Name, '') END) AS AgentName,
                evalskill.SkillNo,
                evalskill.SkillName AS SkillName,
                eval.IsAutomatic,
                eval.EvaluationStatusName,
                eval.EvaluationComment,
                a1.First_Name + ISNULL(' ' + a1.Last_Name, '') AS ReviewedBy,
                dbo.fn_ConvertUTCToTargetTimeZone(eval.ReviewedDate, @TimeZone) AS ReviewedDate,
                eval.SkillActionError,
                eval.CoachingActionError,
                eval.ELearningActionError,
                r.NoCondition
INTO   #EvalsHistory
FROM   @EvaluationData AS eval
       INNER JOIN
       dbo.fn_GetWfiRules(@SecurityProfileID, @BusNo) AS r
       ON r.RuleID = eval.RuleID
       LEFT OUTER JOIN
       dbo.Agents AS a
       ON a.Agent_No = eval.AgentNo
       LEFT OUTER JOIN
       dbo.Agents AS a1
       ON a1.Agent_No = eval.ReviewedBy
       LEFT OUTER JOIN
       CTESkillCSV AS evalskill
       ON eval.WFIEvaluationID = evalskill.WFIEvaluationID
       LEFT OUTER JOIN
       @EvalSkill AS csvskill
       ON eval.WFIEvaluationID = csvskill.WFIEvaluationID
WHERE  eval.AgentNo = ISNULL(@AgentNo, eval.AgentNo)
       AND (ISNULL(csvskill.skill_no, 0) = ISNULL(@SkillNo, ISNULL(csvskill.skill_no, 0)))
       AND ISNULL(a.Team_No, 0) = ISNULL(@TeamNo, ISNULL(a.Team_No, 0))
       AND r.BusNo = @BusNo</td>
        <td>66</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">SELECT DISTINCT (RuleID)
INTO   #Rules
FROM   #EvalsHistory</td>
        <td>124</td>
      </tr>
      <tr valign="top">
        <td colspan="1">CASE</td>
        <td colspan="1">CASE eval.AgentNo WHEN -1 THEN 'All Agents' ELSE a.First_Name + ISNULL(' ' + a.Last_Name, '') END</td>
        <td>78</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">WITH clause</td>
        <td colspan="1">WITH CTESkillCSV
AS (SELECT   WFIEvaluationID,
             STUFF((SELECT ',' + CONVERT (VARCHAR, es.Skill_No)
                    FROM   @EvalSkill AS es
                    WHERE  es.WFIEvaluationID = evs.WFIEvaluationID
                    FOR    XML PATH ('')), 1, 1, '') AS SkillNo,
             STUFF((SELECT ',' + es.Skill_Name
                    FROM   @EvalSkill AS es
                    WHERE  es.WFIEvaluationID = evs.WFIEvaluationID
                    FOR    XML PATH ('')), 1, 1, '') AS SkillName
    FROM     @EvalSkill AS evs
    GROUP BY evs.WFIEvaluationID)</td>
        <td>66</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1"> CTESkillCSV
AS (SELECT   WFIEvaluationID,
             STUFF((SELECT ',' + CONVERT (VARCHAR, es.Skill_No)
                    FROM   @EvalSkill AS es
                    WHERE  es.WFIEvaluationID = evs.WFIEvaluationID
                    FOR    XML PATH ('')), 1, 1, '') AS SkillNo,
             STUFF((SELECT ',' + es.Skill_Name
                    FROM   @EvalSkill AS es
                    WHERE  es.WFIEvaluationID = evs.WFIEvaluationID
                    FOR    XML PATH ('')), 1, 1, '') AS SkillName
    FROM     @EvalSkill AS evs
    GROUP BY evs.WFIEvaluationID)</td>
        <td>66</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">STUFF</td>
        <td colspan="1">STUFF((SELECT ',' + CONVERT (VARCHAR, es.Skill_No)
       FROM   @EvalSkill AS es
       WHERE  es.WFIEvaluationID = evs.WFIEvaluationID
       FOR    XML PATH ('')), 1, 1, '')</td>
        <td>67</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">STUFF((SELECT ',' + es.Skill_Name
       FROM   @EvalSkill AS es
       WHERE  es.WFIEvaluationID = evs.WFIEvaluationID
       FOR    XML PATH ('')), 1, 1, '')</td>
        <td>68</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">FOR XML</td>
        <td colspan="1">XML PATH ('')</td>
        <td>67</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">XML PATH ('')</td>
        <td>68</td>
      </tr>
    </table>
  </body>
</html>