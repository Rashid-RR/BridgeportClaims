<?xml version="1.0" encoding="utf-8"?>
<html>
  <head>
    <title>Native Compilation Advisor evaluation results for [DWCode].[IT_SkillSummaryByHalfHr]</title>
  </head>
  <body>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 14pt;">
      <b>Native Compilation Advisor evaluation results for [DWCode].[IT_SkillSummaryByHalfHr]</b>
    </p>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 10pt;">
      <b>Report Date/Time:</b>1/1/2018 5:11 PM<br /></p>
    <table border="1" cellpadding="5" cellspacing="0" STYLE="font-family: Verdana, Arial, sans-serif; font-size: 9pt;">
      <tr style="background-color:Silver">
        <th colspan="1" align="center">Transact-SQL Element</th>
        <th align="center">Transact-SQL Code</th>
        <th align="center">Line Number</th>
      </tr>
      <tr valign="top">
        <td colspan="1">SET OPTION ON</td>
        <td colspan="1">SET NOCOUNT ON</td>
        <td>3</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">One-part names</td>
        <td colspan="1">#SkillFilters</td>
        <td>22</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#CampaignFilters</td>
        <td>33</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#MediaFilters</td>
        <td>44</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#SkillFilters AS sf</td>
        <td>103</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#CampaignFilters AS cf</td>
        <td>104</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#MediaFilters AS mf</td>
        <td>105</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">TempContactsFull AS tc</td>
        <td>163</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#SkillFilters AS sf</td>
        <td>165</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#CampaignFilters AS cf</td>
        <td>166</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#MediaFilters AS mf</td>
        <td>167</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">TempAgentsSkillsStage AS tsks</td>
        <td>235</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#SkillFilters AS sf</td>
        <td>236</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#CampaignFilters AS cf</td>
        <td>237</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#MediaFilters AS mf</td>
        <td>238</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">[#TempRTAgents] AS r</td>
        <td>220</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">[#TempRTAgents] AS t</td>
        <td>221</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#SkillFilters AS sf</td>
        <td>266</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#CampaignFilters AS cf</td>
        <td>267</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#MediaFilters AS mf</td>
        <td>268</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">dw_HalfHour AS q</td>
        <td>406</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">TempFinal AS f</td>
        <td>407</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#SkillFilters AS sf</td>
        <td>410</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#CampaignFilters AS cf</td>
        <td>411</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#MediaFilters AS mf</td>
        <td>412</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#TempAgentSkills</td>
        <td>313</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#TempSLA</td>
        <td>322</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#TempContactsQueueData</td>
        <td>331</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#TempContacts</td>
        <td>340</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">Table-valued functions</td>
        <td colspan="1">dbo.fn_Split3(@SkillFilter, ',')</td>
        <td>27</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">dbo.fn_Split3(@CampaignFilter, ',')</td>
        <td>38</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">dbo.fn_Split3(@MediaFilter, ',')</td>
        <td>49</td>
      </tr>
      <tr valign="top">
        <td colspan="1">CASE</td>
        <td colspan="1">CASE WHEN DATEPART(MI, @UTCStartDateTemp) &gt;= 45 THEN '45' WHEN DATEPART(MI, @UTCStartDateTemp) &gt;= 30 THEN '30' WHEN DATEPART(MI, @UTCStartDateTemp) &gt;= 15 THEN '15' ELSE '0' END</td>
        <td>79</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE c.category1 WHEN 'InQueue' THEN 1 ELSE 0 END</td>
        <td>126</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE c.category1 WHEN 'InQueue' THEN DATEDIFF(second, r.[current_contact_date], @UTCNow_Date) ELSE 0 END</td>
        <td>130</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE c.category1 WHEN 'InQueue' THEN 1 ELSE 0 END</td>
        <td>143</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE c.category1 WHEN 'InQueue' THEN DATEDIFF(second, r.[current_contact_date], @UTCNow_Date) ELSE 0 END</td>
        <td>147</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE ISNULL(t.[working], 0) WHEN 0 THEN 0 ELSE 1 END</td>
        <td>198</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE ISNULL(r.[working], -1) WHEN 0 THEN CASE ISNULL(r.[available], -1) WHEN 1 THEN 1 ELSE 0 END ELSE 0 END</td>
        <td>202</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE ISNULL(r.[available], -1) WHEN 1 THEN 1 ELSE 0 END</td>
        <td>203</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE ISNULL(r.[working], -1) WHEN 0 THEN CASE ISNULL(r.[available], -1) WHEN 0 THEN 1 ELSE 0 END ELSE 0 END</td>
        <td>209</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE ISNULL(r.[available], -1) WHEN 0 THEN 1 ELSE 0 END</td>
        <td>210</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE ISNULL(f.[In_SLA], 0) WHEN 0 THEN 0 ELSE CONVERT (INT, ROUND(((1.0 * f.[In_SLA]) / (f.[In_SLA] + f.[Out_SLA])) * 100, 0)) END</td>
        <td>354</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE ISNULL(f.[AbandonCount], 0) WHEN 0 THEN 0 ELSE CASE ISNULL(f.[ContactsQueued], 0) WHEN 0 THEN 0 ELSE CONVERT (INT, ROUND(((1.0 * f.[AbandonCount]) / f.[ContactsQueued]) * 100, 0)) END END</td>
        <td>369</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE ISNULL(f.[ContactsQueued], 0) WHEN 0 THEN 0 ELSE CONVERT (INT, ROUND(((1.0 * f.[AbandonCount]) / f.[ContactsQueued]) * 100, 0)) END</td>
        <td>371</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE ISNULL(f.[InQueueTime], 0) WHEN 0 THEN 0 ELSE CASE ISNULL(f.[ContactsHandled], 0) WHEN 0 THEN 0 ELSE (f.[InQueueTime] - ISNULL(f.[AbandonTime], 0)) / f.[ContactsHandled] END END</td>
        <td>376</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE ISNULL(f.[ContactsHandled], 0) WHEN 0 THEN 0 ELSE (f.[InQueueTime] - ISNULL(f.[AbandonTime], 0)) / f.[ContactsHandled] END</td>
        <td>378</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE ISNULL(f.[AgentTime], 0) WHEN 0 THEN 0 ELSE CASE ISNULL(f.[ContactsHandled], 0) WHEN 0 THEN 0 ELSE f.[AgentTime] / f.[ContactsHandled] END END</td>
        <td>383</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE ISNULL(f.[ContactsHandled], 0) WHEN 0 THEN 0 ELSE f.[AgentTime] / f.[ContactsHandled] END</td>
        <td>385</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE ISNULL(f.[ACWTime], 0) WHEN 0 THEN 0 ELSE CASE ISNULL(f.[ContactsHandled], 0) WHEN 0 THEN 0 ELSE f.[ACWTime] / f.[ContactsHandled] END END</td>
        <td>390</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE ISNULL(f.[ContactsHandled], 0) WHEN 0 THEN 0 ELSE f.[ACWTime] / f.[ContactsHandled] END</td>
        <td>392</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE ISNULL(f.[AgentTime], 0) + ISNULL(f.[ACWTime], 0) WHEN 0 THEN 0 ELSE CASE ISNULL(f.[ContactsHandled], 0) WHEN 0 THEN 0 ELSE (f.[AgentTime] + f.[ACWTime]) / f.[ContactsHandled] END END</td>
        <td>397</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE ISNULL(f.[ContactsHandled], 0) WHEN 0 THEN 0 ELSE (f.[AgentTime] + f.[ACWTime]) / f.[ContactsHandled] END</td>
        <td>399</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN HalfHrCode = @CurrentHalfHrCode THEN SUM(AgentsloggedIn) ELSE -1 END</td>
        <td>288</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN HalfHrCode = @CurrentHalfHrCode THEN SUM(AgentsWorking) ELSE -1 END</td>
        <td>289</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN HalfHrCode = @CurrentHalfHrCode THEN SUM(AgentsIdle) ELSE -1 END</td>
        <td>290</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN HalfHrCode = @CurrentHalfHrCode THEN SUM(AgentsUnavailable) ELSE -1 END</td>
        <td>291</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN HalfHrCode = @CurrentHalfHrCode THEN SUM(QueueCount) ELSE -1 END</td>
        <td>294</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN HalfHrCode = @CurrentHalfHrCode THEN SUM(LongestQueueDur) ELSE -1 END</td>
        <td>295</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">SELECT INTO</td>
        <td colspan="1">SELECT   hh.[HalfHour_Code] AS HalfHrCode,
         h.[skill_no] AS SkillNo,
         SUM(h.[In_SLA]) AS In_SLA,
         SUM(h.[Out_SLA]) AS Out_SLA
INTO     #TempSLA
FROM     [dbo].[dw_sla_Skill_ByQtrHour] AS h
         INNER JOIN
         [dbo].[skills] AS s
         ON s.skill_no = h.[skill_no]
         INNER JOIN
         [dbo].[dw_HalfHour] AS hh
         ON hh.[HalfHour_Code] = dbo.fn_CalcTimeZoneHalfHourCodeFromUTC(h.[Start_date], @ClientTimeZoneName)
         LEFT OUTER JOIN
         #SkillFilters AS sf
         ON sf.Skill_no = h.[skill_no]
         LEFT OUTER JOIN
         #CampaignFilters AS cf
         ON cf.Campaign_no = s.[campaign_no]
         LEFT OUTER JOIN
         #MediaFilters AS mf
         ON mf.media_type = s.[media_type]
WHERE    h.[bus_no] = @Bus_No
         AND s.[Status] = 'CURR'
         AND h.[Start_Date] BETWEEN @UTCStart_Date AND @UTCNow_Date
         AND (@CampaignFilter IS NULL
              OR cf.Campaign_no = s.Campaign_no)
         AND (@SkillFilter IS NULL
              OR sf.Skill_no = h.skill_no)
         AND (@MediaFilter IS NULL
              OR mf.media_type = s.media_type)
GROUP BY hh.[HalfHour_Code], h.[skill_no]
ORDER BY hh.[HalfHour_Code], h.[skill_no]</td>
        <td>94</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">WITH     TempContactsFull
AS       (SELECT @CurrentHalfHrCode AS HalfHrCode,
                 r.skill_no AS SkillNo,
                 (CASE c.category1 WHEN 'InQueue' THEN 1 ELSE 0 END) AS QueueCount,
                 (CASE c.category1 WHEN 'InQueue' THEN DATEDIFF(second, r.[current_contact_date], @UTCNow_Date) ELSE 0 END) AS LongestQueueDur
          FROM   [dbo].[RT_Contact_Log] AS r
                 INNER JOIN
                 [dbo].[contact_state] AS c
                 ON c.[contact_state] = r.[current_contact_state]
          WHERE  r.[bus_no] = @Bus_No
          UNION ALL
          SELECT @CurrentHalfHrCode AS HalfHrCode,
                 r.[skill_no] AS SkillNo,
                 (CASE c.category1 WHEN 'InQueue' THEN 1 ELSE 0 END) AS QueueCount,
                 (CASE c.category1 WHEN 'InQueue' THEN DATEDIFF(second, r.[current_contact_date], @UTCNow_Date) ELSE 0 END) AS LongestQueueDur
          FROM   [dbo].[PersistentContactLog] AS r
                 INNER JOIN
                 [dbo].[contact_state] AS c
                 ON c.contact_state = r.[current_contact_state]
          WHERE  r.[bus_no] = @Bus_No)
SELECT   tc.HalfHrCode,
         tc.SkillNo,
         SUM(tc.QueueCount) AS QueueCount,
         MAX(tc.LongestQueueDur) AS LongestQueueDur
INTO     #TempContactsQueueData
FROM     TempContactsFull AS tc
         INNER JOIN
         dbo.skills AS s
         ON s.[skill_no] = tc.SkillNo
         LEFT OUTER JOIN
         #SkillFilters AS sf
         ON sf.Skill_no = tc.SkillNo
         LEFT OUTER JOIN
         #CampaignFilters AS cf
         ON cf.Campaign_no = s.[campaign_no]
         LEFT OUTER JOIN
         #MediaFilters AS mf
         ON mf.media_type = s.[media_type]
WHERE    s.[Status] = 'CURR'
         AND (@CampaignFilter IS NULL
              OR cf.Campaign_no = s.Campaign_no)
         AND (@SkillFilter IS NULL
              OR sf.Skill_no = tc.SkillNo)
         AND (@MediaFilter IS NULL
              OR mf.media_type = s.media_type)
GROUP BY tc.HalfHrCode, tc.SkillNo
ORDER BY tc.HalfHrCode, tc.SkillNo</td>
        <td>120</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">SELECT   r.[agent_no],
         r.[bus_no],
         r.[working],
         r.[available],
         r.[skill_no]
INTO     #TempRTAgents
FROM     [dbo].[RT_Agent_Log] AS r
WHERE    r.[bus_no] = @Bus_No
ORDER BY r.[agent_no]</td>
        <td>178</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">WITH     TempAgentsSkillsStage
AS       (SELECT @CurrentHalfHrCode AS HalfHrCode,
                 a.[skill_no] AS SkillNo,
                 r.agent_no AS AgentNo,
                 CASE ISNULL(t.[working], 0) WHEN 0 THEN 0 ELSE 1 END AS AgentsWorking,
                 CASE ISNULL(r.[working], -1) WHEN 0 THEN CASE ISNULL(r.[available], -1) WHEN 1 THEN 1 ELSE 0 END ELSE 0 END AS AgentsIdle,
                 CASE ISNULL(r.[working], -1) WHEN 0 THEN CASE ISNULL(r.[available], -1) WHEN 0 THEN 1 ELSE 0 END ELSE 0 END AS AgentsUnavailable,
                 s.campaign_no,
                 s.media_type
          FROM   [dbo].[Agentskl] AS a
                 INNER JOIN
                 [dbo].[skills] AS s
                 ON s.[skill_no] = a.[Skill_No]
                 LEFT OUTER JOIN
                 [#TempRTAgents] AS r
                 ON r.[agent_no] = a.[Agent_No]
                 LEFT OUTER JOIN
                 [#TempRTAgents] AS t
                 ON t.[agent_no] = a.[Agent_No]
                    AND t.[skill_no] = a.[skill_no]
          WHERE  r.[bus_no] = @Bus_No
                 AND a.[Status] = 'CURR'
                 AND s.[Status] = 'CURR')
SELECT   tsks.HalfHrCode,
         tsks.SkillNo,
         COUNT(tsks.AgentNo) AS AgentsloggedIn,
         SUM(tsks.AgentsWorking) AS AgentsWorking,
         SUM(tsks.AgentsIdle) AS AgentsIdle,
         SUM(tsks.AgentsUnavailable) AS AgentsUnavailable
INTO     #TempAgentSkills
FROM     TempAgentsSkillsStage AS tsks
         LEFT OUTER JOIN
         #SkillFilters AS sf
         ON sf.Skill_no = tsks.SkillNo
         LEFT OUTER JOIN
         #CampaignFilters AS cf
         ON cf.Campaign_no = tsks.[campaign_no]
         LEFT OUTER JOIN
         #MediaFilters AS mf
         ON mf.media_type = tsks.[media_type]
WHERE    (@CampaignFilter IS NULL
          OR cf.Campaign_no = tsks.[Campaign_no])
         AND (@SkillFilter IS NULL
              OR sf.Skill_no = tsks.SkillNo)
         AND (@MediaFilter IS NULL
              OR mf.media_type = tsks.[media_type])
GROUP BY tsks.HalfHrCode, tsks.SkillNo
ORDER BY tsks.HalfHrCode, tsks.SkillNo</td>
        <td>192</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">SELECT   hh.[HalfHour_Code] AS HalfHrCode,
         h.[skill_no] AS SkillNo,
         SUM(h.[Total_cnt]) AS ContactsOffered,
         SUM(h.[InQueue_Cnt]) AS ContactsQueued,
         SUM(h.[Agent_cnt]) AS ContactsHandled,
         SUM(h.[Abandon_cnt]) AS AbandonCount,
         SUM(h.[Abandon_time]) AS AbandonTime,
         SUM(h.[InQueue_time]) AS InQueueTime,
         SUM(h.[Hold_Time]) AS HoldTime,
         SUM(h.[Agent_Time]) AS AgentTime,
         SUM(h.[PostQueue_time]) AS PostQueueTime,
         SUM(h.[ACW_Time]) AS ACWTime
INTO     #TempContacts
FROM     [dbo].[dw_POC_ByQtrHour] AS h
         INNER JOIN
         [dbo].[skills] AS s
         ON s.[skill_no] = h.[skill_no]
         INNER JOIN
         [dbo].[dw_HalfHour] AS hh
         ON hh.[HalfHour_Code] = dbo.fn_CalcTimeZoneHalfHourCodeFromUTC(h.[Start_date], @ClientTimeZoneName)
         LEFT OUTER JOIN
         #SkillFilters AS sf
         ON sf.Skill_no = h.[skill_no]
         LEFT OUTER JOIN
         #CampaignFilters AS cf
         ON cf.Campaign_no = s.[campaign_no]
         LEFT OUTER JOIN
         #MediaFilters AS mf
         ON mf.media_type = s.[media_type]
WHERE    h.bus_no = @Bus_No
         AND s.[Status] = 'CURR'
         AND h.[Start_Date] BETWEEN @UTCStart_Date AND @UTCNow_Date
         AND (@CampaignFilter IS NULL
              OR cf.Campaign_no = s.Campaign_no)
         AND (@SkillFilter IS NULL
              OR sf.Skill_no = h.skill_no)
         AND (@MediaFilter IS NULL
              OR mf.media_type = s.media_type)
GROUP BY hh.[HalfHour_Code], h.[skill_no]
ORDER BY hh.[HalfHour_Code], h.[skill_no]</td>
        <td>249</td>
      </tr>
      <tr valign="top">
        <td colspan="1">WITH clause</td>
        <td colspan="1">WITH TempContactsFull
AS (SELECT @CurrentHalfHrCode AS HalfHrCode,
           r.skill_no AS SkillNo,
           (CASE c.category1 WHEN 'InQueue' THEN 1 ELSE 0 END) AS QueueCount,
           (CASE c.category1 WHEN 'InQueue' THEN DATEDIFF(second, r.[current_contact_date], @UTCNow_Date) ELSE 0 END) AS LongestQueueDur
    FROM   [dbo].[RT_Contact_Log] AS r
           INNER JOIN
           [dbo].[contact_state] AS c
           ON c.[contact_state] = r.[current_contact_state]
    WHERE  r.[bus_no] = @Bus_No
    UNION ALL
    SELECT @CurrentHalfHrCode AS HalfHrCode,
           r.[skill_no] AS SkillNo,
           (CASE c.category1 WHEN 'InQueue' THEN 1 ELSE 0 END) AS QueueCount,
           (CASE c.category1 WHEN 'InQueue' THEN DATEDIFF(second, r.[current_contact_date], @UTCNow_Date) ELSE 0 END) AS LongestQueueDur
    FROM   [dbo].[PersistentContactLog] AS r
           INNER JOIN
           [dbo].[contact_state] AS c
           ON c.contact_state = r.[current_contact_state]
    WHERE  r.[bus_no] = @Bus_No)</td>
        <td>120</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1"> TempContactsFull
AS (SELECT @CurrentHalfHrCode AS HalfHrCode,
           r.skill_no AS SkillNo,
           (CASE c.category1 WHEN 'InQueue' THEN 1 ELSE 0 END) AS QueueCount,
           (CASE c.category1 WHEN 'InQueue' THEN DATEDIFF(second, r.[current_contact_date], @UTCNow_Date) ELSE 0 END) AS LongestQueueDur
    FROM   [dbo].[RT_Contact_Log] AS r
           INNER JOIN
           [dbo].[contact_state] AS c
           ON c.[contact_state] = r.[current_contact_state]
    WHERE  r.[bus_no] = @Bus_No
    UNION ALL
    SELECT @CurrentHalfHrCode AS HalfHrCode,
           r.[skill_no] AS SkillNo,
           (CASE c.category1 WHEN 'InQueue' THEN 1 ELSE 0 END) AS QueueCount,
           (CASE c.category1 WHEN 'InQueue' THEN DATEDIFF(second, r.[current_contact_date], @UTCNow_Date) ELSE 0 END) AS LongestQueueDur
    FROM   [dbo].[PersistentContactLog] AS r
           INNER JOIN
           [dbo].[contact_state] AS c
           ON c.contact_state = r.[current_contact_state]
    WHERE  r.[bus_no] = @Bus_No)</td>
        <td>120</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">WITH TempAgentsSkillsStage
AS (SELECT @CurrentHalfHrCode AS HalfHrCode,
           a.[skill_no] AS SkillNo,
           r.agent_no AS AgentNo,
           CASE ISNULL(t.[working], 0) WHEN 0 THEN 0 ELSE 1 END AS AgentsWorking,
           CASE ISNULL(r.[working], -1) WHEN 0 THEN CASE ISNULL(r.[available], -1) WHEN 1 THEN 1 ELSE 0 END ELSE 0 END AS AgentsIdle,
           CASE ISNULL(r.[working], -1) WHEN 0 THEN CASE ISNULL(r.[available], -1) WHEN 0 THEN 1 ELSE 0 END ELSE 0 END AS AgentsUnavailable,
           s.campaign_no,
           s.media_type
    FROM   [dbo].[Agentskl] AS a
           INNER JOIN
           [dbo].[skills] AS s
           ON s.[skill_no] = a.[Skill_No]
           LEFT OUTER JOIN
           [#TempRTAgents] AS r
           ON r.[agent_no] = a.[Agent_No]
           LEFT OUTER JOIN
           [#TempRTAgents] AS t
           ON t.[agent_no] = a.[Agent_No]
              AND t.[skill_no] = a.[skill_no]
    WHERE  r.[bus_no] = @Bus_No
           AND a.[Status] = 'CURR'
           AND s.[Status] = 'CURR')</td>
        <td>192</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1"> TempAgentsSkillsStage
AS (SELECT @CurrentHalfHrCode AS HalfHrCode,
           a.[skill_no] AS SkillNo,
           r.agent_no AS AgentNo,
           CASE ISNULL(t.[working], 0) WHEN 0 THEN 0 ELSE 1 END AS AgentsWorking,
           CASE ISNULL(r.[working], -1) WHEN 0 THEN CASE ISNULL(r.[available], -1) WHEN 1 THEN 1 ELSE 0 END ELSE 0 END AS AgentsIdle,
           CASE ISNULL(r.[working], -1) WHEN 0 THEN CASE ISNULL(r.[available], -1) WHEN 0 THEN 1 ELSE 0 END ELSE 0 END AS AgentsUnavailable,
           s.campaign_no,
           s.media_type
    FROM   [dbo].[Agentskl] AS a
           INNER JOIN
           [dbo].[skills] AS s
           ON s.[skill_no] = a.[Skill_No]
           LEFT OUTER JOIN
           [#TempRTAgents] AS r
           ON r.[agent_no] = a.[Agent_No]
           LEFT OUTER JOIN
           [#TempRTAgents] AS t
           ON t.[agent_no] = a.[Agent_No]
              AND t.[skill_no] = a.[skill_no]
    WHERE  r.[bus_no] = @Bus_No
           AND a.[Status] = 'CURR'
           AND s.[Status] = 'CURR')</td>
        <td>192</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">WITH TempFinal
AS (SELECT   HalfHrCode,
             SkillNo,
             CASE WHEN HalfHrCode = @CurrentHalfHrCode THEN SUM(AgentsloggedIn) ELSE -1 END AS AgentsloggedIn,
             CASE WHEN HalfHrCode = @CurrentHalfHrCode THEN SUM(AgentsWorking) ELSE -1 END AS AgentsWorking,
             CASE WHEN HalfHrCode = @CurrentHalfHrCode THEN SUM(AgentsIdle) ELSE -1 END AS AgentsIdle,
             CASE WHEN HalfHrCode = @CurrentHalfHrCode THEN SUM(AgentsUnavailable) ELSE -1 END AS AgentsUnavailable,
             SUM(In_SLA) AS In_SLA,
             SUM(Out_SLA) AS Out_SLA,
             CASE WHEN HalfHrCode = @CurrentHalfHrCode THEN SUM(QueueCount) ELSE -1 END AS QueueCount,
             CASE WHEN HalfHrCode = @CurrentHalfHrCode THEN SUM(LongestQueueDur) ELSE -1 END AS LongestQueueDur,
             SUM(ContactsOffered) AS ContactsOffered,
             SUM(ContactsQueued) AS ContactsQueued,
             SUM(ContactsHandled) AS ContactsHandled,
             SUM(AbandonCount) AS AbandonCount,
             SUM(AbandonTime) AS AbandonTime,
             SUM(InQueueTime) AS InQueueTime,
             SUM(HoldTime) AS HoldTime,
             SUM(AgentTime) AS AgentTime,
             SUM(PostQueueTime) AS PostQueueTime,
             SUM(ACWTime) AS ACWTime
    FROM     (SELECT HalfHrCode,
                     SkillNo,
                     AgentsloggedIn,
                     AgentsWorking,
                     AgentsIdle,
                     AgentsUnavailable,
                     0 AS In_SLA,
                     0 AS Out_SLA,
                     0 AS QueueCount,
                     0 AS LongestQueueDur,
                     0 AS ContactsOffered,
                     0 AS ContactsQueued,
                     0 AS ContactsHandled,
                     0 AS AbandonCount,
                     0 AS AbandonTime,
                     0 AS InQueueTime,
                     0 AS HoldTime,
                     0 AS AgentTime,
                     0 AS PostQueueTime,
                     0 AS ACWTime
              FROM   #TempAgentSkills
              UNION ALL
              SELECT HalfHrCode,
                     SkillNo,
                     0 AS AgentsloggedIn,
                     0 AS AgentsWorking,
                     0 AS AgentsIdle,
                     0 AS AgentsUnavailable,
                     In_SLA,
                     Out_SLA,
                     0 AS QueueCount,
                     0 AS LongestQueueDur,
                     0 AS ContactsOffered,
                     0 AS ContactsQueued,
                     0 AS ContactsHandled,
                     0 AS AbandonCount,
                     0 AS AbandonTime,
                     0 AS InQueueTime,
                     0 AS HoldTime,
                     0 AS AgentTime,
                     0 AS PostQueueTime,
                     0 AS ACWTime
              FROM   #TempSLA
              UNION ALL
              SELECT HalfHrCode,
                     SkillNo,
                     0 AS AgentsloggedIn,
                     0 AS AgentsWorking,
                     0 AS AgentsIdle,
                     0 AS AgentsUnavailable,
                     0 AS In_SLA,
                     0 AS Out_SLA,
                     QueueCount,
                     LongestQueueDur,
                     0 AS ContactsOffered,
                     0 AS ContactsQueued,
                     0 AS ContactsHandled,
                     0 AS AbandonCount,
                     0 AS AbandonTime,
                     0 AS InQueueTime,
                     0 AS HoldTime,
                     0 AS AgentTime,
                     0 AS PostQueueTime,
                     0 AS ACWTime
              FROM   #TempContactsQueueData
              UNION ALL
              SELECT HalfHrCode,
                     SkillNo,
                     0 AS AgentsloggedIn,
                     0 AS AgentsWorking,
                     0 AS AgentsIdle,
                     0 AS AgentsUnavailable,
                     0 AS In_SLA,
                     0 AS Out_SLA,
                     0 AS QueueCount,
                     0 AS LongestQueueDur,
                     ContactsOffered,
                     ContactsQueued,
                     ContactsHandled,
                     AbandonCount,
                     AbandonTime,
                     InQueueTime,
                     HoldTime,
                     AgentTime,
                     PostQueueTime,
                     ACWTime
              FROM   #TempContacts) AS A
    GROUP BY HalfHrCode, SkillNo)</td>
        <td>283</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1"> TempFinal
AS (SELECT   HalfHrCode,
             SkillNo,
             CASE WHEN HalfHrCode = @CurrentHalfHrCode THEN SUM(AgentsloggedIn) ELSE -1 END AS AgentsloggedIn,
             CASE WHEN HalfHrCode = @CurrentHalfHrCode THEN SUM(AgentsWorking) ELSE -1 END AS AgentsWorking,
             CASE WHEN HalfHrCode = @CurrentHalfHrCode THEN SUM(AgentsIdle) ELSE -1 END AS AgentsIdle,
             CASE WHEN HalfHrCode = @CurrentHalfHrCode THEN SUM(AgentsUnavailable) ELSE -1 END AS AgentsUnavailable,
             SUM(In_SLA) AS In_SLA,
             SUM(Out_SLA) AS Out_SLA,
             CASE WHEN HalfHrCode = @CurrentHalfHrCode THEN SUM(QueueCount) ELSE -1 END AS QueueCount,
             CASE WHEN HalfHrCode = @CurrentHalfHrCode THEN SUM(LongestQueueDur) ELSE -1 END AS LongestQueueDur,
             SUM(ContactsOffered) AS ContactsOffered,
             SUM(ContactsQueued) AS ContactsQueued,
             SUM(ContactsHandled) AS ContactsHandled,
             SUM(AbandonCount) AS AbandonCount,
             SUM(AbandonTime) AS AbandonTime,
             SUM(InQueueTime) AS InQueueTime,
             SUM(HoldTime) AS HoldTime,
             SUM(AgentTime) AS AgentTime,
             SUM(PostQueueTime) AS PostQueueTime,
             SUM(ACWTime) AS ACWTime
    FROM     (SELECT HalfHrCode,
                     SkillNo,
                     AgentsloggedIn,
                     AgentsWorking,
                     AgentsIdle,
                     AgentsUnavailable,
                     0 AS In_SLA,
                     0 AS Out_SLA,
                     0 AS QueueCount,
                     0 AS LongestQueueDur,
                     0 AS ContactsOffered,
                     0 AS ContactsQueued,
                     0 AS ContactsHandled,
                     0 AS AbandonCount,
                     0 AS AbandonTime,
                     0 AS InQueueTime,
                     0 AS HoldTime,
                     0 AS AgentTime,
                     0 AS PostQueueTime,
                     0 AS ACWTime
              FROM   #TempAgentSkills
              UNION ALL
              SELECT HalfHrCode,
                     SkillNo,
                     0 AS AgentsloggedIn,
                     0 AS AgentsWorking,
                     0 AS AgentsIdle,
                     0 AS AgentsUnavailable,
                     In_SLA,
                     Out_SLA,
                     0 AS QueueCount,
                     0 AS LongestQueueDur,
                     0 AS ContactsOffered,
                     0 AS ContactsQueued,
                     0 AS ContactsHandled,
                     0 AS AbandonCount,
                     0 AS AbandonTime,
                     0 AS InQueueTime,
                     0 AS HoldTime,
                     0 AS AgentTime,
                     0 AS PostQueueTime,
                     0 AS ACWTime
              FROM   #TempSLA
              UNION ALL
              SELECT HalfHrCode,
                     SkillNo,
                     0 AS AgentsloggedIn,
                     0 AS AgentsWorking,
                     0 AS AgentsIdle,
                     0 AS AgentsUnavailable,
                     0 AS In_SLA,
                     0 AS Out_SLA,
                     QueueCount,
                     LongestQueueDur,
                     0 AS ContactsOffered,
                     0 AS ContactsQueued,
                     0 AS ContactsHandled,
                     0 AS AbandonCount,
                     0 AS AbandonTime,
                     0 AS InQueueTime,
                     0 AS HoldTime,
                     0 AS AgentTime,
                     0 AS PostQueueTime,
                     0 AS ACWTime
              FROM   #TempContactsQueueData
              UNION ALL
              SELECT HalfHrCode,
                     SkillNo,
                     0 AS AgentsloggedIn,
                     0 AS AgentsWorking,
                     0 AS AgentsIdle,
                     0 AS AgentsUnavailable,
                     0 AS In_SLA,
                     0 AS Out_SLA,
                     0 AS QueueCount,
                     0 AS LongestQueueDur,
                     ContactsOffered,
                     ContactsQueued,
                     ContactsHandled,
                     AbandonCount,
                     AbandonTime,
                     InQueueTime,
                     HoldTime,
                     AgentTime,
                     PostQueueTime,
                     ACWTime
              FROM   #TempContacts) AS A
    GROUP BY HalfHrCode, SkillNo)</td>
        <td>283</td>
      </tr>
    </table>
  </body>
</html>