<?xml version="1.0" encoding="utf-8"?>
<html>
  <head>
    <title>Native Compilation Advisor evaluation results for [DWCode].[ExtRep_UnavailableStats]</title>
  </head>
  <body>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 14pt;">
      <b>Native Compilation Advisor evaluation results for [DWCode].[ExtRep_UnavailableStats]</b>
    </p>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 10pt;">
      <b>Report Date/Time:</b>1/1/2018 5:12 PM<br /></p>
    <table border="1" cellpadding="5" cellspacing="0" STYLE="font-family: Verdana, Arial, sans-serif; font-size: 9pt;">
      <tr style="background-color:Silver">
        <th colspan="1" align="center">Transact-SQL Element</th>
        <th align="center">Transact-SQL Code</th>
        <th align="center">Line Number</th>
      </tr>
      <tr valign="top">
        <td colspan="1">SET OPTION ON</td>
        <td colspan="1">SET NOCOUNT ON</td>
        <td>3</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">SELECT INTO</td>
        <td colspan="1">SELECT h.[Agent_Session_ID],
       d.[StateIndex],
       h.[agent_no],
       h.[team_no],
       h.[bus_no],
       d.[start_date],
       st.[IsWorking] AS working,
       st.[IsAvailable] AS available,
       d.[outstate_code],
       s.[duration],
       d.[log_state],
       d.[skill_no],
       (CASE d.[outstate_code] WHEN 0 THEN (CASE st.[AgentStateID] WHEN 0 THEN -1 WHEN 1 THEN 0 WHEN 2 THEN 3 WHEN 3 THEN 1 WHEN 4 THEN 2 WHEN 5 THEN 4 WHEN 6 THEN 3 ELSE st.[AgentStateID] END) ELSE d.[outstate_code] END) AS State_Code
INTO   #dw_agent_log
FROM   [dbo].[Agent_Log_Header] AS h
       LEFT OUTER JOIN
       [dbo].[Agent_Log_Detail] AS d
       ON d.[Agent_Session_ID] = h.[Agent_Session_ID]
       INNER JOIN
       [dbo].[AgentState] AS st
       ON st.[AgentStateID] = d.[AgentStateID]
       LEFT OUTER JOIN
       [dbo].[Agent_Log_Detail_Summary] AS s
       ON s.[Agent_Session_ID] = d.[Agent_Session_ID]
          AND s.[StateIndex] = d.[StateIndex]
WHERE  h.[bus_no] = @Bus_No
       AND h.[start_date] BETWEEN @t_start_date AND @t_end_date
       AND (@team IS NULL
            OR @team LIKE '%,' + CONVERT (NVARCHAR, h.[team_no]) + ',%')
       AND (@agent IS NULL
            OR @agent LIKE '%,' + CONVERT (NVARCHAR, h.[agent_no]) + ',%')
       AND d.[outstate_code] &gt; 0</td>
        <td>28</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">SELECT outstate_code AS state_code,
       description
INTO   #dw_AgentState
FROM   [dbo].[outstates]
WHERE  [bus_no] = @bus_no
       OR [isSystemOutstate] = 1
UNION
SELECT (CASE [AgentStateID] WHEN 0 THEN -1 WHEN 1 THEN 0 WHEN 2 THEN 3 WHEN 3 THEN 1 WHEN 4 THEN 2 WHEN 5 THEN 4 WHEN 6 THEN 3 ELSE [AgentStateID] END),
       [AgentStateName]
FROM   [dbo].[AgentState]</td>
        <td>69</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">CASE</td>
        <td colspan="1">CASE d.[outstate_code] WHEN 0 THEN (CASE st.[AgentStateID] WHEN 0 THEN -1 WHEN 1 THEN 0 WHEN 2 THEN 3 WHEN 3 THEN 1 WHEN 4 THEN 2 WHEN 5 THEN 4 WHEN 6 THEN 3 ELSE st.[AgentStateID] END) ELSE d.[outstate_code] END</td>
        <td>40</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE st.[AgentStateID] WHEN 0 THEN -1 WHEN 1 THEN 0 WHEN 2 THEN 3 WHEN 3 THEN 1 WHEN 4 THEN 2 WHEN 5 THEN 4 WHEN 6 THEN 3 ELSE st.[AgentStateID] END</td>
        <td>40</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE [AgentStateID] WHEN 0 THEN -1 WHEN 1 THEN 0 WHEN 2 THEN 3 WHEN 3 THEN 1 WHEN 4 THEN 2 WHEN 5 THEN 4 WHEN 6 THEN 3 ELSE [AgentStateID] END</td>
        <td>76</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN @team IS NOT NULL THEN t.[team_name] ELSE a.[first_name] + ' ' + a.[last_name] END</td>
        <td>88</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN @team IS NOT NULL THEN t.[Team_No] ELSE a.[Agent_No] END</td>
        <td>91</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN DATEPART(dw, [dbo].[fn_ConvertUTCToTargetTimeZone](l.[start_date], @TimeZone)) = 1 THEN l.[duration] / 1000 ELSE 0 END</td>
        <td>96</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN DATEPART(dw, [dbo].[fn_ConvertUTCToTargetTimeZone](l.[start_date], @TimeZone)) = 2 THEN l.[duration] / 1000 ELSE 0 END</td>
        <td>99</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN DATEPART(dw, [dbo].[fn_ConvertUTCToTargetTimeZone](l.[start_date], @TimeZone)) = 3 THEN l.[duration] / 1000 ELSE 0 END</td>
        <td>102</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN DATEPART(dw, [dbo].[fn_ConvertUTCToTargetTimeZone](l.[start_date], @TimeZone)) = 4 THEN l.[duration] / 1000 ELSE 0 END</td>
        <td>105</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN DATEPART(dw, [dbo].[fn_ConvertUTCToTargetTimeZone](l.[start_date], @TimeZone)) = 5 THEN l.[duration] / 1000 ELSE 0 END</td>
        <td>108</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN DATEPART(dw, [dbo].[fn_ConvertUTCToTargetTimeZone](l.[start_date], @TimeZone)) = 6 THEN l.[duration] / 1000 ELSE 0 END</td>
        <td>111</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN DATEPART(dw, [dbo].[fn_ConvertUTCToTargetTimeZone](l.[start_date], @TimeZone)) = 7 THEN l.[duration] / 1000 ELSE 0 END</td>
        <td>114</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN @team IS NOT NULL THEN t.[team_name] ELSE a.[first_name] + ' ' + a.[last_name] END</td>
        <td>121</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN @team IS NOT NULL THEN t.[Team_No] ELSE a.[Agent_No] END</td>
        <td>124</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">LIKE</td>
        <td colspan="1">@team LIKE '%,' + CONVERT (NVARCHAR, h.[team_no]) + ',%'</td>
        <td>61</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">@agent LIKE '%,' + CONVERT (NVARCHAR, h.[agent_no]) + ',%'</td>
        <td>65</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">One-part names</td>
        <td colspan="1">#dw_agent_log AS l</td>
        <td>117</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#dw_AgentState AS s</td>
        <td>120</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">MAXDOP</td>
        <td colspan="1">MAXDOP 2</td>
        <td>130</td>
      </tr>
    </table>
  </body>
</html>