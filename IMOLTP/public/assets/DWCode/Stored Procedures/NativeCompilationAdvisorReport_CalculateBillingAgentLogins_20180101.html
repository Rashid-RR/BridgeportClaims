<?xml version="1.0" encoding="utf-8"?>
<html>
  <head>
    <title>Native Compilation Advisor evaluation results for [DWCode].[CalculateBillingAgentLogins]</title>
  </head>
  <body>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 14pt;">
      <b>Native Compilation Advisor evaluation results for [DWCode].[CalculateBillingAgentLogins]</b>
    </p>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 10pt;">
      <b>Report Date/Time:</b>1/1/2018 5:11 PM<br /></p>
    <table border="1" cellpadding="5" cellspacing="0" STYLE="font-family: Verdana, Arial, sans-serif; font-size: 9pt;">
      <tr style="background-color:Silver">
        <th colspan="1" align="center">Transact-SQL Element</th>
        <th align="center">Transact-SQL Code</th>
        <th align="center">Line Number</th>
      </tr>
      <tr valign="top">
        <td colspan="1">SET OPTION ON</td>
        <td colspan="1">SET NOCOUNT ON</td>
        <td>3</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">One-part names</td>
        <td colspan="1">#calculationDateRange</td>
        <td>51</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#calculationDateRange AS d</td>
        <td>80</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#BillingStartDates AS bsd</td>
        <td>88</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#BillingStartDates AS bsd</td>
        <td>106</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#Agents AS a</td>
        <td>108</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#Agents AS a</td>
        <td>116</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">SELECT INTO</td>
        <td colspan="1">SELECT b.Bus_No,
       dbo.fn_ConvertTimeZoneToUTC(DATEADD(month, (CASE WHEN DATEPART(day, d.CurrentDate) &lt; b.BillingCycleStartDay THEN -1 ELSE 0 END), CONVERT (DATETIME, CONVERT (NVARCHAR, DATEPART(month, d.CurrentDate)) + '-' + CONVERT (NVARCHAR, b.BillingCycleStartDay) + '-' + CONVERT (NVARCHAR, DATEPART(year, d.CurrentDate)))), 'MOUNTAIN') AS UTCBillingStartDate,
       d.UTCEndCurrentDate,
       d.CurrentDate
INTO   #BillingStartDates
FROM   dbo.Business_Unit AS b CROSS JOIN #calculationDateRange AS d</td>
        <td>66</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">SELECT DISTINCT bsd.CurrentDate,
                bsd.Bus_No,
                a.Agent_No,
                a.IsSupervisor
INTO   #Agents
FROM   #BillingStartDates AS bsd
       INNER JOIN
       dbo.Agent_Station_Log AS a
       ON a.Bus_No = bsd.Bus_No
          AND a.Login_Date BETWEEN bsd.UTCBillingStartDate AND bsd.UTCEndCurrentDate
       INNER JOIN
       dbo.Agents AS ag
       ON a.Agent_No = ag.Agent_No
WHERE  ag.Billable = 1</td>
        <td>83</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">CASE</td>
        <td colspan="1">CASE WHEN DATEPART(day, d.CurrentDate) &lt; b.BillingCycleStartDay THEN -1 ELSE 0 END</td>
        <td>67</td>
      </tr>
      <tr valign="top">
        <td colspan="1">APPLY</td>
        <td colspan="1">#BillingStartDates AS bsd OUTER APPLY (SELECT COUNT(*) AS NonSupervisorCount
                                       FROM   (SELECT   a.Agent_No
                                               FROM     #Agents AS a
                                               WHERE    a.Bus_No = bsd.Bus_No
                                                        AND a.CurrentDate = bsd.CurrentDate
                                               GROUP BY a.Agent_No
                                               HAVING   SUM(CONVERT (INT, a.IsSupervisor)) = 0) AS a) AS a OUTER APPLY (SELECT Count(a.Agent_No) AS SupervisorCount
                                                                                                                        FROM   #Agents AS a
                                                                                                                        WHERE  a.Bus_No = bsd.Bus_No
                                                                                                                               AND a.CurrentDate = bsd.CurrentDate
                                                                                                                               AND a.IsSupervisor = 1) AS b</td>
        <td>106</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#BillingStartDates AS bsd OUTER APPLY (SELECT COUNT(*) AS NonSupervisorCount
                                       FROM   (SELECT   a.Agent_No
                                               FROM     #Agents AS a
                                               WHERE    a.Bus_No = bsd.Bus_No
                                                        AND a.CurrentDate = bsd.CurrentDate
                                               GROUP BY a.Agent_No
                                               HAVING   SUM(CONVERT (INT, a.IsSupervisor)) = 0) AS a) AS a</td>
        <td>106</td>
      </tr>
    </table>
  </body>
</html>