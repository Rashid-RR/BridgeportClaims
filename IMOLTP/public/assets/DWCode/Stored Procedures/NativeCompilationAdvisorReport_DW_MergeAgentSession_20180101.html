<?xml version="1.0" encoding="utf-8"?>
<html>
  <head>
    <title>Native Compilation Advisor evaluation results for [DWCode].[DW_MergeAgentSession]</title>
  </head>
  <body>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 14pt;">
      <b>Native Compilation Advisor evaluation results for [DWCode].[DW_MergeAgentSession]</b>
    </p>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 10pt;">
      <b>Report Date/Time:</b>1/1/2018 5:10 PM<br /></p>
    <table border="1" cellpadding="5" cellspacing="0" STYLE="font-family: Verdana, Arial, sans-serif; font-size: 9pt;">
      <tr style="background-color:Silver">
        <th colspan="1" align="center">Transact-SQL Element</th>
        <th align="center">Transact-SQL Code</th>
        <th align="center">Line Number</th>
      </tr>
      <tr valign="top">
        <td colspan="1">SET OPTION ON</td>
        <td colspan="1">SET NOCOUNT ON</td>
        <td>2</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">SET XACT_ABORT ON</td>
        <td>3</td>
      </tr>
      <tr valign="top">
        <td colspan="1">MERGE</td>
        <td colspan="1">MERGE INTO [dbo].[Agent_Session]
 AS target
USING (SELECT session_id,
              bus_no,
              agent_no,
              expire_dt,
              ip
       FROM   (SELECT session_id,
                      bus_no,
                      agent_no,
                      expire_dt,
                      ip,
                      ROW_NUMBER() OVER (PARTITION BY session_id ORDER BY session_id) AS RowNum
               FROM   [ETL].[Agent_Session]) AS dup
       WHERE  dup.RowNum = 1) AS source ON (target.session_id = source.session_id)
WHEN MATCHED AND (CASE WHEN target.bus_no = source.bus_no
                            OR target.bus_no IS NULL
                               AND source.bus_no IS NULL THEN 0 END IS NULL
                  OR CASE WHEN target.agent_no = source.agent_no
                               OR target.agent_no IS NULL
                                  AND source.agent_no IS NULL THEN 0 END IS NULL
                  OR target.expire_dt != source.expire_dt
                  OR CASE WHEN target.ip = source.ip
                               OR target.ip IS NULL
                                  AND source.ip IS NULL THEN 0 END IS NULL) THEN UPDATE 
SET bus_no    = source.bus_no,
    agent_no  = source.agent_no,
    expire_dt = source.expire_dt,
    ip        = source.ip
WHEN NOT MATCHED THEN INSERT (session_id, bus_no, agent_no, expire_dt, ip) VALUES (source.session_id, source.bus_no, source.agent_no, source.expire_dt, source.ip)
WHEN NOT MATCHED BY SOURCE THEN DELETE</td>
        <td>5</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">MERGE INTO [dbo].[Agent_Session]
 AS target
USING (SELECT session_id,
              bus_no,
              agent_no,
              expire_dt,
              ip
       FROM   (SELECT session_id,
                      bus_no,
                      agent_no,
                      expire_dt,
                      ip,
                      ROW_NUMBER() OVER (PARTITION BY session_id ORDER BY session_id) AS RowNum
               FROM   [ETL].[Agent_Session]) AS dup
       WHERE  dup.RowNum = 1) AS source ON (target.session_id = source.session_id)
WHEN MATCHED AND (CASE WHEN target.bus_no = source.bus_no
                            OR target.bus_no IS NULL
                               AND source.bus_no IS NULL THEN 0 END IS NULL
                  OR CASE WHEN target.agent_no = source.agent_no
                               OR target.agent_no IS NULL
                                  AND source.agent_no IS NULL THEN 0 END IS NULL
                  OR target.expire_dt != source.expire_dt
                  OR CASE WHEN target.ip = source.ip
                               OR target.ip IS NULL
                                  AND source.ip IS NULL THEN 0 END IS NULL) THEN UPDATE 
SET bus_no    = source.bus_no,
    agent_no  = source.agent_no,
    expire_dt = source.expire_dt,
    ip        = source.ip
WHEN NOT MATCHED THEN INSERT (session_id, bus_no, agent_no, expire_dt, ip) VALUES (source.session_id, source.bus_no, source.agent_no, source.expire_dt, source.ip)
WHEN NOT MATCHED BY SOURCE THEN DELETE</td>
        <td>5</td>
      </tr>
      <tr valign="top">
        <td colspan="1">ROW_NUMBER</td>
        <td colspan="1">ROW_NUMBER() OVER (PARTITION BY session_id ORDER BY session_id)</td>
        <td>22</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">OVER</td>
        <td colspan="1">OVER (PARTITION BY session_id ORDER BY session_id)</td>
        <td>22</td>
      </tr>
      <tr valign="top">
        <td colspan="1">CASE</td>
        <td colspan="1">CASE WHEN target.bus_no = source.bus_no
          OR target.bus_no IS NULL
             AND source.bus_no IS NULL THEN 0 END</td>
        <td>35</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN target.agent_no = source.agent_no
          OR target.agent_no IS NULL
             AND source.agent_no IS NULL THEN 0 END</td>
        <td>36</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN target.ip = source.ip
          OR target.ip IS NULL
             AND source.ip IS NULL THEN 0 END</td>
        <td>38</td>
      </tr>
    </table>
  </body>
</html>