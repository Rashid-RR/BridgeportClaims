<?xml version="1.0" encoding="utf-8"?>
<html>
  <head>
    <title>Native Compilation Advisor evaluation results for [DWCode].[CallDetail_Envigo_Comp_wDisp_wAdjAbandon]</title>
  </head>
  <body>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 14pt;">
      <b>Native Compilation Advisor evaluation results for [DWCode].[CallDetail_Envigo_Comp_wDisp_wAdjAbandon]</b>
    </p>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 10pt;">
      <b>Report Date/Time:</b>1/1/2018 5:10 PM<br /></p>
    <table border="1" cellpadding="5" cellspacing="0" STYLE="font-family: Verdana, Arial, sans-serif; font-size: 9pt;">
      <tr style="background-color:Silver">
        <th colspan="1" align="center">Transact-SQL Element</th>
        <th align="center">Transact-SQL Code</th>
        <th align="center">Line Number</th>
      </tr>
      <tr valign="top">
        <td colspan="1">SET OPTION ON</td>
        <td colspan="1">SET NOCOUNT ON</td>
        <td>1</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">SET XACT_ABORT ON</td>
        <td>2</td>
      </tr>
      <tr valign="top">
        <td colspan="1">BEGIN TRANSACTION</td>
        <td colspan="1">BEGIN TRANSACTION</td>
        <td>11</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">One-part names</td>
        <td colspan="1">EXECUTE LockCriticalSection @busno_str</td>
        <td>15</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">Contact_Log_Summary</td>
        <td>104</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">contact_log_Tags AS ST1</td>
        <td>113</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">tags AS t</td>
        <td>114</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">contact_log_Tags AS ST2</td>
        <td>119</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">agg AS agg</td>
        <td>121</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#TmpCCL AS ccl</td>
        <td>122</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#Contacts AS c</td>
        <td>137</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#Contacts AS c</td>
        <td>151</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#ContactLogLastDisposition AS clld</td>
        <td>152</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#Contacts AS c</td>
        <td>231</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#ContactLogDisposition AS cld</td>
        <td>238</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">SELECT INTO</td>
        <td colspan="1">SELECT contact_id,
       data_name,
       data_value
INTO   #tmpCCL
FROM   dbo.custom_contact_log
WHERE  Bus_No = @p_Bus_no
       AND Start_Date BETWEEN @p_UTCStart_Date AND @p_UTCEnd_Date
       AND data_name = 'vmreceived'
       AND data_value = 'TRUE'</td>
        <td>41</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">WITH     agg
AS       (SELECT   Contact_ID,
                   ISNULL(CAST (ROUND(SUM(CASE WHEN cs.category1 = 'PreQueue' THEN Duration END) / 1000.0, 0) AS INT), 0) AS prequeue,
                   ISNULL(CAST (ROUND(SUM(CASE WHEN cs.category1 = 'InQueue' THEN Duration END) / 1000.0, 0) AS INT), 0) AS inqueue,
                   ISNULL(CAST (ROUND(SUM(CASE WHEN cs.contact_State = 2 THEN Duration END) / 1000.0, 0) AS INT), 0) AS routing,
                   ISNULL(CAST (ROUND(SUM(CASE WHEN cs.category1 = 'Agent' THEN Duration END) / 1000.0, 0) AS INT), 0) AS agent,
                   ISNULL(CAST (ROUND(SUM(CASE WHEN cs.category1 = 'PostQueue' THEN Duration END) / 1000.0, 0) AS INT), 0) AS postqueue,
                   ISNULL(CAST (ROUND(SUM(CASE WHEN cs.contact_State = 15 THEN Duration END) / 1000.0, 0) AS INT), 0) AS callback,
                   ISNULL(CAST (ROUND(SUM(CASE WHEN cs.contact_State = 8 THEN Duration END) / 1000.0, 0) AS INT), 0) AS hold
          FROM     dbo.Contact_Log_DetailQV AS qv
                   INNER JOIN
                   dbo.Contact_State AS cs
                   ON qv.Contact_State = cs.Contact_state
          WHERE    bus_no = @p_Bus_no
                   AND StartDate BETWEEN @p_Start_Date AND @p_End_Date
          GROUP BY contact_ID)
SELECT   clh.Contact_ID,
         clh.Master_Contact_ID,
         dbo.fn_ConvertUTCToTargetTimeZone(clh.[Start_Date], @p_TimeZone) AS [Start_Date],
         clh.Contact_Code,
         REPLACE(REPLACE(REPLACE(clf.To_Addr, CHAR(13), ''), CHAR(10), ''), CHAR(9), '') AS To_Addr,
         REPLACE(REPLACE(REPLACE(clf.From_Addr, CHAR(13), ''), CHAR(10), ''), CHAR(9), '') AS From_Addr,
         clf.Agent_No,
         clf.Skill_No,
         clf.Abandon,
         CASE WHEN clf.Abandon = 'Y'
                   AND ccl.data_name = 'vmreceived'
                   AND ccl.data_value = 'TRUE' THEN 'N' ELSE clf.Abandon END AS Adj_Abandon,
         ISNULL(cls.SLA, 0) AS SLA,
         CASE WHEN clf.Abandon = 'Y'
                   AND ccl.data_name = 'vmreceived'
                   AND ccl.data_value = 'TRUE' THEN '0' ELSE ISNULL(cls.SLA, 0) END AS Adj_SLA,
         prequeue AS Prequeue_Time,
         inqueue AS Inqueue_Time,
         routing AS Routing_Time,
         agent AS Agent_Time,
         postqueue AS Postqueue_Time,
         callback AS Callback_Time,
         ISNULL(cls.ACW_Time, 0) AS ACW_Time,
         hold AS Hold_Time,
         ISNULL(cls.Abandon_Seconds, 0) AS Abandon_Time,
         CASE WHEN clf.Abandon = 'Y'
                   AND ccl.data_name = 'vmreceived'
                   AND ccl.data_value = 'TRUE' THEN 0 ELSE ISNULL(cls.Abandon_Seconds, 0) END AS Adj_Abandon_Time,
         CASE WHEN ccl.data_name = 'vmreceived'
                   AND ccl.data_value = 'TRUE' THEN 'Y' ELSE 'N' END AS VM_Received,
         Tags
INTO     #Contacts
FROM     dbo.Contact_Log_Header AS clh
         INNER JOIN
         dbo.Contact_Log_Footer AS clf
         ON clf.Contact_ID = clh.Contact_ID
         LEFT OUTER JOIN
         (SELECT contact_ID,
                 sla,
                 acw_Time / 1000 AS ACW_Time,
                 Abandon_Seconds
          FROM   Contact_Log_Summary
          WHERE  bus_no = @p_Bus_no
                 AND header_start_date BETWEEN @p_summary_start_date AND @p_summary_end_date) AS cls
         ON cls.Contact_ID = clh.Contact_ID
         LEFT OUTER JOIN
         (SELECT DISTINCT ST2.Contact_ID,
                          STUFF((SELECT   ',' + t.name AS [text()]
                                 FROM     contact_log_Tags AS ST1
                                          LEFT OUTER JOIN
                                          tags AS t
                                          ON t.TagID = ST1.TagID
                                 WHERE    ST1.Contact_ID = ST2.Contact_ID
                                 ORDER BY ST1.Contact_ID
                                 FOR      XML PATH ('')), 1, 1, '') AS [Tags]
          FROM   contact_log_Tags AS ST2) AS contactTag
         ON clh.Contact_ID = contactTag.Contact_ID
         INNER JOIN
         agg AS agg
         ON clh.Contact_ID = agg.Contact_ID
         LEFT OUTER JOIN
         #TmpCCL AS ccl
         ON ccl.contact_ID = clh.contact_ID
WHERE    clh.Bus_No = @p_Bus_no
         AND clh.Start_Date BETWEEN @p_Start_Date AND @p_End_Date
ORDER BY clh.Contact_ID
OPTION (OPTIMIZE FOR (@p_Start_Date = '2/1/2016', @p_End_Date = '2/2/2016'))</td>
        <td>54</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">SELECT   c.Contact_ID,
         MAX(clds.[Start_Date]) AS [Start_Date]
INTO     #ContactLogLastDisposition
FROM     #Contacts AS c
         LEFT OUTER JOIN
         dbo.Contact_Log_Dispositions AS clds
         ON clds.Contact_ID = c.Contact_ID
GROUP BY c.Contact_ID</td>
        <td>134</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">SELECT c.Contact_ID,
       d.[Description],
       clds.Disposition_Comments,
       clds.Disposition_Code
INTO   #ContactLogDisposition
FROM   #Contacts AS c
       LEFT OUTER JOIN
       #ContactLogLastDisposition AS clld
       ON clld.Contact_ID = c.Contact_ID
       LEFT OUTER JOIN
       dbo.Contact_Log_Dispositions AS clds
       ON clds.Contact_ID = clld.Contact_ID
          AND clds.[Start_Date] = clld.[Start_Date]
       INNER JOIN
       dbo.Dispositions AS d
       ON d.Disposition_Code = clds.Disposition_Code</td>
        <td>146</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">REPLACE</td>
        <td colspan="1">REPLACE(REPLACE(REPLACE(clf.To_Addr, CHAR(13), ''), CHAR(10), ''), CHAR(9), '')</td>
        <td>74</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">REPLACE(REPLACE(clf.To_Addr, CHAR(13), ''), CHAR(10), '')</td>
        <td>74</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">REPLACE(clf.To_Addr, CHAR(13), '')</td>
        <td>74</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">REPLACE(REPLACE(REPLACE(clf.From_Addr, CHAR(13), ''), CHAR(10), ''), CHAR(9), '')</td>
        <td>75</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">REPLACE(REPLACE(clf.From_Addr, CHAR(13), ''), CHAR(10), '')</td>
        <td>75</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">REPLACE(clf.From_Addr, CHAR(13), '')</td>
        <td>75</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">CHAR</td>
        <td colspan="1">CHAR(13)</td>
        <td>74</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CHAR(10)</td>
        <td>74</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CHAR(9)</td>
        <td>74</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CHAR(13)</td>
        <td>75</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CHAR(10)</td>
        <td>75</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CHAR(9)</td>
        <td>75</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">CASE</td>
        <td colspan="1">CASE WHEN clf.Abandon = 'Y'
          AND ccl.data_name = 'vmreceived'
          AND ccl.data_value = 'TRUE' THEN 'N' ELSE clf.Abandon END</td>
        <td>79</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN clf.Abandon = 'Y'
          AND ccl.data_name = 'vmreceived'
          AND ccl.data_value = 'TRUE' THEN '0' ELSE ISNULL(cls.SLA, 0) END</td>
        <td>81</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN clf.Abandon = 'Y'
          AND ccl.data_name = 'vmreceived'
          AND ccl.data_value = 'TRUE' THEN 0 ELSE ISNULL(cls.Abandon_Seconds, 0) END</td>
        <td>91</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN ccl.data_name = 'vmreceived'
          AND ccl.data_value = 'TRUE' THEN 'Y' ELSE 'N' END</td>
        <td>92</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN cs.category1 = 'PreQueue' THEN Duration END</td>
        <td>55</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN cs.category1 = 'InQueue' THEN Duration END</td>
        <td>56</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN cs.contact_State = 2 THEN Duration END</td>
        <td>57</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN cs.category1 = 'Agent' THEN Duration END</td>
        <td>58</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN cs.category1 = 'PostQueue' THEN Duration END</td>
        <td>59</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN cs.contact_State = 15 THEN Duration END</td>
        <td>60</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN cs.contact_State = 8 THEN Duration END</td>
        <td>61</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN s.Outbound_Skill = 1 THEN c.To_Addr ELSE c.From_Addr END</td>
        <td>199</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN (clg.contact_id IS NOT NULL) THEN 'Y' ELSE 'N' END</td>
        <td>225</td>
      </tr>
      <tr valign="top">
        <td colspan="1">STUFF</td>
        <td colspan="1">STUFF((SELECT   ',' + t.name AS [text()]
       FROM     contact_log_Tags AS ST1
                LEFT OUTER JOIN
                tags AS t
                ON t.TagID = ST1.TagID
       WHERE    ST1.Contact_ID = ST2.Contact_ID
       ORDER BY ST1.Contact_ID
       FOR      XML PATH ('')), 1, 1, '')</td>
        <td>111</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">FOR XML</td>
        <td colspan="1">XML PATH ('')</td>
        <td>117</td>
      </tr>
      <tr valign="top">
        <td colspan="1">WITH clause</td>
        <td colspan="1">WITH agg
AS (SELECT   Contact_ID,
             ISNULL(CAST (ROUND(SUM(CASE WHEN cs.category1 = 'PreQueue' THEN Duration END) / 1000.0, 0) AS INT), 0) AS prequeue,
             ISNULL(CAST (ROUND(SUM(CASE WHEN cs.category1 = 'InQueue' THEN Duration END) / 1000.0, 0) AS INT), 0) AS inqueue,
             ISNULL(CAST (ROUND(SUM(CASE WHEN cs.contact_State = 2 THEN Duration END) / 1000.0, 0) AS INT), 0) AS routing,
             ISNULL(CAST (ROUND(SUM(CASE WHEN cs.category1 = 'Agent' THEN Duration END) / 1000.0, 0) AS INT), 0) AS agent,
             ISNULL(CAST (ROUND(SUM(CASE WHEN cs.category1 = 'PostQueue' THEN Duration END) / 1000.0, 0) AS INT), 0) AS postqueue,
             ISNULL(CAST (ROUND(SUM(CASE WHEN cs.contact_State = 15 THEN Duration END) / 1000.0, 0) AS INT), 0) AS callback,
             ISNULL(CAST (ROUND(SUM(CASE WHEN cs.contact_State = 8 THEN Duration END) / 1000.0, 0) AS INT), 0) AS hold
    FROM     dbo.Contact_Log_DetailQV AS qv
             INNER JOIN
             dbo.Contact_State AS cs
             ON qv.Contact_State = cs.Contact_state
    WHERE    bus_no = @p_Bus_no
             AND StartDate BETWEEN @p_Start_Date AND @p_End_Date
    GROUP BY contact_ID)</td>
        <td>54</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1"> agg
AS (SELECT   Contact_ID,
             ISNULL(CAST (ROUND(SUM(CASE WHEN cs.category1 = 'PreQueue' THEN Duration END) / 1000.0, 0) AS INT), 0) AS prequeue,
             ISNULL(CAST (ROUND(SUM(CASE WHEN cs.category1 = 'InQueue' THEN Duration END) / 1000.0, 0) AS INT), 0) AS inqueue,
             ISNULL(CAST (ROUND(SUM(CASE WHEN cs.contact_State = 2 THEN Duration END) / 1000.0, 0) AS INT), 0) AS routing,
             ISNULL(CAST (ROUND(SUM(CASE WHEN cs.category1 = 'Agent' THEN Duration END) / 1000.0, 0) AS INT), 0) AS agent,
             ISNULL(CAST (ROUND(SUM(CASE WHEN cs.category1 = 'PostQueue' THEN Duration END) / 1000.0, 0) AS INT), 0) AS postqueue,
             ISNULL(CAST (ROUND(SUM(CASE WHEN cs.contact_State = 15 THEN Duration END) / 1000.0, 0) AS INT), 0) AS callback,
             ISNULL(CAST (ROUND(SUM(CASE WHEN cs.contact_State = 8 THEN Duration END) / 1000.0, 0) AS INT), 0) AS hold
    FROM     dbo.Contact_Log_DetailQV AS qv
             INNER JOIN
             dbo.Contact_State AS cs
             ON qv.Contact_State = cs.Contact_state
    WHERE    bus_no = @p_Bus_no
             AND StartDate BETWEEN @p_Start_Date AND @p_End_Date
    GROUP BY contact_ID)</td>
        <td>54</td>
      </tr>
      <tr valign="top">
        <td colspan="1">COMMIT TRANSACTION</td>
        <td colspan="1">COMMIT TRANSACTION</td>
        <td>246</td>
      </tr>
    </table>
  </body>
</html>