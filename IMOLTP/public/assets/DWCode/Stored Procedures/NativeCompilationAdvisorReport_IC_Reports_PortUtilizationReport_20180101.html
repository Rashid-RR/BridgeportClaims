<?xml version="1.0" encoding="utf-8"?>
<html>
  <head>
    <title>Native Compilation Advisor evaluation results for [DWCode].[IC_Reports_PortUtilizationReport]</title>
  </head>
  <body>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 14pt;">
      <b>Native Compilation Advisor evaluation results for [DWCode].[IC_Reports_PortUtilizationReport]</b>
    </p>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 10pt;">
      <b>Report Date/Time:</b>1/1/2018 5:10 PM<br /></p>
    <table border="1" cellpadding="5" cellspacing="0" STYLE="font-family: Verdana, Arial, sans-serif; font-size: 9pt;">
      <tr style="background-color:Silver">
        <th colspan="1" align="center">Transact-SQL Element</th>
        <th align="center">Transact-SQL Code</th>
        <th align="center">Line Number</th>
      </tr>
      <tr valign="top">
        <td colspan="1">SET OPTION ON</td>
        <td colspan="1">SET NOCOUNT ON</td>
        <td>2</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">SELECT INTO</td>
        <td colspan="1">SELECT IDMin,
       IDMax
INTO   #SkillNoList
FROM   dbo.fn_SplitOptionalInt(@SkillNoList)</td>
        <td>11</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">SELECT DISTINCT s.Bus_No,
                s.Skill_No,
                s.Skill_Name
INTO   #FilteredSkillTable
FROM   [dbo].[Skills] AS s
       INNER JOIN
       #SkillNoList AS SNL
       ON s.Skill_No BETWEEN SNL.IDMin AND SNL.IDMax
       INNER JOIN
       dbo.AutoOutboundSkillSettings AS aos
       ON s.Skill_No = aos.Skill_No
WHERE  s.Bus_No = @busNo
       AND s.Status = 'CURR'
       AND s.IsNaturalCalling = 1</td>
        <td>26</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">WITH     tbl
AS       (SELECT DISTINCT aod.Skill_No,
                          CASE WHEN aod.StartDate &gt; @startDate THEN aod.StartDate ELSE @startDate END AS StartDate,
                          CASE WHEN aod.StopDate &lt; @endDate THEN aod.StartDate ELSE @endDate END AS StopDate,
                          aod.Agent_No
          FROM   [dbo].[AgentOutboundDetail] AS aod
                 INNER JOIN
                 #FilteredSkillTable AS s
                 ON s.Skill_No = aod.Skill_No
          WHERE  aod.Bus_No = @busNo
                 AND aod.StartDate &lt;= @endDate
                 AND aod.StopDate &gt;= @startDate)
SELECT   tbl.Skill_No,
         dbo.fn_CalcQtrHourDateTime(aodqh.StartDateInterval) AS startDateBucket,
         COUNT(DISTINCT Agent_No) AS AgentsOutbound
INTO     #AgentsOutbound
FROM     tbl CROSS APPLY dbo.SplitDatesToIntervals(tbl.StartDate, tbl.StopDate, DEFAULT, DEFAULT) AS aodqh
GROUP BY tbl.Skill_No, dbo.fn_CalcQtrHourDateTime(aodqh.StartDateInterval)</td>
        <td>40</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">WITH     tbl
AS       (SELECT odr.Skill_No,
                 odr.DispositionClassificationId,
                 CASE WHEN odr.TimeInitiated &gt; @startDate THEN odr.TimeInitiated ELSE @startDate END AS StartDate,
                 CASE WHEN odr.TimeDisposed IS NOT NULL
                           AND odr.TimeDisposed &lt; @endDate THEN odr.TimeDisposed ELSE @endDate END AS StopDate
          FROM   OutboundDetailRecords AS odr
                 INNER JOIN
                 #FilteredSkillTable AS s
                 ON s.Skill_No = odr.Skill_No
          WHERE  odr.Bus_No = @busNo
                 AND odr.TimeInitiated IS NOT NULL
                 AND odr.TimeInitiated &lt;= @endDate
                 AND ISNULL(odr.TimeDisposed, @startDate) &gt;= @startDate)
SELECT   Skill_No,
         dbo.fn_CalcQtrHourDateTime(odrqh.StartDateInterval) AS startDateBucket,
         SUM(CASE WHEN tbl.DispositionClassificationId = 39 THEN 1 ELSE 0 END) AS NoPorts,
         COUNT(tbl.DispositionClassificationId) AS Total
INTO     #PortsUsed
FROM     tbl CROSS APPLY dbo.SplitDatesToIntervals(tbl.StartDate, tbl.StopDate, DEFAULT, DEFAULT) AS odrqh
GROUP BY tbl.Skill_No, dbo.fn_CalcQtrHourDateTime(odrqh.StartDateInterval)</td>
        <td>64</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">SELECT   startDateBucket,
         SUM(AgentsOutbound) AS AgentsOutbound,
         SUM(NoPorts) AS NoPorts,
         SUM(Total) AS Total,
         CASE WHEN SUM(Total) &lt;&gt; 0 THEN (SUM(NoPorts) / SUM(Total) * 100) ELSE 0 END AS PercentOfTotal,
         (SELECT skill_name
          FROM   #FilteredSkillTable AS t
          WHERE  t.skill_no = x.skill_no) AS SkillName
INTO     #temporal
FROM     (SELECT ao.startDateBucket,
                 ao.skill_no,
                 ao.AgentsOutbound,
                 0 AS Presented,
                 0 AS HandledCalls,
                 0 AS NoPorts,
                 0 AS Total,
                 0 AS Attempted
          FROM   #AgentsOutbound AS ao
          UNION ALL
          SELECT startDateBucket,
                 Skill_No,
                 0 AS AgentsOutbound,
                 0 AS Presented,
                 0 AS HandledCalls,
                 NoPorts,
                 Total,
                 0 AS Attempted
          FROM   #PortsUsed) AS x
GROUP BY startDateBucket, x.skill_no</td>
        <td>90</td>
      </tr>
      <tr valign="top">
        <td colspan="1">Table-valued functions</td>
        <td colspan="1">dbo.fn_SplitOptionalInt(@SkillNoList)</td>
        <td>15</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">dbo.SplitDatesToIntervals(tbl.StartDate, tbl.StopDate, DEFAULT, DEFAULT) AS aodqh</td>
        <td>57</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">dbo.SplitDatesToIntervals(tbl.StartDate, tbl.StopDate, DEFAULT, DEFAULT) AS odrqh</td>
        <td>83</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">One-part names</td>
        <td colspan="1">#SkillNoList AS SNL</td>
        <td>32</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">tbl</td>
        <td>56</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#FilteredSkillTable AS s</td>
        <td>47</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">tbl</td>
        <td>82</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">OutboundDetailRecords AS odr</td>
        <td>70</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#FilteredSkillTable AS s</td>
        <td>71</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#FilteredSkillTable AS t</td>
        <td>97</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#AgentsOutbound AS ao</td>
        <td>111</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#PortsUsed</td>
        <td>124</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#temporal AS t</td>
        <td>142</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#temporal AS x</td>
        <td>146</td>
      </tr>
      <tr valign="top">
        <td colspan="1">DISTINCT</td>
        <td colspan="1">COUNT(DISTINCT Agent_No)</td>
        <td>54</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">APPLY</td>
        <td colspan="1">tbl CROSS APPLY dbo.SplitDatesToIntervals(tbl.StartDate, tbl.StopDate, DEFAULT, DEFAULT) AS aodqh</td>
        <td>56</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">tbl CROSS APPLY dbo.SplitDatesToIntervals(tbl.StartDate, tbl.StopDate, DEFAULT, DEFAULT) AS odrqh</td>
        <td>82</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">WITH clause</td>
        <td colspan="1">WITH tbl
AS (SELECT DISTINCT aod.Skill_No,
                    CASE WHEN aod.StartDate &gt; @startDate THEN aod.StartDate ELSE @startDate END AS StartDate,
                    CASE WHEN aod.StopDate &lt; @endDate THEN aod.StartDate ELSE @endDate END AS StopDate,
                    aod.Agent_No
    FROM   [dbo].[AgentOutboundDetail] AS aod
           INNER JOIN
           #FilteredSkillTable AS s
           ON s.Skill_No = aod.Skill_No
    WHERE  aod.Bus_No = @busNo
           AND aod.StartDate &lt;= @endDate
           AND aod.StopDate &gt;= @startDate)</td>
        <td>40</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1"> tbl
AS (SELECT DISTINCT aod.Skill_No,
                    CASE WHEN aod.StartDate &gt; @startDate THEN aod.StartDate ELSE @startDate END AS StartDate,
                    CASE WHEN aod.StopDate &lt; @endDate THEN aod.StartDate ELSE @endDate END AS StopDate,
                    aod.Agent_No
    FROM   [dbo].[AgentOutboundDetail] AS aod
           INNER JOIN
           #FilteredSkillTable AS s
           ON s.Skill_No = aod.Skill_No
    WHERE  aod.Bus_No = @busNo
           AND aod.StartDate &lt;= @endDate
           AND aod.StopDate &gt;= @startDate)</td>
        <td>40</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">WITH tbl
AS (SELECT odr.Skill_No,
           odr.DispositionClassificationId,
           CASE WHEN odr.TimeInitiated &gt; @startDate THEN odr.TimeInitiated ELSE @startDate END AS StartDate,
           CASE WHEN odr.TimeDisposed IS NOT NULL
                     AND odr.TimeDisposed &lt; @endDate THEN odr.TimeDisposed ELSE @endDate END AS StopDate
    FROM   OutboundDetailRecords AS odr
           INNER JOIN
           #FilteredSkillTable AS s
           ON s.Skill_No = odr.Skill_No
    WHERE  odr.Bus_No = @busNo
           AND odr.TimeInitiated IS NOT NULL
           AND odr.TimeInitiated &lt;= @endDate
           AND ISNULL(odr.TimeDisposed, @startDate) &gt;= @startDate)</td>
        <td>64</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1"> tbl
AS (SELECT odr.Skill_No,
           odr.DispositionClassificationId,
           CASE WHEN odr.TimeInitiated &gt; @startDate THEN odr.TimeInitiated ELSE @startDate END AS StartDate,
           CASE WHEN odr.TimeDisposed IS NOT NULL
                     AND odr.TimeDisposed &lt; @endDate THEN odr.TimeDisposed ELSE @endDate END AS StopDate
    FROM   OutboundDetailRecords AS odr
           INNER JOIN
           #FilteredSkillTable AS s
           ON s.Skill_No = odr.Skill_No
    WHERE  odr.Bus_No = @busNo
           AND odr.TimeInitiated IS NOT NULL
           AND odr.TimeInitiated &lt;= @endDate
           AND ISNULL(odr.TimeDisposed, @startDate) &gt;= @startDate)</td>
        <td>64</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">CASE</td>
        <td colspan="1">CASE WHEN aod.StartDate &gt; @startDate THEN aod.StartDate ELSE @startDate END</td>
        <td>43</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN aod.StopDate &lt; @endDate THEN aod.StartDate ELSE @endDate END</td>
        <td>44</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN tbl.DispositionClassificationId = 39 THEN 1 ELSE 0 END</td>
        <td>79</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN odr.TimeInitiated &gt; @startDate THEN odr.TimeInitiated ELSE @startDate END</td>
        <td>68</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN odr.TimeDisposed IS NOT NULL
          AND odr.TimeDisposed &lt; @endDate THEN odr.TimeDisposed ELSE @endDate END</td>
        <td>69</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN SUM(Total) &lt;&gt; 0 THEN (SUM(NoPorts) / SUM(Total) * 100) ELSE 0 END</td>
        <td>95</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN SUM(Total) &lt;&gt; 0 THEN 100 * SUM(NoPorts) / SUM(Total) ELSE 0 END</td>
        <td>139</td>
      </tr>
      <tr valign="top">
        <td colspan="1">STUFF</td>
        <td colspan="1">STUFF((SELECT ', ' + CAST (t.SkillName AS VARCHAR (30))
       FROM   #temporal AS t
       WHERE  (t.startDateBucket = x.startDateBucket)
       FOR    XML PATH (''), TYPE).value('(./text())[1]', 'VARCHAR(MAX)'), 1, 2, '')</td>
        <td>140</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">FOR XML</td>
        <td colspan="1">XML PATH (''), TYPE</td>
        <td>144</td>
      </tr>
    </table>
  </body>
</html>