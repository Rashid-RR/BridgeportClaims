<?xml version="1.0" encoding="utf-8"?>
<html>
  <head>
    <title>Native Compilation Advisor evaluation results for [DWCode].[IC_Reports_AgentUnavailableTime]</title>
  </head>
  <body>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 14pt;">
      <b>Native Compilation Advisor evaluation results for [DWCode].[IC_Reports_AgentUnavailableTime]</b>
    </p>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 10pt;">
      <b>Report Date/Time:</b>1/1/2018 5:10 PM<br /></p>
    <table border="1" cellpadding="5" cellspacing="0" STYLE="font-family: Verdana, Arial, sans-serif; font-size: 9pt;">
      <tr style="background-color:Silver">
        <th colspan="1" align="center">Transact-SQL Element</th>
        <th align="center">Transact-SQL Code</th>
        <th align="center">Line Number</th>
      </tr>
      <tr valign="top">
        <td colspan="1">SET OPTION ON</td>
        <td colspan="1">SET NOCOUNT ON</td>
        <td>2</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">SELECT INTO</td>
        <td colspan="1">SELECT outstate_code AS state_code,
       description AS StateDescription,
       CASE WHEN IsSystemOutstate = 1 THEN 1 WHEN (IsSystemOutstate = 0
                                                   AND IsACW = 'T') THEN 2 ELSE 3 END AS OutstateType
INTO   #temp_AgentState
FROM   dbo.Outstates
WHERE  bus_no = @bus_no
       OR IsSystemOutstate = 1</td>
        <td>14</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">SELECT DISTINCT ald.agent_No,
                ald.StartDate,
                ald.AgentStateID,
                ald.Outstate_Code,
                a.first_name,
                a.last_name,
                CASE WHEN ald.AgentStateID = 0 THEN 'Logged Out' WHEN ald.AgentStateID = 8 THEN 'Logged In' WHEN (ald.AgentStateID = 2
                                                                                                                  AND oc.StateDescription IS NULL) THEN 'Unavailable' ELSE oc.StateDescription END AS StateDescription,
                ald.Duration AS Duration,
                CASE WHEN ald.AgentStateID = 2 THEN CASE WHEN (oc.OutstateType IS NULL) THEN 3 ELSE oc.OutstateType END WHEN ald.AgentStateID = 7 THEN oc.OutstateType ELSE 1 END AS OutstateType
INTO   #temp_UnavailableDetails
FROM   dbo.Agent_Log_DetailQV AS ald
       INNER JOIN
       dbo.Agents AS a
       ON ald.Agent_No = a.Agent_No
       INNER JOIN
       dbo.Team AS t
       ON (a.Team_No = t.Team_No)
       LEFT OUTER JOIN
       #temp_AgentState AS oc
       ON ald.Outstate_Code = oc.state_code
       INNER JOIN
       dbo.Security_DataRoles AS dr
       ON (a.Team_No = dr.EntityID
           OR dr.ViewAllAndFuture = 1)
       INNER JOIN
       dbo.Security_DataRoleEntityTypes AS dret
       ON (dr.DataRoleEntityTypeID = dret.DataRoleEntityTypeID)
       INNER JOIN
       dbo.fn_SplitOptionalInt(@TeamNoList) AS TeamKeys
       ON (t.Team_No BETWEEN TeamKeys.IDMin AND TeamKeys.IDMax)
       INNER JOIN
       dbo.fn_SplitOptionalInt(@AgentNoList) AS AgentKeys
       ON (a.Agent_No BETWEEN AgentKeys.IDMin AND AgentKeys.IDMax)
WHERE  ald.Bus_No = @bus_no
       AND ald.StartDate BETWEEN @start_date AND @end_date
       AND ald.Outstate_Code NOT IN (-1, -2)
       AND dret.DataRoleEntityTypeName = 'teams'
       AND dr.SecurityProfileID = @profileID
       AND (t.Status = 'CURR'
            OR @ActiveTeamOnly &lt;&gt; 1)
       AND (a.Status = 'CURR'
            OR @ActiveAgentOnly &lt;&gt; 1)</td>
        <td>32</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">CASE</td>
        <td colspan="1">CASE WHEN IsSystemOutstate = 1 THEN 1 WHEN (IsSystemOutstate = 0
                                            AND IsACW = 'T') THEN 2 ELSE 3 END</td>
        <td>18</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN ald.AgentStateID = 0 THEN 'Logged Out' WHEN ald.AgentStateID = 8 THEN 'Logged In' WHEN (ald.AgentStateID = 2
                                                                                                  AND oc.StateDescription IS NULL) THEN 'Unavailable' ELSE oc.StateDescription END</td>
        <td>40</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN ald.AgentStateID = 2 THEN CASE WHEN (oc.OutstateType IS NULL) THEN 3 ELSE oc.OutstateType END WHEN ald.AgentStateID = 7 THEN oc.OutstateType ELSE 1 END</td>
        <td>48</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN (oc.OutstateType IS NULL) THEN 3 ELSE oc.OutstateType END</td>
        <td>50</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">One-part names</td>
        <td colspan="1">#temp_AgentState AS oc</td>
        <td>69</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#temp_UnavailableDetails</td>
        <td>93</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#temp_UnavailableDetails AS ud</td>
        <td>105</td>
      </tr>
      <tr valign="top">
        <td colspan="1">Table-valued functions</td>
        <td colspan="1">dbo.fn_SplitOptionalInt(@TeamNoList) AS TeamKeys</td>
        <td>78</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">dbo.fn_SplitOptionalInt(@AgentNoList) AS AgentKeys</td>
        <td>81</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">dbo.fn_SplitOptionalInt(@CodeTypeList) AS CodeTypeKeys</td>
        <td>107</td>
      </tr>
    </table>
  </body>
</html>