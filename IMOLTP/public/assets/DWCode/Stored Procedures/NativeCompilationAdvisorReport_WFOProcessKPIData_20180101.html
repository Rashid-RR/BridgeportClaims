<?xml version="1.0" encoding="utf-8"?>
<html>
  <head>
    <title>Native Compilation Advisor evaluation results for [DWCode].[WFOProcessKPIData]</title>
  </head>
  <body>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 14pt;">
      <b>Native Compilation Advisor evaluation results for [DWCode].[WFOProcessKPIData]</b>
    </p>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 10pt;">
      <b>Report Date/Time:</b>1/1/2018 5:12 PM<br /></p>
    <table border="1" cellpadding="5" cellspacing="0" STYLE="font-family: Verdana, Arial, sans-serif; font-size: 9pt;">
      <tr style="background-color:Silver">
        <th colspan="1" align="center">Transact-SQL Element</th>
        <th align="center">Transact-SQL Code</th>
        <th align="center">Line Number</th>
      </tr>
      <tr valign="top">
        <td colspan="1">SELECT INTO</td>
        <td colspan="1">SELECT *
INTO   #UnProcessedRecords
FROM   [STAGING].[WFOKPIData]
WHERE  [PROCESSED] = 0</td>
        <td>7</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">SELECT DISTINCT (DIMKPIID),
                KPINAME
INTO   #DistinctSourceMeasure
FROM   #UnProcessedRecords AS UP</td>
        <td>13</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">SELECT A.[AGENT_NO],
       B.[BUS_NO],
       T.[ORGANIZATION],
       T.[FACTKPIID],
       T.[DIMKPIID],
       T.[KPINAME],
       T.[ACTUALVALUE],
       T.[DATE] AS CALCDATE,
       @CurrentDate AS CREATEDATE,
       T.[PERIODICITY],
       T.[ORGPERCENTMET],
       T.[ACTUALGOALVALUE],
       T.[PERCENTMET],
       T.[ROLLUPTYPE]
INTO   #UnProcessedRecordsWithAgentDetails
FROM   #UnProcessedRecords AS T
       INNER JOIN
       AGENTS AS A
       ON A.AGENT_NO = T.AGENTNO
       INNER JOIN
       BUSINESS_UNIT AS B
       ON A.BUS_NO = B.BUS_NO
WHERE  T.[ROLLUPTYPE] = 'No Aggregation'</td>
        <td>24</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">SELECT LTRIM(RTRIM(SUBSTRING(ORGANIZATION, 1, NULLIF (CHARINDEX('-', ORGANIZATION), 0) - 1))) AS TEAMNAME,
       LTRIM(RTRIM(REVERSE(SUBSTRING(REVERSE(ORGANIZATION), NULLIF (CHARINDEX(')', REVERSE(ORGANIZATION)), 0) + 1, NULLIF (CHARINDEX('(', REVERSE(ORGANIZATION)), 0) - (NULLIF (CHARINDEX(')', REVERSE(ORGANIZATION)), 0) + 1))))) AS BUS_NO,
       [ORGANIZATION],
       [FACTKPIID],
       [DIMKPIID],
       [KPINAME],
       [ACTUALVALUE],
       [DATE] AS CALCDATE,
       @CurrentDate AS CREATEDATE,
       [PERIODICITY],
       [ORGPERCENTMET],
       [ACTUALGOALVALUE],
       [PERCENTMET],
       [ROLLUPTYPE]
INTO   #TEAMS
FROM   #UnProcessedRecords
WHERE  ROLLUPTYPE = 'Organization Employee Aggregation'
       AND ORGANIZATION LIKE '% - %'
       AND ISNUMERIC(LTRIM(RTRIM(REVERSE(SUBSTRING(REVERSE(ORGANIZATION), NULLIF (CHARINDEX(')', REVERSE(ORGANIZATION)), 0) + 1, NULLIF (CHARINDEX('(', REVERSE(ORGANIZATION)), 0) - (NULLIF (CHARINDEX(')', REVERSE(ORGANIZATION)), 0) + 1)))))) &lt;&gt; 0</td>
        <td>46</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">SELECT Te.[TEAM_NO],
       B.[BUS_NO],
       T.[ORGANIZATION],
       T.[FACTKPIID],
       T.[DIMKPIID],
       T.[KPINAME],
       T.[ACTUALVALUE],
       T.CALCDATE,
       @CurrentDate AS CREATEDATE,
       T.[PERIODICITY],
       T.[ORGPERCENTMET],
       T.[ACTUALGOALVALUE],
       T.[PERCENTMET],
       T.[ROLLUPTYPE]
INTO   #UnProcessedRecordsWithTeamDetails
FROM   #TEAMS AS T
       INNER JOIN
       BUSINESS_UNIT AS B
       ON T.BUS_NO = B.BUS_NO
       INNER JOIN
       TEAM AS Te
       ON B.BUS_NO = Te.BUS_NO
WHERE  T.[ORGANIZATION] LIKE Te.TEAM_NAME + ' - %'</td>
        <td>68</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">*</td>
        <td colspan="1">SELECT *
INTO   #UnProcessedRecords
FROM   [STAGING].[WFOKPIData]
WHERE  [PROCESSED] = 0</td>
        <td>7</td>
      </tr>
      <tr valign="top">
        <td colspan="1">One-part names</td>
        <td colspan="1">#UnProcessedRecords AS UP</td>
        <td>15</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#DistinctSourceMeasure AS SM</td>
        <td>20</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#UnProcessedRecords AS T</td>
        <td>39</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">AGENTS AS A</td>
        <td>40</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">BUSINESS_UNIT AS B</td>
        <td>41</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#UnProcessedRecords</td>
        <td>61</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#TEAMS AS T</td>
        <td>83</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">BUSINESS_UNIT AS B</td>
        <td>84</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">TEAM AS Te</td>
        <td>85</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#UnProcessedRecordsWithAgentDetails AS UP</td>
        <td>91</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#UnProcessedRecordsWithAgentDetails AS UP</td>
        <td>130</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#UnProcessedRecordsWithTeamDetails AS UP</td>
        <td>136</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#UnProcessedRecordsWithTeamDetails AS UP</td>
        <td>175</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">STAGE</td>
        <td>179</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#UnProcessedRecords AS UP</td>
        <td>181</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">NULLIF</td>
        <td colspan="1">NULLIF (CHARINDEX('-', ORGANIZATION), 0)</td>
        <td>46</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NULLIF (CHARINDEX(')', REVERSE(ORGANIZATION)), 0)</td>
        <td>47</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">NULLIF (CHARINDEX('(', REVERSE(ORGANIZATION)), 0)</td>
        <td>47</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NULLIF (CHARINDEX(')', REVERSE(ORGANIZATION)), 0)</td>
        <td>47</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">NULLIF (CHARINDEX(')', REVERSE(ORGANIZATION)), 0)</td>
        <td>65</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NULLIF (CHARINDEX('(', REVERSE(ORGANIZATION)), 0)</td>
        <td>65</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">NULLIF (CHARINDEX(')', REVERSE(ORGANIZATION)), 0)</td>
        <td>65</td>
      </tr>
      <tr valign="top">
        <td colspan="1">CHARINDEX</td>
        <td colspan="1">CHARINDEX('-', ORGANIZATION)</td>
        <td>46</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CHARINDEX(')', REVERSE(ORGANIZATION))</td>
        <td>47</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CHARINDEX('(', REVERSE(ORGANIZATION))</td>
        <td>47</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CHARINDEX(')', REVERSE(ORGANIZATION))</td>
        <td>47</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CHARINDEX(')', REVERSE(ORGANIZATION))</td>
        <td>65</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CHARINDEX('(', REVERSE(ORGANIZATION))</td>
        <td>65</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CHARINDEX(')', REVERSE(ORGANIZATION))</td>
        <td>65</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">REVERSE</td>
        <td colspan="1">REVERSE(SUBSTRING(REVERSE(ORGANIZATION), NULLIF (CHARINDEX(')', REVERSE(ORGANIZATION)), 0) + 1, NULLIF (CHARINDEX('(', REVERSE(ORGANIZATION)), 0) - (NULLIF (CHARINDEX(')', REVERSE(ORGANIZATION)), 0) + 1)))</td>
        <td>47</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">REVERSE(ORGANIZATION)</td>
        <td>47</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">REVERSE(ORGANIZATION)</td>
        <td>47</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">REVERSE(ORGANIZATION)</td>
        <td>47</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">REVERSE(ORGANIZATION)</td>
        <td>47</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">REVERSE(SUBSTRING(REVERSE(ORGANIZATION), NULLIF (CHARINDEX(')', REVERSE(ORGANIZATION)), 0) + 1, NULLIF (CHARINDEX('(', REVERSE(ORGANIZATION)), 0) - (NULLIF (CHARINDEX(')', REVERSE(ORGANIZATION)), 0) + 1)))</td>
        <td>65</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">REVERSE(ORGANIZATION)</td>
        <td>65</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">REVERSE(ORGANIZATION)</td>
        <td>65</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">REVERSE(ORGANIZATION)</td>
        <td>65</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">REVERSE(ORGANIZATION)</td>
        <td>65</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">LIKE</td>
        <td colspan="1">ORGANIZATION LIKE '% - %'</td>
        <td>63</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">T.[ORGANIZATION] LIKE Te.TEAM_NAME + ' - %'</td>
        <td>86</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">ISNUMERIC</td>
        <td colspan="1">ISNUMERIC(LTRIM(RTRIM(REVERSE(SUBSTRING(REVERSE(ORGANIZATION), NULLIF (CHARINDEX(')', REVERSE(ORGANIZATION)), 0) + 1, NULLIF (CHARINDEX('(', REVERSE(ORGANIZATION)), 0) - (NULLIF (CHARINDEX(')', REVERSE(ORGANIZATION)), 0) + 1))))))</td>
        <td>64</td>
      </tr>
      <tr valign="top">
        <td colspan="1">MERGE</td>
        <td colspan="1">MERGE INTO [DBO].[WFOSourceMeasure_AgentScores]
 AS Dest
USING (SELECT UP.[AGENT_NO],
              UP.[ORGANIZATION],
              UP.[CALCDATE],
              SM.SourceMeasureID
       FROM   #UnProcessedRecordsWithAgentDetails AS UP
              INNER JOIN
              [DBO].[WFOSourceMeasure] AS SM
              ON SM.VerintInternalID = UP.DIMKPIID) AS Source ON Dest.[AGENTNO] = Source.[AGENT_NO]
                                                                 AND Dest.[ORGANIZATIONNAME] = Source.[ORGANIZATION]
                                                                 AND Dest.[CALCDATE] = Source.[CALCDATE]
                                                                 AND Dest.SourceMeasureID = Source.SourceMeasureID
WHEN MATCHED THEN DELETE</td>
        <td>89</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">MERGE INTO [DBO].[WFOSourceMeasure_AgentScores]
 AS Dest
USING (SELECT UP.[AGENT_NO],
              UP.[ORGANIZATION],
              UP.[CALCDATE],
              SM.SourceMeasureID
       FROM   #UnProcessedRecordsWithAgentDetails AS UP
              INNER JOIN
              [DBO].[WFOSourceMeasure] AS SM
              ON SM.VerintInternalID = UP.DIMKPIID) AS Source ON Dest.[AGENTNO] = Source.[AGENT_NO]
                                                                 AND Dest.[ORGANIZATIONNAME] = Source.[ORGANIZATION]
                                                                 AND Dest.[CALCDATE] = Source.[CALCDATE]
                                                                 AND Dest.SourceMeasureID = Source.SourceMeasureID
WHEN MATCHED THEN DELETE</td>
        <td>89</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">MERGE INTO [DBO].[WFOSourceMeasure_TeamScores]
 AS Dest
USING (SELECT UP.[TEAM_NO],
              UP.[ORGANIZATION],
              UP.[CALCDATE],
              SM.SourceMeasureID
       FROM   #UnProcessedRecordsWithTeamDetails AS UP
              INNER JOIN
              [DBO].[WFOSourceMeasure] AS SM
              ON SM.VerintInternalID = UP.DIMKPIID) AS Source ON Dest.[TEAMNO] = Source.[TEAM_NO]
                                                                 AND Dest.[ORGANIZATIONNAME] = Source.[ORGANIZATION]
                                                                 AND Dest.[CALCDATE] = Source.[CALCDATE]
                                                                 AND Dest.[SOURCEMEASUREID] = Source.[SOURCEMEASUREID]
WHEN MATCHED THEN DELETE</td>
        <td>134</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">MERGE INTO [DBO].[WFOSourceMeasure_TeamScores]
 AS Dest
USING (SELECT UP.[TEAM_NO],
              UP.[ORGANIZATION],
              UP.[CALCDATE],
              SM.SourceMeasureID
       FROM   #UnProcessedRecordsWithTeamDetails AS UP
              INNER JOIN
              [DBO].[WFOSourceMeasure] AS SM
              ON SM.VerintInternalID = UP.DIMKPIID) AS Source ON Dest.[TEAMNO] = Source.[TEAM_NO]
                                                                 AND Dest.[ORGANIZATIONNAME] = Source.[ORGANIZATION]
                                                                 AND Dest.[CALCDATE] = Source.[CALCDATE]
                                                                 AND Dest.[SOURCEMEASUREID] = Source.[SOURCEMEASUREID]
WHEN MATCHED THEN DELETE</td>
        <td>134</td>
      </tr>
      <tr valign="top">
        <td colspan="1">UPDATE with FROM clause</td>
        <td colspan="1">
FROM [STAGING].[WFOKPIData] AS STAGE
     INNER JOIN
     #UnProcessedRecords AS UP
     ON UP.FACTKPIID = STAGE.FACTKPIID</td>
        <td>180</td>
      </tr>
    </table>
  </body>
</html>