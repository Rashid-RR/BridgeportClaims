<?xml version="1.0" encoding="utf-8"?>
<html>
  <head>
    <title>Native Compilation Advisor evaluation results for [DWCode].[IC_Reports_GetContactHistoryContactOrAgent]</title>
  </head>
  <body>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 14pt;">
      <b>Native Compilation Advisor evaluation results for [DWCode].[IC_Reports_GetContactHistoryContactOrAgent]</b>
    </p>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 10pt;">
      <b>Report Date/Time:</b>1/1/2018 5:11 PM<br /></p>
    <table border="1" cellpadding="5" cellspacing="0" STYLE="font-family: Verdana, Arial, sans-serif; font-size: 9pt;">
      <tr style="background-color:Silver">
        <th colspan="1" align="center">Transact-SQL Element</th>
        <th align="center">Transact-SQL Code</th>
        <th align="center">Line Number</th>
      </tr>
      <tr valign="top">
        <td colspan="1">SET OPTION ON</td>
        <td colspan="1">SET NOCOUNT ON</td>
        <td>2</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">One-part names</td>
        <td colspan="1">#CampaignSecurityFilter</td>
        <td>68</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#TeamSecurityFilter</td>
        <td>73</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#TempCount</td>
        <td>87</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#ContactIDs</td>
        <td>130</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#ContactIDs</td>
        <td>138</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">Contact_Log_Header AS h</td>
        <td>146</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">Agents AS a</td>
        <td>147</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#TeamSecurityFilter AS tv</td>
        <td>148</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">Agents AS a</td>
        <td>157</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#TeamSecurityFilter AS tv</td>
        <td>158</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">Skills AS s</td>
        <td>160</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#CampaignSecurityFilter AS cv</td>
        <td>161</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#ContactIDs AS ci</td>
        <td>281</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#CampaignSecurityFilter AS cv</td>
        <td>285</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">Contact_Log_Tags AS ST1</td>
        <td>290</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">Tags AS t</td>
        <td>291</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">Contact_Log_Tags AS ST2</td>
        <td>297</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#TeamSecurityFilter AS tv</td>
        <td>316</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#TempCount AS tc</td>
        <td>343</td>
      </tr>
      <tr valign="top">
        <td colspan="1">Table-valued functions</td>
        <td colspan="1">dbo.fn_GetDataRoleFilterItems(@profileID, 'Campaigns')</td>
        <td>71</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">dbo.fn_GetDataRoleFilterItems(@profileID, 'Teams')</td>
        <td>76</td>
      </tr>
      <tr valign="top">
        <td colspan="1">CASE</td>
        <td colspan="1">CASE WHEN s.SkillRecordTypeID = 1 THEN s.Media_Type ELSE h.Media_Type END</td>
        <td>181</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN (CASE WHEN s.SkillRecordTypeID = 1 THEN s.Media_Type ELSE h.Media_Type END) = 4
          AND f.from_addr &lt;&gt; ''
          AND f.from_addr IS NOT NULL THEN (CASE WHEN (SELECT le.Start_Range
                                                       FROM   dbo.Lergs AS le
                                                       WHERE  CONVERT (CHAR (10), f.from_addr) BETWEEN le.Start_Range AND le.End_Range) IS NOT NULL THEN 'Cell Phone' ELSE 'Land Line' END) ELSE '' END</td>
        <td>186</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN s.SkillRecordTypeID = 1 THEN s.Media_Type ELSE h.Media_Type END</td>
        <td>186</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN (SELECT le.Start_Range
           FROM   dbo.Lergs AS le
           WHERE  CONVERT (CHAR (10), f.from_addr) BETWEEN le.Start_Range AND le.End_Range) IS NOT NULL THEN 'Cell Phone' ELSE 'Land Line' END</td>
        <td>192</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN cls.Contact_id IS NULL THEN dbo.FormatSecondsToHHMMSS(DATEDIFF(SECOND, h.start_date, f.End_Date)) WHEN r.Refuse_Time IS NOT NULL THEN dbo.FormatSecondsToHHMMSS(DATEDIFF(SECOND, h.start_date, r.Refuse_Time)) ELSE dbo.FormatSecondsToHHMMSS((cls.PreQueue_time / 1000.0) + (cls.InQueue_time / 1000.0) + (cls.Agent_time / 1000.0) + (cls.PostQueue_time / 1000.0)) END</td>
        <td>219</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE g.ResultStatus WHEN 0 THEN 'Success' WHEN 1 THEN 'No Answer' WHEN 2 THEN 'Busy' WHEN 3 THEN 'Error' WHEN 4 THEN 'Cancelled' WHEN 5 THEN 'Invalid Number' END</td>
        <td>241</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN h.Contact_id = h.Master_Contact_Id THEN CONVERT (BIT, 1) ELSE CONVERT (BIT, 0) END</td>
        <td>249</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN s.Outbound_Skill = 1 THEN f.to_addr ELSE ISNULL(p.ContactAddress, '-') END</td>
        <td>253</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN l.Contact_id IS NOT NULL THEN CONVERT (BIT, 1) ELSE CONVERT (BIT, 0) END</td>
        <td>256</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN ISNULL(survey.ScoredCount, 0) &gt; 0 THEN CONVERT (BIT, 1) ELSE CONVERT (BIT, 0) END</td>
        <td>260</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN ISNULL(survey.SurveyCount, 0) &gt; 0 THEN CONVERT (BIT, 1) ELSE CONVERT (BIT, 0) END</td>
        <td>264</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE ISNULL(h.ReskillIndicator, 0) WHEN 0 THEN 'Original Contact' WHEN 1 THEN 'Skill Transfer' WHEN 2 THEN 'Agent Transfer' WHEN 3 THEN 'Consult Transfer' WHEN 4 THEN 'Takeover' END</td>
        <td>272</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN r.RefusedContactlogID IS NULL THEN f.Agent_No ELSE r.Agent_No END</td>
        <td>311</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN c.contact_state = 2 THEN 1 ELSE 0 END</td>
        <td>367</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN c.contact_state = 4 THEN 1 ELSE 0 END</td>
        <td>371</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN c.contact_state = 8 THEN 1 ELSE 0 END</td>
        <td>375</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN c.contact_state = 13 THEN 1 ELSE 0 END</td>
        <td>379</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN c.contact_state = 7 THEN 1 ELSE 0 END</td>
        <td>383</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN c.contact_state = 5 THEN 1 ELSE 0 END</td>
        <td>387</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN c.contact_state = 1 THEN 1 ELSE 0 END</td>
        <td>391</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN c.contact_state = -1 THEN 1 ELSE 0 END</td>
        <td>395</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN c.contact_state = 15 THEN 1 ELSE 0 END</td>
        <td>399</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN c.contact_state = 11 THEN 1 ELSE 0 END</td>
        <td>403</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN c.contact_state NOT IN (-1, 1, 2, 4, 5, 7, 8, 11, 13, 15) THEN 1 ELSE 0 END</td>
        <td>407</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN ST.IsQM = 0
          AND ST.IsSurvey = 1 THEN 1 ELSE 0 END</td>
        <td>416</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN ST.IsQM = 1
          AND ST.IsSurvey = 0 THEN 1 ELSE 0 END</td>
        <td>422</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN s.SkillRecordTypeID = 1 THEN s.Media_Type ELSE h.Media_Type END</td>
        <td>438</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN r.RefusedContactlogID IS NULL THEN f.Agent_No ELSE r.Agent_No END</td>
        <td>446</td>
      </tr>
      <tr valign="top">
        <td colspan="1">APPLY</td>
        <td colspan="1">#ContactIDs AS ci
INNER JOIN
dbo.Contact_Log_Header AS h
ON h.Contact_id = ci.Contact_id
INNER JOIN
dbo.Contact_Log_Footer AS f
ON f.Contact_id = ci.Contact_id
INNER JOIN
dbo.Skills AS s
ON s.Skill_No = f.Skill_No
INNER JOIN
#CampaignSecurityFilter AS cv
ON cv.IntValue = s.Campaign_no
   OR cv.IntValue = 0
LEFT OUTER JOIN
(SELECT DISTINCT ST2.Contact_ID,
                 STUFF((SELECT   ',' + t.Name AS [text()]
                        FROM     Contact_Log_Tags AS ST1
                                 LEFT OUTER JOIN
                                 Tags AS t
                                 ON t.TagID = ST1.TagID
                        WHERE    ST1.Contact_ID = ST2.Contact_ID
                        ORDER BY ST1.Contact_ID
                        FOR      XML PATH ('')), 1, 1, '') AS [Tags]
 FROM   Contact_Log_Tags AS ST2) AS contactTag
ON h.Contact_id = contactTag.Contact_id CROSS APPLY (SELECT CONVERT (INT, NULL) AS RefusedContactlogID,
                                                            CONVERT (INT, NULL) AS Agent_No,
                                                            CONVERT (DATETIME, NULL) AS Refuse_Time,
                                                            CONVERT (NVARCHAR (255), NULL) AS Reason
                                                     UNION ALL
                                                     SELECT r.RefusedContactlogID,
                                                            r.Agent_No,
                                                            r.Refuse_Time,
                                                            r.Reason
                                                     FROM   dbo.RefusedContactLog AS r
                                                     WHERE  r.contact_id = ci.Contact_id) AS r
LEFT OUTER JOIN
dbo.Agents AS a
ON a.Agent_No = (CASE WHEN r.RefusedContactlogID IS NULL THEN f.Agent_No ELSE r.Agent_No END)
LEFT OUTER JOIN
dbo.Team AS t
ON t.Team_No = a.Team_No
INNER JOIN
#TeamSecurityFilter AS tv
ON tv.IntValue = t.Team_No
   OR tv.IntValue = 0 CROSS APPLY (SELECT h.Contact_Id
                                   WHERE  (@QASpecialist IS NULL
                                           AND @CompletedStartDate IS NULL
                                           AND @CompletedEndDate IS NULL)
                                          OR EXISTS (SELECT *
                                                     FROM   dbo.SurveyInvitations AS SI
                                                            INNER JOIN
                                                            dbo.SurveyResults AS SR
                                                            ON SR.SurveyInvitationID = SI.SurveyInvitationID
                                                               AND SR.bus_no = SI.bus_no
                                                               AND SR.SurveyResultStatusTypeID = 3
                                                     WHERE  SI.ContactID = ci.Contact_id
                                                            AND (@QASpecialist IS NULL
                                                                 OR SR.ScoringAgent_No = @QASpecialist)
                                                            AND ((@CompletedStartDate IS NULL
                                                                  AND @CompletedEndDate IS NULL)
                                                                 OR SR.CompletedDate BETWEEN @CompletedStartDate AND @CompletedEndDate))) AS surveyFilter
LEFT OUTER JOIN
#TempCount AS tc
ON tc.FromAddress = f.from_addr
LEFT OUTER JOIN
dbo.Contact_Logging AS l
ON l.Contact_id = ci.Contact_id
INNER JOIN
dbo.ScriptNameHistory AS sc
ON sc.ScriptNameHistoryID = h.ScriptNameHistoryID
LEFT OUTER JOIN
dbo.Contact_Log_Summary AS cls
ON cls.Contact_id = ci.Contact_id
LEFT OUTER JOIN
dbo.PointOfContact AS p
ON p.Contact_Code = h.Contact_Code
LEFT OUTER JOIN
dbo.CallFailure_Categories AS g
ON g.CallFailure_CategoryID = f.CallFailure_CategoryID OUTER APPLY (SELECT h.Contact_Id
                                                                    WHERE  @ShowTakeover = 2
                                                                           OR h.ReskillIndicator = 4
                                                                           OR EXISTS (SELECT *
                                                                                      FROM   dbo.Contact_Log_Header AS c
                                                                                      WHERE  c.Master_Contact_Id = ci.Contact_id
                                                                                             AND c.ReskillIndicator = 4)) AS takeovers OUTER APPLY (SELECT   TOP 1 di.Description,
                                                                                                                                                                   secDi.Description AS SecondaryDescription
                                                                                                                                                    FROM     dbo.Contact_Log_Dispositions AS d
                                                                                                                                                             INNER JOIN
                                                                                                                                                             dbo.Dispositions AS di
                                                                                                                                                             ON di.Disposition_Code = d.Disposition_Code
                                                                                                                                                             LEFT OUTER JOIN
                                                                                                                                                             dbo.Dispositions AS secDi
                                                                                                                                                             ON secDi.Disposition_Code = d.Secondary_Disposition_Code
                                                                                                                                                    WHERE    d.Contact_ID = ci.Contact_id
                                                                                                                                                    ORDER BY d.Start_Date DESC) AS dis OUTER APPLY (SELECT SUM(CASE WHEN c.contact_state = 2 THEN 1 ELSE 0 END) AS Rting,
                                                                                                                                                                                                           SUM(CASE WHEN c.contact_state = 4 THEN 1 ELSE 0 END) AS Act,
                                                                                                                                                                                                           SUM(CASE WHEN c.contact_state = 8 THEN 1 ELSE 0 END) AS Hld,
                                                                                                                                                                                                           SUM(CASE WHEN c.contact_state = 13 THEN 1 ELSE 0 END) AS Bsy,
                                                                                                                                                                                                           SUM(CASE WHEN c.contact_state = 7 THEN 1 ELSE 0 END) AS OB,
                                                                                                                                                                                                           SUM(CASE WHEN c.contact_state = 5 THEN 1 ELSE 0 END) AS Xfer,
                                                                                                                                                                                                           SUM(CASE WHEN c.contact_state = 1 THEN 1 ELSE 0 END) AS Ab,
                                                                                                                                                                                                           SUM(CASE WHEN c.contact_state = -1 THEN 1 ELSE 0 END) AS Err,
                                                                                                                                                                                                           SUM(CASE WHEN c.contact_state = 15 THEN 1 ELSE 0 END) AS Clbk,
                                                                                                                                                                                                           SUM(CASE WHEN c.contact_state = 11 THEN 1 ELSE 0 END) AS PstQ,
                                                                                                                                                                                                           SUM(CASE WHEN c.contact_state NOT IN (-1, 1, 2, 4, 5, 7, 8, 11, 13, 15) THEN 1 ELSE 0 END) AS Oth
                                                                                                                                                                                                    FROM   dbo.Contact_Log_Detail AS c
                                                                                                                                                                                                    WHERE  c.contact_id = ci.Contact_id) AS metrics OUTER APPLY (SELECT SUM(CASE WHEN ST.IsQM = 0
                                                                                                                                                                                                                                                                                      AND ST.IsSurvey = 1 THEN 1 ELSE 0 END) AS SurveyCount,
                                                                                                                                                                                                                                                                        SUM(CASE WHEN ST.IsQM = 1
                                                                                                                                                                                                                                                                                      AND ST.IsSurvey = 0 THEN 1 ELSE 0 END) AS ScoredCount
                                                                                                                                                                                                                                                                 FROM   dbo.SurveyInvitations AS SI
                                                                                                                                                                                                                                                                        INNER JOIN
                                                                                                                                                                                                                                                                        dbo.SurveyResults AS SR
                                                                                                                                                                                                                                                                        ON SR.SurveyInvitationID = SI.SurveyInvitationID
                                                                                                                                                                                                                                                                           AND SR.bus_no = SI.bus_no
                                                                                                                                                                                                                                                                           AND SR.SurveyResultStatusTypeID = 3
                                                                                                                                                                                                                                                                        INNER JOIN
                                                                                                                                                                                                                                                                        dbo.Surveys AS SV
                                                                                                                                                                                                                                                                        ON SV.SurveyID = SR.SurveyID
                                                                                                                                                                                                                                                                        INNER JOIN
                                                                                                                                                                                                                                                                        dbo.SurveyTypes AS ST
                                                                                                                                                                                                                                                                        ON ST.SurveyTypeID = SV.SurveyTypeID
                                                                                                                                                                                                                                                                 WHERE  SI.ContactID = ci.Contact_id) AS survey</td>
        <td>281</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#ContactIDs AS ci
INNER JOIN
dbo.Contact_Log_Header AS h
ON h.Contact_id = ci.Contact_id
INNER JOIN
dbo.Contact_Log_Footer AS f
ON f.Contact_id = ci.Contact_id
INNER JOIN
dbo.Skills AS s
ON s.Skill_No = f.Skill_No
INNER JOIN
#CampaignSecurityFilter AS cv
ON cv.IntValue = s.Campaign_no
   OR cv.IntValue = 0
LEFT OUTER JOIN
(SELECT DISTINCT ST2.Contact_ID,
                 STUFF((SELECT   ',' + t.Name AS [text()]
                        FROM     Contact_Log_Tags AS ST1
                                 LEFT OUTER JOIN
                                 Tags AS t
                                 ON t.TagID = ST1.TagID
                        WHERE    ST1.Contact_ID = ST2.Contact_ID
                        ORDER BY ST1.Contact_ID
                        FOR      XML PATH ('')), 1, 1, '') AS [Tags]
 FROM   Contact_Log_Tags AS ST2) AS contactTag
ON h.Contact_id = contactTag.Contact_id CROSS APPLY (SELECT CONVERT (INT, NULL) AS RefusedContactlogID,
                                                            CONVERT (INT, NULL) AS Agent_No,
                                                            CONVERT (DATETIME, NULL) AS Refuse_Time,
                                                            CONVERT (NVARCHAR (255), NULL) AS Reason
                                                     UNION ALL
                                                     SELECT r.RefusedContactlogID,
                                                            r.Agent_No,
                                                            r.Refuse_Time,
                                                            r.Reason
                                                     FROM   dbo.RefusedContactLog AS r
                                                     WHERE  r.contact_id = ci.Contact_id) AS r
LEFT OUTER JOIN
dbo.Agents AS a
ON a.Agent_No = (CASE WHEN r.RefusedContactlogID IS NULL THEN f.Agent_No ELSE r.Agent_No END)
LEFT OUTER JOIN
dbo.Team AS t
ON t.Team_No = a.Team_No
INNER JOIN
#TeamSecurityFilter AS tv
ON tv.IntValue = t.Team_No
   OR tv.IntValue = 0 CROSS APPLY (SELECT h.Contact_Id
                                   WHERE  (@QASpecialist IS NULL
                                           AND @CompletedStartDate IS NULL
                                           AND @CompletedEndDate IS NULL)
                                          OR EXISTS (SELECT *
                                                     FROM   dbo.SurveyInvitations AS SI
                                                            INNER JOIN
                                                            dbo.SurveyResults AS SR
                                                            ON SR.SurveyInvitationID = SI.SurveyInvitationID
                                                               AND SR.bus_no = SI.bus_no
                                                               AND SR.SurveyResultStatusTypeID = 3
                                                     WHERE  SI.ContactID = ci.Contact_id
                                                            AND (@QASpecialist IS NULL
                                                                 OR SR.ScoringAgent_No = @QASpecialist)
                                                            AND ((@CompletedStartDate IS NULL
                                                                  AND @CompletedEndDate IS NULL)
                                                                 OR SR.CompletedDate BETWEEN @CompletedStartDate AND @CompletedEndDate))) AS surveyFilter
LEFT OUTER JOIN
#TempCount AS tc
ON tc.FromAddress = f.from_addr
LEFT OUTER JOIN
dbo.Contact_Logging AS l
ON l.Contact_id = ci.Contact_id
INNER JOIN
dbo.ScriptNameHistory AS sc
ON sc.ScriptNameHistoryID = h.ScriptNameHistoryID
LEFT OUTER JOIN
dbo.Contact_Log_Summary AS cls
ON cls.Contact_id = ci.Contact_id
LEFT OUTER JOIN
dbo.PointOfContact AS p
ON p.Contact_Code = h.Contact_Code
LEFT OUTER JOIN
dbo.CallFailure_Categories AS g
ON g.CallFailure_CategoryID = f.CallFailure_CategoryID OUTER APPLY (SELECT h.Contact_Id
                                                                    WHERE  @ShowTakeover = 2
                                                                           OR h.ReskillIndicator = 4
                                                                           OR EXISTS (SELECT *
                                                                                      FROM   dbo.Contact_Log_Header AS c
                                                                                      WHERE  c.Master_Contact_Id = ci.Contact_id
                                                                                             AND c.ReskillIndicator = 4)) AS takeovers OUTER APPLY (SELECT   TOP 1 di.Description,
                                                                                                                                                                   secDi.Description AS SecondaryDescription
                                                                                                                                                    FROM     dbo.Contact_Log_Dispositions AS d
                                                                                                                                                             INNER JOIN
                                                                                                                                                             dbo.Dispositions AS di
                                                                                                                                                             ON di.Disposition_Code = d.Disposition_Code
                                                                                                                                                             LEFT OUTER JOIN
                                                                                                                                                             dbo.Dispositions AS secDi
                                                                                                                                                             ON secDi.Disposition_Code = d.Secondary_Disposition_Code
                                                                                                                                                    WHERE    d.Contact_ID = ci.Contact_id
                                                                                                                                                    ORDER BY d.Start_Date DESC) AS dis OUTER APPLY (SELECT SUM(CASE WHEN c.contact_state = 2 THEN 1 ELSE 0 END) AS Rting,
                                                                                                                                                                                                           SUM(CASE WHEN c.contact_state = 4 THEN 1 ELSE 0 END) AS Act,
                                                                                                                                                                                                           SUM(CASE WHEN c.contact_state = 8 THEN 1 ELSE 0 END) AS Hld,
                                                                                                                                                                                                           SUM(CASE WHEN c.contact_state = 13 THEN 1 ELSE 0 END) AS Bsy,
                                                                                                                                                                                                           SUM(CASE WHEN c.contact_state = 7 THEN 1 ELSE 0 END) AS OB,
                                                                                                                                                                                                           SUM(CASE WHEN c.contact_state = 5 THEN 1 ELSE 0 END) AS Xfer,
                                                                                                                                                                                                           SUM(CASE WHEN c.contact_state = 1 THEN 1 ELSE 0 END) AS Ab,
                                                                                                                                                                                                           SUM(CASE WHEN c.contact_state = -1 THEN 1 ELSE 0 END) AS Err,
                                                                                                                                                                                                           SUM(CASE WHEN c.contact_state = 15 THEN 1 ELSE 0 END) AS Clbk,
                                                                                                                                                                                                           SUM(CASE WHEN c.contact_state = 11 THEN 1 ELSE 0 END) AS PstQ,
                                                                                                                                                                                                           SUM(CASE WHEN c.contact_state NOT IN (-1, 1, 2, 4, 5, 7, 8, 11, 13, 15) THEN 1 ELSE 0 END) AS Oth
                                                                                                                                                                                                    FROM   dbo.Contact_Log_Detail AS c
                                                                                                                                                                                                    WHERE  c.contact_id = ci.Contact_id) AS metrics</td>
        <td>281</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#ContactIDs AS ci
INNER JOIN
dbo.Contact_Log_Header AS h
ON h.Contact_id = ci.Contact_id
INNER JOIN
dbo.Contact_Log_Footer AS f
ON f.Contact_id = ci.Contact_id
INNER JOIN
dbo.Skills AS s
ON s.Skill_No = f.Skill_No
INNER JOIN
#CampaignSecurityFilter AS cv
ON cv.IntValue = s.Campaign_no
   OR cv.IntValue = 0
LEFT OUTER JOIN
(SELECT DISTINCT ST2.Contact_ID,
                 STUFF((SELECT   ',' + t.Name AS [text()]
                        FROM     Contact_Log_Tags AS ST1
                                 LEFT OUTER JOIN
                                 Tags AS t
                                 ON t.TagID = ST1.TagID
                        WHERE    ST1.Contact_ID = ST2.Contact_ID
                        ORDER BY ST1.Contact_ID
                        FOR      XML PATH ('')), 1, 1, '') AS [Tags]
 FROM   Contact_Log_Tags AS ST2) AS contactTag
ON h.Contact_id = contactTag.Contact_id CROSS APPLY (SELECT CONVERT (INT, NULL) AS RefusedContactlogID,
                                                            CONVERT (INT, NULL) AS Agent_No,
                                                            CONVERT (DATETIME, NULL) AS Refuse_Time,
                                                            CONVERT (NVARCHAR (255), NULL) AS Reason
                                                     UNION ALL
                                                     SELECT r.RefusedContactlogID,
                                                            r.Agent_No,
                                                            r.Refuse_Time,
                                                            r.Reason
                                                     FROM   dbo.RefusedContactLog AS r
                                                     WHERE  r.contact_id = ci.Contact_id) AS r
LEFT OUTER JOIN
dbo.Agents AS a
ON a.Agent_No = (CASE WHEN r.RefusedContactlogID IS NULL THEN f.Agent_No ELSE r.Agent_No END)
LEFT OUTER JOIN
dbo.Team AS t
ON t.Team_No = a.Team_No
INNER JOIN
#TeamSecurityFilter AS tv
ON tv.IntValue = t.Team_No
   OR tv.IntValue = 0 CROSS APPLY (SELECT h.Contact_Id
                                   WHERE  (@QASpecialist IS NULL
                                           AND @CompletedStartDate IS NULL
                                           AND @CompletedEndDate IS NULL)
                                          OR EXISTS (SELECT *
                                                     FROM   dbo.SurveyInvitations AS SI
                                                            INNER JOIN
                                                            dbo.SurveyResults AS SR
                                                            ON SR.SurveyInvitationID = SI.SurveyInvitationID
                                                               AND SR.bus_no = SI.bus_no
                                                               AND SR.SurveyResultStatusTypeID = 3
                                                     WHERE  SI.ContactID = ci.Contact_id
                                                            AND (@QASpecialist IS NULL
                                                                 OR SR.ScoringAgent_No = @QASpecialist)
                                                            AND ((@CompletedStartDate IS NULL
                                                                  AND @CompletedEndDate IS NULL)
                                                                 OR SR.CompletedDate BETWEEN @CompletedStartDate AND @CompletedEndDate))) AS surveyFilter
LEFT OUTER JOIN
#TempCount AS tc
ON tc.FromAddress = f.from_addr
LEFT OUTER JOIN
dbo.Contact_Logging AS l
ON l.Contact_id = ci.Contact_id
INNER JOIN
dbo.ScriptNameHistory AS sc
ON sc.ScriptNameHistoryID = h.ScriptNameHistoryID
LEFT OUTER JOIN
dbo.Contact_Log_Summary AS cls
ON cls.Contact_id = ci.Contact_id
LEFT OUTER JOIN
dbo.PointOfContact AS p
ON p.Contact_Code = h.Contact_Code
LEFT OUTER JOIN
dbo.CallFailure_Categories AS g
ON g.CallFailure_CategoryID = f.CallFailure_CategoryID OUTER APPLY (SELECT h.Contact_Id
                                                                    WHERE  @ShowTakeover = 2
                                                                           OR h.ReskillIndicator = 4
                                                                           OR EXISTS (SELECT *
                                                                                      FROM   dbo.Contact_Log_Header AS c
                                                                                      WHERE  c.Master_Contact_Id = ci.Contact_id
                                                                                             AND c.ReskillIndicator = 4)) AS takeovers OUTER APPLY (SELECT   TOP 1 di.Description,
                                                                                                                                                                   secDi.Description AS SecondaryDescription
                                                                                                                                                    FROM     dbo.Contact_Log_Dispositions AS d
                                                                                                                                                             INNER JOIN
                                                                                                                                                             dbo.Dispositions AS di
                                                                                                                                                             ON di.Disposition_Code = d.Disposition_Code
                                                                                                                                                             LEFT OUTER JOIN
                                                                                                                                                             dbo.Dispositions AS secDi
                                                                                                                                                             ON secDi.Disposition_Code = d.Secondary_Disposition_Code
                                                                                                                                                    WHERE    d.Contact_ID = ci.Contact_id
                                                                                                                                                    ORDER BY d.Start_Date DESC) AS dis</td>
        <td>281</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#ContactIDs AS ci
INNER JOIN
dbo.Contact_Log_Header AS h
ON h.Contact_id = ci.Contact_id
INNER JOIN
dbo.Contact_Log_Footer AS f
ON f.Contact_id = ci.Contact_id
INNER JOIN
dbo.Skills AS s
ON s.Skill_No = f.Skill_No
INNER JOIN
#CampaignSecurityFilter AS cv
ON cv.IntValue = s.Campaign_no
   OR cv.IntValue = 0
LEFT OUTER JOIN
(SELECT DISTINCT ST2.Contact_ID,
                 STUFF((SELECT   ',' + t.Name AS [text()]
                        FROM     Contact_Log_Tags AS ST1
                                 LEFT OUTER JOIN
                                 Tags AS t
                                 ON t.TagID = ST1.TagID
                        WHERE    ST1.Contact_ID = ST2.Contact_ID
                        ORDER BY ST1.Contact_ID
                        FOR      XML PATH ('')), 1, 1, '') AS [Tags]
 FROM   Contact_Log_Tags AS ST2) AS contactTag
ON h.Contact_id = contactTag.Contact_id CROSS APPLY (SELECT CONVERT (INT, NULL) AS RefusedContactlogID,
                                                            CONVERT (INT, NULL) AS Agent_No,
                                                            CONVERT (DATETIME, NULL) AS Refuse_Time,
                                                            CONVERT (NVARCHAR (255), NULL) AS Reason
                                                     UNION ALL
                                                     SELECT r.RefusedContactlogID,
                                                            r.Agent_No,
                                                            r.Refuse_Time,
                                                            r.Reason
                                                     FROM   dbo.RefusedContactLog AS r
                                                     WHERE  r.contact_id = ci.Contact_id) AS r
LEFT OUTER JOIN
dbo.Agents AS a
ON a.Agent_No = (CASE WHEN r.RefusedContactlogID IS NULL THEN f.Agent_No ELSE r.Agent_No END)
LEFT OUTER JOIN
dbo.Team AS t
ON t.Team_No = a.Team_No
INNER JOIN
#TeamSecurityFilter AS tv
ON tv.IntValue = t.Team_No
   OR tv.IntValue = 0 CROSS APPLY (SELECT h.Contact_Id
                                   WHERE  (@QASpecialist IS NULL
                                           AND @CompletedStartDate IS NULL
                                           AND @CompletedEndDate IS NULL)
                                          OR EXISTS (SELECT *
                                                     FROM   dbo.SurveyInvitations AS SI
                                                            INNER JOIN
                                                            dbo.SurveyResults AS SR
                                                            ON SR.SurveyInvitationID = SI.SurveyInvitationID
                                                               AND SR.bus_no = SI.bus_no
                                                               AND SR.SurveyResultStatusTypeID = 3
                                                     WHERE  SI.ContactID = ci.Contact_id
                                                            AND (@QASpecialist IS NULL
                                                                 OR SR.ScoringAgent_No = @QASpecialist)
                                                            AND ((@CompletedStartDate IS NULL
                                                                  AND @CompletedEndDate IS NULL)
                                                                 OR SR.CompletedDate BETWEEN @CompletedStartDate AND @CompletedEndDate))) AS surveyFilter
LEFT OUTER JOIN
#TempCount AS tc
ON tc.FromAddress = f.from_addr
LEFT OUTER JOIN
dbo.Contact_Logging AS l
ON l.Contact_id = ci.Contact_id
INNER JOIN
dbo.ScriptNameHistory AS sc
ON sc.ScriptNameHistoryID = h.ScriptNameHistoryID
LEFT OUTER JOIN
dbo.Contact_Log_Summary AS cls
ON cls.Contact_id = ci.Contact_id
LEFT OUTER JOIN
dbo.PointOfContact AS p
ON p.Contact_Code = h.Contact_Code
LEFT OUTER JOIN
dbo.CallFailure_Categories AS g
ON g.CallFailure_CategoryID = f.CallFailure_CategoryID OUTER APPLY (SELECT h.Contact_Id
                                                                    WHERE  @ShowTakeover = 2
                                                                           OR h.ReskillIndicator = 4
                                                                           OR EXISTS (SELECT *
                                                                                      FROM   dbo.Contact_Log_Header AS c
                                                                                      WHERE  c.Master_Contact_Id = ci.Contact_id
                                                                                             AND c.ReskillIndicator = 4)) AS takeovers</td>
        <td>281</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#ContactIDs AS ci
INNER JOIN
dbo.Contact_Log_Header AS h
ON h.Contact_id = ci.Contact_id
INNER JOIN
dbo.Contact_Log_Footer AS f
ON f.Contact_id = ci.Contact_id
INNER JOIN
dbo.Skills AS s
ON s.Skill_No = f.Skill_No
INNER JOIN
#CampaignSecurityFilter AS cv
ON cv.IntValue = s.Campaign_no
   OR cv.IntValue = 0
LEFT OUTER JOIN
(SELECT DISTINCT ST2.Contact_ID,
                 STUFF((SELECT   ',' + t.Name AS [text()]
                        FROM     Contact_Log_Tags AS ST1
                                 LEFT OUTER JOIN
                                 Tags AS t
                                 ON t.TagID = ST1.TagID
                        WHERE    ST1.Contact_ID = ST2.Contact_ID
                        ORDER BY ST1.Contact_ID
                        FOR      XML PATH ('')), 1, 1, '') AS [Tags]
 FROM   Contact_Log_Tags AS ST2) AS contactTag
ON h.Contact_id = contactTag.Contact_id CROSS APPLY (SELECT CONVERT (INT, NULL) AS RefusedContactlogID,
                                                            CONVERT (INT, NULL) AS Agent_No,
                                                            CONVERT (DATETIME, NULL) AS Refuse_Time,
                                                            CONVERT (NVARCHAR (255), NULL) AS Reason
                                                     UNION ALL
                                                     SELECT r.RefusedContactlogID,
                                                            r.Agent_No,
                                                            r.Refuse_Time,
                                                            r.Reason
                                                     FROM   dbo.RefusedContactLog AS r
                                                     WHERE  r.contact_id = ci.Contact_id) AS r
LEFT OUTER JOIN
dbo.Agents AS a
ON a.Agent_No = (CASE WHEN r.RefusedContactlogID IS NULL THEN f.Agent_No ELSE r.Agent_No END)
LEFT OUTER JOIN
dbo.Team AS t
ON t.Team_No = a.Team_No
INNER JOIN
#TeamSecurityFilter AS tv
ON tv.IntValue = t.Team_No
   OR tv.IntValue = 0 CROSS APPLY (SELECT h.Contact_Id
                                   WHERE  (@QASpecialist IS NULL
                                           AND @CompletedStartDate IS NULL
                                           AND @CompletedEndDate IS NULL)
                                          OR EXISTS (SELECT *
                                                     FROM   dbo.SurveyInvitations AS SI
                                                            INNER JOIN
                                                            dbo.SurveyResults AS SR
                                                            ON SR.SurveyInvitationID = SI.SurveyInvitationID
                                                               AND SR.bus_no = SI.bus_no
                                                               AND SR.SurveyResultStatusTypeID = 3
                                                     WHERE  SI.ContactID = ci.Contact_id
                                                            AND (@QASpecialist IS NULL
                                                                 OR SR.ScoringAgent_No = @QASpecialist)
                                                            AND ((@CompletedStartDate IS NULL
                                                                  AND @CompletedEndDate IS NULL)
                                                                 OR SR.CompletedDate BETWEEN @CompletedStartDate AND @CompletedEndDate))) AS surveyFilter</td>
        <td>281</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#ContactIDs AS ci
INNER JOIN
dbo.Contact_Log_Header AS h
ON h.Contact_id = ci.Contact_id
INNER JOIN
dbo.Contact_Log_Footer AS f
ON f.Contact_id = ci.Contact_id
INNER JOIN
dbo.Skills AS s
ON s.Skill_No = f.Skill_No
INNER JOIN
#CampaignSecurityFilter AS cv
ON cv.IntValue = s.Campaign_no
   OR cv.IntValue = 0
LEFT OUTER JOIN
(SELECT DISTINCT ST2.Contact_ID,
                 STUFF((SELECT   ',' + t.Name AS [text()]
                        FROM     Contact_Log_Tags AS ST1
                                 LEFT OUTER JOIN
                                 Tags AS t
                                 ON t.TagID = ST1.TagID
                        WHERE    ST1.Contact_ID = ST2.Contact_ID
                        ORDER BY ST1.Contact_ID
                        FOR      XML PATH ('')), 1, 1, '') AS [Tags]
 FROM   Contact_Log_Tags AS ST2) AS contactTag
ON h.Contact_id = contactTag.Contact_id CROSS APPLY (SELECT CONVERT (INT, NULL) AS RefusedContactlogID,
                                                            CONVERT (INT, NULL) AS Agent_No,
                                                            CONVERT (DATETIME, NULL) AS Refuse_Time,
                                                            CONVERT (NVARCHAR (255), NULL) AS Reason
                                                     UNION ALL
                                                     SELECT r.RefusedContactlogID,
                                                            r.Agent_No,
                                                            r.Refuse_Time,
                                                            r.Reason
                                                     FROM   dbo.RefusedContactLog AS r
                                                     WHERE  r.contact_id = ci.Contact_id) AS r</td>
        <td>281</td>
      </tr>
      <tr valign="top">
        <td colspan="1">STUFF</td>
        <td colspan="1">STUFF((SELECT   ',' + t.Name AS [text()]
       FROM     Contact_Log_Tags AS ST1
                LEFT OUTER JOIN
                Tags AS t
                ON t.TagID = ST1.TagID
       WHERE    ST1.Contact_ID = ST2.Contact_ID
       ORDER BY ST1.Contact_ID
       FOR      XML PATH ('')), 1, 1, '')</td>
        <td>289</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">FOR XML</td>
        <td colspan="1">XML PATH ('')</td>
        <td>295</td>
      </tr>
      <tr valign="top">
        <td colspan="1">LIKE</td>
        <td colspan="1">f.to_addr LIKE '%' + @DNIS + '%'</td>
        <td>455</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">f.from_addr LIKE '%' + @ANI + '%'</td>
        <td>458</td>
      </tr>
    </table>
  </body>
</html>