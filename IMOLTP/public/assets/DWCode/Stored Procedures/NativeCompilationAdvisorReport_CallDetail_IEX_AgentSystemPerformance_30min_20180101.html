<?xml version="1.0" encoding="utf-8"?>
<html>
  <head>
    <title>Native Compilation Advisor evaluation results for [DWCode].[CallDetail_IEX_AgentSystemPerformance_30min]</title>
  </head>
  <body>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 14pt;">
      <b>Native Compilation Advisor evaluation results for [DWCode].[CallDetail_IEX_AgentSystemPerformance_30min]</b>
    </p>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 10pt;">
      <b>Report Date/Time:</b>1/1/2018 5:09 PM<br /></p>
    <table border="1" cellpadding="5" cellspacing="0" STYLE="font-family: Verdana, Arial, sans-serif; font-size: 9pt;">
      <tr style="background-color:Silver">
        <th colspan="1" align="center">Transact-SQL Element</th>
        <th align="center">Transact-SQL Code</th>
        <th align="center">Line Number</th>
      </tr>
      <tr valign="top">
        <td colspan="1">SET OPTION ON</td>
        <td colspan="1">SET NOCOUNT ON</td>
        <td>2</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">SET XACT_ABORT ON</td>
        <td>5</td>
      </tr>
      <tr valign="top">
        <td colspan="1">BEGIN TRANSACTION</td>
        <td colspan="1">BEGIN TRANSACTION</td>
        <td>4</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">One-part names</td>
        <td colspan="1">EXECUTE LockCriticalSection @LockCritical</td>
        <td>9</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#tmpHalfHours</td>
        <td>41</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#tmpAgentSessions AS d</td>
        <td>73</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#tmpHalfHours AS h</td>
        <td>99</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#tmp AS t</td>
        <td>99</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#tmp</td>
        <td>107</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">#tmpSplit AS t</td>
        <td>120</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">#OutboundCounts AS o</td>
        <td>121</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">SELECT INTO</td>
        <td colspan="1">SELECT h.Agent_session_id
INTO   #tmpAgentSessions
FROM   dbo.Agent_Log_Header AS h
       LEFT OUTER JOIN
       dbo.Agent_Log_Summary AS s
       ON s.Agent_session_id = h.Agent_session_id
WHERE  h.bus_no = @p_Bus_no
       AND h.start_date &lt;= @p_UTCEnd_Date
       AND IsNull(s.end_date, GetUTCDate()) &gt;= @p_UTCStart_Date</td>
        <td>49</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">SELECT h.agent_no,
       dt.working,
       dt.outstate_code,
       dt.stateindex,
       d.Agent_Session_ID,
       dt.available,
       (CASE WHEN dt.start_date &lt; @p_UTCStart_Date THEN @p_UTCStart_Date ELSE dt.start_date END) AS start_date,
       (CASE WHEN s.end_date &gt; @p_UTCEnd_Date THEN @p_UTCEnd_Date ELSE s.end_date END) AS end_date,
       dt.start_date AS sdate2,
       s.end_date AS edate2,
       s.IsACW,
       DATEDIFF(ms, dt.start_date, s.end_date) AS duration
INTO   #tmp
FROM   #tmpAgentSessions AS d
       INNER JOIN
       dbo.Agent_Log_Header AS h
       ON h.Agent_Session_ID = d.Agent_Session_ID
       INNER JOIN
       dbo.Agent_Log_Detail_Summary AS s
       ON s.[Agent_session_id] = d.[Agent_Session_ID]
       INNER JOIN
       dbo.Agent_Log_Detail AS dt
       ON dt.[Agent_session_id] = d.[Agent_Session_ID]
          AND dt.[StateIndex] = s.[StateIndex]
WHERE  dt.[start_date] &lt;= @p_UTCEnd_Date
       AND s.[end_date] &gt;= @p_UTCStart_Date</td>
        <td>56</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">SELECT t.agent_no,
       t.working,
       t.outstate_code,
       t.stateindex,
       t.Agent_Session_ID,
       t.available,
       (CASE WHEN t.start_date &lt; h.HalfHourStartDate THEN h.HalfHourStartDate ELSE t.start_date END) AS start_date,
       (CASE WHEN t.end_date &gt; h.HalfHourEndDate THEN h.HalfHourEndDate ELSE t.end_date END) AS end_date,
       t.IsACW,
       DATEDIFF(ms, (CASE WHEN t.start_date &lt; h.HalfHourStartDate THEN h.HalfHourStartDate ELSE t.start_date END), (CASE WHEN t.end_date &gt; h.HalfHourEndDate THEN h.HalfHourEndDate ELSE t.end_date END)) AS duration
INTO   #tmpSplit
FROM   #tmpHalfHours AS h
       INNER JOIN
       #tmp AS t
       ON t.start_date &lt; h.HalfHourEndDate
          AND t.end_date &gt;= h.HalfHourStartDate</td>
        <td>80</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">SELECT   dbo.fn_CalcHalfHourDateTime(edate2) AS HalfHour,
         agent_no,
         COUNT(*) AS OutCalls,
         SUM(duration / 1000) AS OutTime
INTO     #OutboundCounts
FROM     #tmp
WHERE    working = 2
GROUP BY dbo.fn_CalcHalfHourDateTime(edate2), agent_no</td>
        <td>102</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">CASE</td>
        <td colspan="1">CASE WHEN dt.start_date &lt; @p_UTCStart_Date THEN @p_UTCStart_Date ELSE dt.start_date END</td>
        <td>62</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN s.end_date &gt; @p_UTCEnd_Date THEN @p_UTCEnd_Date ELSE s.end_date END</td>
        <td>65</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN t.start_date &lt; h.HalfHourStartDate THEN h.HalfHourStartDate ELSE t.start_date END</td>
        <td>86</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN t.end_date &gt; h.HalfHourEndDate THEN h.HalfHourEndDate ELSE t.end_date END</td>
        <td>89</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN t.start_date &lt; h.HalfHourStartDate THEN h.HalfHourStartDate ELSE t.start_date END</td>
        <td>93</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN t.end_date &gt; h.HalfHourEndDate THEN h.HalfHourEndDate ELSE t.end_date END</td>
        <td>95</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN t.available = 1
          AND t.working = 0 THEN t.duration / 1000.0 ELSE 0 END</td>
        <td>115</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN (t.available = 0
           AND t.working = 0)
          AND t.IsACW = 'F' THEN t.duration / 1000.0 ELSE 0 END</td>
        <td>116</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">COMMIT TRANSACTION</td>
        <td colspan="1">COMMIT TRANSACTION</td>
        <td>132</td>
      </tr>
    </table>
  </body>
</html>