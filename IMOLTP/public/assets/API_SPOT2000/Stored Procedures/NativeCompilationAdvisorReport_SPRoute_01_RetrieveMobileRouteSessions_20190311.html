<?xml version="1.0" encoding="utf-8"?>
<html>
  <head>
    <title>Native Compilation Advisor evaluation results for [API_SPOT2000].[SPRoute_01_RetrieveMobileRouteSessions]</title>
  </head>
  <body>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 14pt;">
      <b>Native Compilation Advisor evaluation results for [API_SPOT2000].[SPRoute_01_RetrieveMobileRouteSessions]</b>
    </p>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 10pt;">
      <b>Report Date/Time:</b>3/11/2019 10:30 AM<br /></p>
    <table border="1" cellpadding="5" cellspacing="0" STYLE="font-family: Verdana, Arial, sans-serif; font-size: 9pt;">
      <tr style="background-color:Silver">
        <th colspan="1" align="center">Transact-SQL Element</th>
        <th align="center">Transact-SQL Code</th>
        <th align="center">Line Number</th>
      </tr>
      <tr valign="top">
        <td colspan="1">SET OPTION ON</td>
        <td colspan="1">SET NOCOUNT ON</td>
        <td>2</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">Table-valued functions</td>
        <td colspan="1">dbo.fnSPAccountNodesByGroupID(@SPAccountID, @RetailBrandID, NULL) AS BRAND</td>
        <td>20</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">dbo.fnVarcharListToTable(LE.AncillaryData) AS AD</td>
        <td>324</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">One-part names</td>
        <td colspan="1">ESM_SPAccountNode WITH (NOLOCK)</td>
        <td>22</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">ESM_SPAccountNode WITH (NOLOCK)</td>
        <td>25</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">MRSession WITH (NOLOCK)</td>
        <td>90</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistory AS MH WITH (NOLOCK)</td>
        <td>91</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">ESM_SPAccountNode AS SPAN WITH (NOLOCK)</td>
        <td>92</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">Route WITH (NOLOCK)</td>
        <td>94</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">Setting AS Vehicle WITH (NOLOCK)</td>
        <td>95</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">R</td>
        <td>101</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">Route WITH (NOLOCK)</td>
        <td>105</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">R</td>
        <td>108</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">RouteServiceWindow WITH (NOLOCK)</td>
        <td>114</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">R</td>
        <td>120</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryStop AS MS WITH (NOLOCK)</td>
        <td>150</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryStopStatus AS MSS WITH (NOLOCK)</td>
        <td>151</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">R</td>
        <td>161</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryStop AS MS WITH (NOLOCK)</td>
        <td>173</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryStopStatus AS MSS WITH (NOLOCK)</td>
        <td>174</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryInvoice AS MI WITH (NOLOCK)</td>
        <td>177</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryInvoiceStatus AS MIS WITH (NOLOCK)</td>
        <td>178</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">R</td>
        <td>190</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryStop AS MS WITH (NOLOCK)</td>
        <td>220</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">RouteStop AS RS WITH (NOLOCK)</td>
        <td>221</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryStopStatus AS MSS WITH (NOLOCK)</td>
        <td>222</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">R</td>
        <td>233</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryStop AS MS WITH (NOLOCK)</td>
        <td>245</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">RouteStop AS RS WITH (NOLOCK)</td>
        <td>246</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryStopStatus AS MSS WITH (NOLOCK)</td>
        <td>247</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryInvoice AS MI WITH (NOLOCK)</td>
        <td>250</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryInvoiceStatus AS MIS WITH (NOLOCK)</td>
        <td>251</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">R</td>
        <td>264</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryStop AS MS WITH (NOLOCK)</td>
        <td>276</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">RouteStop AS RS WITH (NOLOCK)</td>
        <td>277</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">RouteStop WITH (NOLOCK)</td>
        <td>278</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">R</td>
        <td>287</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryStop AS MS WITH (NOLOCK)</td>
        <td>295</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">RouteStop AS RS WITH (NOLOCK)</td>
        <td>296</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryInvoice AS MI WITH (NOLOCK)</td>
        <td>297</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">R</td>
        <td>307</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryStop AS MS WITH (NOLOCK)</td>
        <td>321</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">RouteStop AS RS WITH (NOLOCK)</td>
        <td>322</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">InvoiceLockerEvent AS LE WITH (NOLOCK)</td>
        <td>323</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">InvoiceLockerEvent AS LE WITH (NOLOCK)</td>
        <td>325</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">InvoiceLockerEvent AS LE WITH (NOLOCK)</td>
        <td>333</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">R</td>
        <td>376</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryStop AS MS WITH (NOLOCK)</td>
        <td>386</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">RouteStop AS RS WITH (NOLOCK)</td>
        <td>387</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryStopStatus AS MSS WITH (NOLOCK)</td>
        <td>388</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryStop AS MS WITH (NOLOCK)</td>
        <td>432</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">RouteStop AS RS WITH (NOLOCK)</td>
        <td>433</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryStopStatus AS MSS WITH (NOLOCK)</td>
        <td>434</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistory AS MH WITH (NOLOCK)</td>
        <td>452</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryStop AS MS WITH (NOLOCK)</td>
        <td>453</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">Route WITH (NOLOCK)</td>
        <td>467</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">RouteDeliveryZone AS Z WITH (NOLOCK)</td>
        <td>468</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">Route WITH (NOLOCK)</td>
        <td>483</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">RouteServiceZone AS SZ WITH (NOLOCK)</td>
        <td>484</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">RouteZone AS RZ WITH (NOLOCK)</td>
        <td>485</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">RouteZonePoint AS RZP WITH (NOLOCK)</td>
        <td>486</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">MRSessionVehicleStatus AS VS WITH (NOLOCK)</td>
        <td>499</td>
      </tr>
      <tr valign="top">
        <td colspan="1">NOLOCK</td>
        <td colspan="1">NOLOCK</td>
        <td>22</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>25</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>90</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>91</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>92</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>94</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>95</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>105</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>114</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>150</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>151</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>173</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>174</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>177</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>178</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>220</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>221</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>222</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>245</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>246</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>247</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>250</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>251</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>276</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>277</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>278</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>295</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>296</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>297</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>321</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>322</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>323</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>325</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>333</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>386</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>387</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>388</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>432</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>433</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>434</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>452</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>453</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>467</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>468</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>483</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>484</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>485</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>486</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>499</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">CASE</td>
        <td colspan="1">CASE WHEN IsNull(MRSession.Parked, 0) &lt;&gt; 0 THEN MRSession.ParkedDateTime ELSE NULL END</td>
        <td>71</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN MS.SubStopOrdinal = 1 THEN 1 ELSE 0 END</td>
        <td>137</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN MS.ClientAccountID IS NOT NULL
          AND MS.VisitTypeID &lt;&gt; 0 THEN 1 ELSE 0 END</td>
        <td>138</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN MS.SubStopOrdinal = 1
          AND IsNull(MSS.VisitStatusID, 0) = 1 THEN 1 ELSE 0 END</td>
        <td>140</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN MS.ClientAccountID IS NOT NULL
          AND MS.VisitTypeID &lt;&gt; 0
          AND IsNull(MSS.VisitStatusID, 0) = 1 THEN 1 ELSE 0 END</td>
        <td>141</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN MS.ClientAccountID IS NOT NULL
          AND MS.VisitTypeID &lt;&gt; 0
          AND IsNull(MSS.VisitStatusID, 0) = 1 THEN MSS.BagsQuantity ELSE 0 END</td>
        <td>142</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN MS.SubStopOrdinal = 1
          AND IsNull(MSS.VisitStatusID, 0) = 0
          AND MS.ETAOffsetSeconds IS NOT NULL
          AND ETA.ETA &lt; @CurrentDateTime THEN 1 ELSE 0 END</td>
        <td>144</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN MS.ClientAccountID IS NOT NULL
          AND MS.VisitTypeID &lt;&gt; 0
          AND IsNull(MSS.VisitStatusID, 0) = 0
          AND MS.ETAOffsetSeconds IS NOT NULL
          AND ETA.ETA &lt; @CurrentDateTime THEN 1 ELSE 0 END</td>
        <td>145</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN MS.SubStopOrdinal = 1
          AND IsNull(MSS.VisitStatusID, 0) = 2 THEN 1 ELSE 0 END</td>
        <td>147</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN MS.ClientAccountID IS NOT NULL
          AND MS.VisitTypeID &lt;&gt; 0
          AND IsNull(MSS.VisitStatusID, 0) = 2 THEN 1 ELSE 0 END</td>
        <td>148</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN DC.OrderStatusID = 1 THEN 1 ELSE 0 END</td>
        <td>170</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN DC.OrderStatusID = 2 THEN 1 ELSE 0 END</td>
        <td>171</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN MS.SubStopOrdinal = 1 THEN 1 ELSE 0 END</td>
        <td>207</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN MS.ClientAccountID IS NOT NULL
          AND MS.VisitTypeID &lt;&gt; 0 THEN 1 ELSE 0 END</td>
        <td>208</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN MS.SubStopOrdinal = 1
          AND IsNull(MSS.VisitStatusID, 0) = 1 THEN 1 ELSE 0 END</td>
        <td>210</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN MS.ClientAccountID IS NOT NULL
          AND MS.VisitTypeID &lt;&gt; 0
          AND IsNull(MSS.VisitStatusID, 0) = 1 THEN 1 ELSE 0 END</td>
        <td>211</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN MS.ClientAccountID IS NOT NULL
          AND MS.VisitTypeID &lt;&gt; 0
          AND IsNull(MSS.VisitStatusID, 0) = 1 THEN MSS.BagsQuantity ELSE 0 END</td>
        <td>212</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN MS.SubStopOrdinal = 1
          AND IsNull(MSS.VisitStatusID, 0) = 0
          AND MS.ETAOffsetSeconds IS NOT NULL
          AND ETA.ETA &lt; @CurrentDateTime THEN 1 ELSE 0 END</td>
        <td>214</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN MS.ClientAccountID IS NOT NULL
          AND MS.VisitTypeID &lt;&gt; 0
          AND IsNull(MSS.VisitStatusID, 0) = 0
          AND MS.ETAOffsetSeconds IS NOT NULL
          AND ETA.ETA &lt; @CurrentDateTime THEN 1 ELSE 0 END</td>
        <td>215</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN MS.SubStopOrdinal = 1
          AND IsNull(MSS.VisitStatusID, 0) = 2 THEN 1 ELSE 0 END</td>
        <td>217</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN MS.ClientAccountID IS NOT NULL
          AND MS.VisitTypeID &lt;&gt; 0
          AND IsNull(MSS.VisitStatusID, 0) = 2 THEN 1 ELSE 0 END</td>
        <td>218</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN DC.OrderStatusID = 1 THEN 1 ELSE 0 END</td>
        <td>242</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN DC.OrderStatusID = 2 THEN 1 ELSE 0 END</td>
        <td>243</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN RS_C.StopSubType = 'P' THEN 1 ELSE 0 END</td>
        <td>273</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN RS_C.StopSubType = 'D' THEN 1 ELSE 0 END</td>
        <td>274</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN LE_Counts.EventType = 'C' THEN LE_Counts.Cnt ELSE 0 END</td>
        <td>317</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN LE_Counts.EventType = 'R' THEN LE_Counts.Cnt ELSE 0 END</td>
        <td>318</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN LE_Counts.EventType = 'N' THEN LE_Counts.Cnt ELSE 0 END</td>
        <td>319</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN MS.SubStopOrdinal = 1 THEN 1 ELSE 0 END</td>
        <td>383</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN MS.SubStopOrdinal = 1
          AND IsNull(MSS.VisitStatusID, 0) = 1 THEN 1 ELSE 0 END</td>
        <td>384</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN MS.StopID IS NULL
          OR R.RouteVersionID = 0 THEN 'SC' ELSE CASE WHEN (RS.ServiceType &amp; 3) &lt;&gt; 0 THEN 'SC' WHEN (RS.ServiceType &amp; 12) &lt;&gt; 0 THEN 'MC' WHEN (RS.ServiceType &amp; 48) &lt;&gt; 0 THEN 'L' WHEN (RS.ServiceType &amp; 192) &lt;&gt; 0 THEN 'H' WHEN (RS.ServiceType &amp; 32768) &lt;&gt; 0 THEN 'O' ELSE 'SC' END END</td>
        <td>403</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN (RS.ServiceType &amp; 3) &lt;&gt; 0 THEN 'SC' WHEN (RS.ServiceType &amp; 12) &lt;&gt; 0 THEN 'MC' WHEN (RS.ServiceType &amp; 48) &lt;&gt; 0 THEN 'L' WHEN (RS.ServiceType &amp; 192) &lt;&gt; 0 THEN 'H' WHEN (RS.ServiceType &amp; 32768) &lt;&gt; 0 THEN 'O' ELSE 'SC' END</td>
        <td>404</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN R.RouteVersionID = 0 THEN CASE WHEN MS.DeliveryDays IN ('On Dmnd', '-------') THEN 'O' ELSE 'S' END ELSE CASE WHEN (IsNull(RS.ServiceType, 0) &amp; 15) &lt;&gt; 0 THEN MS.CustomerType ELSE '' END END</td>
        <td>411</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN MS.DeliveryDays IN ('On Dmnd', '-------') THEN 'O' ELSE 'S' END</td>
        <td>412</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN (IsNull(RS.ServiceType, 0) &amp; 15) &lt;&gt; 0 THEN MS.CustomerType ELSE '' END</td>
        <td>414</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN MS.ETAOffsetSeconds IS NULL THEN '' ELSE LEFT(CONVERT (VARCHAR (50), DateAdd(second, MS.ETAOffsetSeconds, R.SchedEndDateTime), 126), 19) END</td>
        <td>424</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN IsNull(MSS.VisitStatusID, 0) = 0
          AND MS.ETAOffsetSeconds IS NOT NULL
          AND ETA.ETA &lt; @CurrentDateTime THEN 'L' WHEN IsNull(MSS.VisitStatusID, 0) = 1 THEN 'V' WHEN IsNull(MSS.VisitStatusID, 0) = 2 THEN 'D' ELSE '' END</td>
        <td>426</td>
      </tr>
      <tr valign="top">
        <td colspan="1">UPDATE with FROM clause</td>
        <td colspan="1">
FROM @Recordset AS R
     INNER JOIN
     Route WITH (NOLOCK)
     ON Route.InstanceID = R.RouteID
        AND Route.StartTime IS NOT NULL
        AND Route.Duration IS NOT NULL</td>
        <td>104</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">
FROM @Recordset AS R OUTER APPLY (SELECT Min(RouteServiceWindow.StartTime) AS StartTime,
                                         Max(RouteServiceWindow.EndTime) AS EndTime
                                  FROM   RouteServiceWindow WITH (NOLOCK)
                                  WHERE  RouteServiceWindow.RouteID = R.RouteID) AS SS</td>
        <td>111</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">
FROM RouteServiceWindow WITH (NOLOCK)</td>
        <td>114</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">
FROM @Recordset AS R OUTER APPLY (SELECT Sum(CASE WHEN MS.SubStopOrdinal = 1 THEN 1 ELSE 0 END) AS CustomerStopsT,
                                         Sum(CASE WHEN MS.ClientAccountID IS NOT NULL
                                                       AND MS.VisitTypeID &lt;&gt; 0 THEN 1 ELSE 0 END) AS CustomerCountT,
                                         Sum(CASE WHEN MS.SubStopOrdinal = 1
                                                       AND IsNull(MSS.VisitStatusID, 0) = 1 THEN 1 ELSE 0 END) AS CustomerStopsC,
                                         Sum(CASE WHEN MS.ClientAccountID IS NOT NULL
                                                       AND MS.VisitTypeID &lt;&gt; 0
                                                       AND IsNull(MSS.VisitStatusID, 0) = 1 THEN 1 ELSE 0 END) AS CustomerCountC,
                                         Sum(CASE WHEN MS.ClientAccountID IS NOT NULL
                                                       AND MS.VisitTypeID &lt;&gt; 0
                                                       AND IsNull(MSS.VisitStatusID, 0) = 1 THEN MSS.BagsQuantity ELSE 0 END) AS CustomerBagsC,
                                         Sum(CASE WHEN MS.SubStopOrdinal = 1
                                                       AND IsNull(MSS.VisitStatusID, 0) = 0
                                                       AND MS.ETAOffsetSeconds IS NOT NULL
                                                       AND ETA.ETA &lt; @CurrentDateTime THEN 1 ELSE 0 END) AS CustomerStopsL,
                                         Sum(CASE WHEN MS.ClientAccountID IS NOT NULL
                                                       AND MS.VisitTypeID &lt;&gt; 0
                                                       AND IsNull(MSS.VisitStatusID, 0) = 0
                                                       AND MS.ETAOffsetSeconds IS NOT NULL
                                                       AND ETA.ETA &lt; @CurrentDateTime THEN 1 ELSE 0 END) AS CustomerCountL,
                                         Sum(CASE WHEN MS.SubStopOrdinal = 1
                                                       AND IsNull(MSS.VisitStatusID, 0) = 2 THEN 1 ELSE 0 END) AS CustomerStopsDNV,
                                         Sum(CASE WHEN MS.ClientAccountID IS NOT NULL
                                                       AND MS.VisitTypeID &lt;&gt; 0
                                                       AND IsNull(MSS.VisitStatusID, 0) = 2 THEN 1 ELSE 0 END) AS CustomerCountDNV
                                  FROM   ManifestHistoryStop AS MS WITH (NOLOCK)
                                         LEFT OUTER JOIN
                                         ManifestHistoryStopStatus AS MSS WITH (NOLOCK)
                                         ON MSS.ManifestHistoryStopID = MS.InstanceID OUTER APPLY (SELECT dbo.RouteGetStopEndingTime(R.SchedStartDateTime, MS.TimeRange, MS.ETAOffsetSeconds) AS ETA) AS ETA
                                  WHERE  MS.ManifestID = R.ManifestID
                                         AND MS.ClientAccountID &lt;&gt; 'D796891E-02F2-4803-999A-1AD0BF9BE58B') AS SS</td>
        <td>135</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">
FROM ManifestHistoryStop AS MS WITH (NOLOCK)
     LEFT OUTER JOIN
     ManifestHistoryStopStatus AS MSS WITH (NOLOCK)
     ON MSS.ManifestHistoryStopID = MS.InstanceID OUTER APPLY (SELECT dbo.RouteGetStopEndingTime(R.SchedStartDateTime, MS.TimeRange, MS.ETAOffsetSeconds) AS ETA) AS ETA</td>
        <td>150</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">
FROM @Recordset AS R OUTER APPLY (SELECT Count(DISTINCT DC.InvoiceID) AS CustomerOrdersT,
                                         Sum(CASE WHEN DC.OrderStatusID = 1 THEN 1 ELSE 0 END) AS CustomerOrdersDeliveredC,
                                         Sum(CASE WHEN DC.OrderStatusID = 2 THEN 1 ELSE 0 END) AS CustomerOrdersNonDeliveredC
                                  FROM   ManifestHistoryStop AS MS WITH (NOLOCK)
                                         LEFT OUTER JOIN
                                         ManifestHistoryStopStatus AS MSS WITH (NOLOCK)
                                         ON MSS.ManifestHistoryStopID = MS.InstanceID OUTER APPLY (SELECT MI.InvoiceID,
                                                                                                          IsNull(MIS.OrderStatusID, 0) AS OrderStatusID
                                                                                                   FROM   ManifestHistoryInvoice AS MI WITH (NOLOCK)
                                                                                                          LEFT OUTER JOIN
                                                                                                          ManifestHistoryInvoiceStatus AS MIS WITH (NOLOCK)
                                                                                                          ON MIS.ManifestHistoryInvoiceID = MI.InstanceID
                                                                                                             AND MIS.OrderStatusID IN (1, 2)
                                                                                                   WHERE  MI.ManifestHistoryStopID = MS.InstanceID
                                                                                                          AND MI.ManifestExclusionReasonID IS NULL
                                                                                                          AND MI.DelayedFlag IS NULL) AS DC
                                  WHERE  MS.ManifestID = R.ManifestID
                                         AND MS.ClientAccountID &lt;&gt; 'D796891E-02F2-4803-999A-1AD0BF9BE58B') AS SS</td>
        <td>167</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">
FROM ManifestHistoryStop AS MS WITH (NOLOCK)
     LEFT OUTER JOIN
     ManifestHistoryStopStatus AS MSS WITH (NOLOCK)
     ON MSS.ManifestHistoryStopID = MS.InstanceID OUTER APPLY (SELECT MI.InvoiceID,
                                                                      IsNull(MIS.OrderStatusID, 0) AS OrderStatusID
                                                               FROM   ManifestHistoryInvoice AS MI WITH (NOLOCK)
                                                                      LEFT OUTER JOIN
                                                                      ManifestHistoryInvoiceStatus AS MIS WITH (NOLOCK)
                                                                      ON MIS.ManifestHistoryInvoiceID = MI.InstanceID
                                                                         AND MIS.OrderStatusID IN (1, 2)
                                                               WHERE  MI.ManifestHistoryStopID = MS.InstanceID
                                                                      AND MI.ManifestExclusionReasonID IS NULL
                                                                      AND MI.DelayedFlag IS NULL) AS DC</td>
        <td>173</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">
FROM ManifestHistoryInvoice AS MI WITH (NOLOCK)
     LEFT OUTER JOIN
     ManifestHistoryInvoiceStatus AS MIS WITH (NOLOCK)
     ON MIS.ManifestHistoryInvoiceID = MI.InstanceID
        AND MIS.OrderStatusID IN (1, 2)</td>
        <td>177</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">
FROM @Recordset AS R OUTER APPLY (SELECT Sum(CASE WHEN MS.SubStopOrdinal = 1 THEN 1 ELSE 0 END) AS CustomerStopsT,
                                         Sum(CASE WHEN MS.ClientAccountID IS NOT NULL
                                                       AND MS.VisitTypeID &lt;&gt; 0 THEN 1 ELSE 0 END) AS CustomerCountT,
                                         Sum(CASE WHEN MS.SubStopOrdinal = 1
                                                       AND IsNull(MSS.VisitStatusID, 0) = 1 THEN 1 ELSE 0 END) AS CustomerStopsC,
                                         Sum(CASE WHEN MS.ClientAccountID IS NOT NULL
                                                       AND MS.VisitTypeID &lt;&gt; 0
                                                       AND IsNull(MSS.VisitStatusID, 0) = 1 THEN 1 ELSE 0 END) AS CustomerCountC,
                                         Sum(CASE WHEN MS.ClientAccountID IS NOT NULL
                                                       AND MS.VisitTypeID &lt;&gt; 0
                                                       AND IsNull(MSS.VisitStatusID, 0) = 1 THEN MSS.BagsQuantity ELSE 0 END) AS CustomerBagsC,
                                         Sum(CASE WHEN MS.SubStopOrdinal = 1
                                                       AND IsNull(MSS.VisitStatusID, 0) = 0
                                                       AND MS.ETAOffsetSeconds IS NOT NULL
                                                       AND ETA.ETA &lt; @CurrentDateTime THEN 1 ELSE 0 END) AS CustomerStopsL,
                                         Sum(CASE WHEN MS.ClientAccountID IS NOT NULL
                                                       AND MS.VisitTypeID &lt;&gt; 0
                                                       AND IsNull(MSS.VisitStatusID, 0) = 0
                                                       AND MS.ETAOffsetSeconds IS NOT NULL
                                                       AND ETA.ETA &lt; @CurrentDateTime THEN 1 ELSE 0 END) AS CustomerCountL,
                                         Sum(CASE WHEN MS.SubStopOrdinal = 1
                                                       AND IsNull(MSS.VisitStatusID, 0) = 2 THEN 1 ELSE 0 END) AS CustomerStopsDNV,
                                         Sum(CASE WHEN MS.ClientAccountID IS NOT NULL
                                                       AND MS.VisitTypeID &lt;&gt; 0
                                                       AND IsNull(MSS.VisitStatusID, 0) = 2 THEN 1 ELSE 0 END) AS CustomerCountDNV
                                  FROM   ManifestHistoryStop AS MS WITH (NOLOCK)
                                         LEFT OUTER JOIN
                                         RouteStop AS RS WITH (NOLOCK)
                                         ON RS.InstanceID = MS.StopID
                                         LEFT OUTER JOIN
                                         ManifestHistoryStopStatus AS MSS WITH (NOLOCK)
                                         ON MSS.ManifestHistoryStopID = MS.InstanceID OUTER APPLY (SELECT dbo.RouteGetStopEndingTime(R.SchedStartDateTime, MS.TimeRange, MS.ETAOffsetSeconds) AS ETA) AS ETA
                                  WHERE  MS.ManifestID = R.ManifestID
                                         AND MS.ClientAccountID &lt;&gt; 'D796891E-02F2-4803-999A-1AD0BF9BE58B'
                                         AND ((RS.ServiceType &amp; 15) &lt;&gt; 0
                                              OR MS.StopID IS NULL)) AS SS</td>
        <td>205</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">
FROM ManifestHistoryStop AS MS WITH (NOLOCK)
     LEFT OUTER JOIN
     RouteStop AS RS WITH (NOLOCK)
     ON RS.InstanceID = MS.StopID
     LEFT OUTER JOIN
     ManifestHistoryStopStatus AS MSS WITH (NOLOCK)
     ON MSS.ManifestHistoryStopID = MS.InstanceID OUTER APPLY (SELECT dbo.RouteGetStopEndingTime(R.SchedStartDateTime, MS.TimeRange, MS.ETAOffsetSeconds) AS ETA) AS ETA</td>
        <td>220</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">
FROM @Recordset AS R OUTER APPLY (SELECT Count(DISTINCT DC.InvoiceID) AS CustomerOrdersT,
                                         Sum(CASE WHEN DC.OrderStatusID = 1 THEN 1 ELSE 0 END) AS CustomerOrdersDeliveredC,
                                         Sum(CASE WHEN DC.OrderStatusID = 2 THEN 1 ELSE 0 END) AS CustomerOrdersNonDeliveredC
                                  FROM   ManifestHistoryStop AS MS WITH (NOLOCK)
                                         LEFT OUTER JOIN
                                         RouteStop AS RS WITH (NOLOCK)
                                         ON RS.InstanceID = MS.StopID
                                         LEFT OUTER JOIN
                                         ManifestHistoryStopStatus AS MSS WITH (NOLOCK)
                                         ON MSS.ManifestHistoryStopID = MS.InstanceID OUTER APPLY (SELECT MI.InvoiceID,
                                                                                                          IsNull(MIS.OrderStatusID, 0) AS OrderStatusID
                                                                                                   FROM   ManifestHistoryInvoice AS MI WITH (NOLOCK)
                                                                                                          LEFT OUTER JOIN
                                                                                                          ManifestHistoryInvoiceStatus AS MIS WITH (NOLOCK)
                                                                                                          ON MIS.ManifestHistoryInvoiceID = MI.InstanceID
                                                                                                             AND MIS.OrderStatusID IN (1, 2)
                                                                                                   WHERE  MI.ManifestHistoryStopID = MS.InstanceID
                                                                                                          AND MI.ManifestExclusionReasonID IS NULL
                                                                                                          AND MI.DelayedFlag IS NULL) AS DC
                                  WHERE  MS.ManifestID = R.ManifestID
                                         AND MS.ClientAccountID &lt;&gt; 'D796891E-02F2-4803-999A-1AD0BF9BE58B'
                                         AND ((RS.ServiceType &amp; 15) &lt;&gt; 0
                                              OR MS.StopID IS NULL)) AS SS</td>
        <td>239</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">
FROM ManifestHistoryStop AS MS WITH (NOLOCK)
     LEFT OUTER JOIN
     RouteStop AS RS WITH (NOLOCK)
     ON RS.InstanceID = MS.StopID
     LEFT OUTER JOIN
     ManifestHistoryStopStatus AS MSS WITH (NOLOCK)
     ON MSS.ManifestHistoryStopID = MS.InstanceID OUTER APPLY (SELECT MI.InvoiceID,
                                                                      IsNull(MIS.OrderStatusID, 0) AS OrderStatusID
                                                               FROM   ManifestHistoryInvoice AS MI WITH (NOLOCK)
                                                                      LEFT OUTER JOIN
                                                                      ManifestHistoryInvoiceStatus AS MIS WITH (NOLOCK)
                                                                      ON MIS.ManifestHistoryInvoiceID = MI.InstanceID
                                                                         AND MIS.OrderStatusID IN (1, 2)
                                                               WHERE  MI.ManifestHistoryStopID = MS.InstanceID
                                                                      AND MI.ManifestExclusionReasonID IS NULL
                                                                      AND MI.DelayedFlag IS NULL) AS DC</td>
        <td>245</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">
FROM ManifestHistoryInvoice AS MI WITH (NOLOCK)
     LEFT OUTER JOIN
     ManifestHistoryInvoiceStatus AS MIS WITH (NOLOCK)
     ON MIS.ManifestHistoryInvoiceID = MI.InstanceID
        AND MIS.OrderStatusID IN (1, 2)</td>
        <td>250</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">
FROM @Recordset AS R OUTER APPLY (SELECT Count(DISTINCT RS.InstanceID) AS LockerStopsT,
                                         Sum(CASE WHEN RS_C.StopSubType = 'P' THEN 1 ELSE 0 END) AS LockerPickupsT,
                                         Sum(CASE WHEN RS_C.StopSubType = 'D' THEN 1 ELSE 0 END) AS LockerDeliveriesT
                                  FROM   ManifestHistoryStop AS MS WITH (NOLOCK)
                                         INNER JOIN
                                         RouteStop AS RS WITH (NOLOCK)
                                         ON RS.InstanceID = MS.StopID
                                            AND RS.LockerID IS NOT NULL
                                            AND (RS.ServiceType &amp; 48) &lt;&gt; 0 OUTER APPLY (SELECT DISTINCT ClientAccountID,
                                                                                                        StopSubType
                                                                                        FROM   RouteStop WITH (NOLOCK)
                                                                                        WHERE  RouteStop.InstanceID = MS.StopID
                                                                                               AND (RouteStop.ServiceType &amp; 48) &lt;&gt; 0
                                                                                               AND RouteStop.LockerID IS NOT NULL
                                                                                               AND MS.StopSubType IN ('D', 'P')) AS RS_C
                                  WHERE  MS.ManifestID = R.ManifestID
                                         AND MS.ClientAccountID &lt;&gt; 'D796891E-02F2-4803-999A-1AD0BF9BE58B') AS SS</td>
        <td>270</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">
FROM ManifestHistoryStop AS MS WITH (NOLOCK)
     INNER JOIN
     RouteStop AS RS WITH (NOLOCK)
     ON RS.InstanceID = MS.StopID
        AND RS.LockerID IS NOT NULL
        AND (RS.ServiceType &amp; 48) &lt;&gt; 0 OUTER APPLY (SELECT DISTINCT ClientAccountID,
                                                                    StopSubType
                                                    FROM   RouteStop WITH (NOLOCK)
                                                    WHERE  RouteStop.InstanceID = MS.StopID
                                                           AND (RouteStop.ServiceType &amp; 48) &lt;&gt; 0
                                                           AND RouteStop.LockerID IS NOT NULL
                                                           AND MS.StopSubType IN ('D', 'P')) AS RS_C</td>
        <td>276</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">
FROM RouteStop WITH (NOLOCK)</td>
        <td>278</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">
FROM @Recordset AS R OUTER APPLY (SELECT Count(DISTINCT MI.InvoiceID) AS LockerOrderCountT
                                  FROM   ManifestHistoryStop AS MS WITH (NOLOCK)
                                         INNER JOIN
                                         RouteStop AS RS WITH (NOLOCK)
                                         ON RS.InstanceID = MS.StopID
                                            AND RS.LockerID IS NOT NULL
                                            AND (RS.ServiceType &amp; 48) &lt;&gt; 0
                                         INNER JOIN
                                         ManifestHistoryInvoice AS MI WITH (NOLOCK)
                                         ON MI.ManifestHistoryStopID = MS.InstanceID
                                            AND MI.ManifestExclusionReasonID IS NULL
                                            AND MI.DelayedFlag IS NULL
                                  WHERE  MS.ManifestID = R.ManifestID
                                         AND MS.ClientAccountID &lt;&gt; 'D796891E-02F2-4803-999A-1AD0BF9BE58B'
                                         AND MS.StopSubType = 'D') AS SS</td>
        <td>291</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">
FROM ManifestHistoryStop AS MS WITH (NOLOCK)
     INNER JOIN
     RouteStop AS RS WITH (NOLOCK)
     ON RS.InstanceID = MS.StopID
        AND RS.LockerID IS NOT NULL
        AND (RS.ServiceType &amp; 48) &lt;&gt; 0
     INNER JOIN
     ManifestHistoryInvoice AS MI WITH (NOLOCK)
     ON MI.ManifestHistoryStopID = MS.InstanceID
        AND MI.ManifestExclusionReasonID IS NULL
        AND MI.DelayedFlag IS NULL</td>
        <td>295</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">
FROM @Recordset AS R OUTER APPLY (SELECT Count(DISTINCT LE_End.InstanceNumber) AS LockerStopsC,
                                         Sum(CASE WHEN LE_Counts.EventType = 'C' THEN LE_Counts.Cnt ELSE 0 END) AS LockerBagCountC,
                                         Sum(CASE WHEN LE_Counts.EventType = 'R' THEN LE_Counts.Cnt ELSE 0 END) AS DeliveryOrderCountC,
                                         Sum(CASE WHEN LE_Counts.EventType = 'N' THEN LE_Counts.Cnt ELSE 0 END) AS NonDeliveryOrderCountC
                                  FROM   ManifestHistoryStop AS MS WITH (NOLOCK)
                                         INNER JOIN
                                         RouteStop AS RS WITH (NOLOCK)
                                         ON RS.InstanceID = MS.StopID
                                            AND RS.LockerID IS NOT NULL
                                            AND (RS.ServiceType &amp; 48) &lt;&gt; 0 OUTER APPLY (SELECT   TOP 1 LE.InstanceNumber
                                                                                        FROM     InvoiceLockerEvent AS LE WITH (NOLOCK)
                                                                                        WHERE    LE.MRSessionID = R.MRSessionID
                                                                                                 AND LE.LockerID = RS.LockerID
                                                                                                 AND LE.EventType = 'Z'
                                                                                        ORDER BY LE.InstanceNumber DESC) AS LE_End OUTER APPLY (SELECT   LE.EventType,
                                                                                                                                                         (SELECT CAST (Val AS INT)
                                                                                                                                                          FROM   dbo.fnVarcharListToTable(LE.AncillaryData) AS AD
                                                                                                                                                          WHERE  AD.ID = 1) AS Cnt
                                                                                                                                                FROM     InvoiceLockerEvent AS LE WITH (NOLOCK)
                                                                                                                                                WHERE    LE.MRSessionID = R.MRSessionID
                                                                                                                                                         AND LE.LockerID = RS.LockerID
                                                                                                                                                         AND LE.EventType = 'C'
                                                                                                                                                         AND LE.InvoiceID IS NULL
                                                                                                                                                         AND LE.AncillaryData IS NOT NULL
                                                                                                                                                UNION
                                                                                                                                                SELECT   LE.EventType,
                                                                                                                                                         Count(*) AS Cnt
                                                                                                                                                FROM     InvoiceLockerEvent AS LE WITH (NOLOCK)
                                                                                                                                                WHERE    LE.MRSessionID = R.MRSessionID
                                                                                                                                                         AND LE.LockerID = RS.LockerID
                                                                                                                                                         AND LE.EventType IN ('N', 'R')
                                                                                                                                                         AND LE.InvoiceID IS NOT NULL
                                                                                                                                                GROUP BY LE.EventType) AS LE_Counts
                                  WHERE  MS.ManifestID = R.ManifestID
                                         AND MS.ClientAccountID &lt;&gt; 'D796891E-02F2-4803-999A-1AD0BF9BE58B'
                                         AND LE_End.InstanceNumber IS NOT NULL) AS SS</td>
        <td>314</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">
FROM ManifestHistoryStop AS MS WITH (NOLOCK)
     INNER JOIN
     RouteStop AS RS WITH (NOLOCK)
     ON RS.InstanceID = MS.StopID
        AND RS.LockerID IS NOT NULL
        AND (RS.ServiceType &amp; 48) &lt;&gt; 0 OUTER APPLY (SELECT   TOP 1 LE.InstanceNumber
                                                    FROM     InvoiceLockerEvent AS LE WITH (NOLOCK)
                                                    WHERE    LE.MRSessionID = R.MRSessionID
                                                             AND LE.LockerID = RS.LockerID
                                                             AND LE.EventType = 'Z'
                                                    ORDER BY LE.InstanceNumber DESC) AS LE_End OUTER APPLY (SELECT   LE.EventType,
                                                                                                                     (SELECT CAST (Val AS INT)
                                                                                                                      FROM   dbo.fnVarcharListToTable(LE.AncillaryData) AS AD
                                                                                                                      WHERE  AD.ID = 1) AS Cnt
                                                                                                            FROM     InvoiceLockerEvent AS LE WITH (NOLOCK)
                                                                                                            WHERE    LE.MRSessionID = R.MRSessionID
                                                                                                                     AND LE.LockerID = RS.LockerID
                                                                                                                     AND LE.EventType = 'C'
                                                                                                                     AND LE.InvoiceID IS NULL
                                                                                                                     AND LE.AncillaryData IS NOT NULL
                                                                                                            UNION
                                                                                                            SELECT   LE.EventType,
                                                                                                                     Count(*) AS Cnt
                                                                                                            FROM     InvoiceLockerEvent AS LE WITH (NOLOCK)
                                                                                                            WHERE    LE.MRSessionID = R.MRSessionID
                                                                                                                     AND LE.LockerID = RS.LockerID
                                                                                                                     AND LE.EventType IN ('N', 'R')
                                                                                                                     AND LE.InvoiceID IS NOT NULL
                                                                                                            GROUP BY LE.EventType) AS LE_Counts</td>
        <td>321</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">
FROM InvoiceLockerEvent AS LE WITH (NOLOCK)</td>
        <td>323</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">
FROM dbo.fnVarcharListToTable(LE.AncillaryData) AS AD</td>
        <td>324</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">
FROM InvoiceLockerEvent AS LE WITH (NOLOCK)</td>
        <td>325</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">
FROM InvoiceLockerEvent AS LE WITH (NOLOCK)</td>
        <td>333</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">
FROM @Recordset AS R OUTER APPLY (SELECT Sum(CASE WHEN MS.SubStopOrdinal = 1 THEN 1 ELSE 0 END) AS OtherStopsT,
                                         Sum(CASE WHEN MS.SubStopOrdinal = 1
                                                       AND IsNull(MSS.VisitStatusID, 0) = 1 THEN 1 ELSE 0 END) AS OtherStopsC
                                  FROM   ManifestHistoryStop AS MS WITH (NOLOCK)
                                         INNER JOIN
                                         RouteStop AS RS WITH (NOLOCK)
                                         ON RS.InstanceID = MS.StopID
                                            AND (RS.ServiceType &amp; 32768) &lt;&gt; 0
                                         LEFT OUTER JOIN
                                         ManifestHistoryStopStatus AS MSS WITH (NOLOCK)
                                         ON MSS.ManifestHistoryStopID = MS.InstanceID
                                  WHERE  MS.ManifestID = R.ManifestID
                                         AND MS.ClientAccountID &lt;&gt; 'D796891E-02F2-4803-999A-1AD0BF9BE58B') AS SS</td>
        <td>381</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">
FROM ManifestHistoryStop AS MS WITH (NOLOCK)
     INNER JOIN
     RouteStop AS RS WITH (NOLOCK)
     ON RS.InstanceID = MS.StopID
        AND (RS.ServiceType &amp; 32768) &lt;&gt; 0
     LEFT OUTER JOIN
     ManifestHistoryStopStatus AS MSS WITH (NOLOCK)
     ON MSS.ManifestHistoryStopID = MS.InstanceID</td>
        <td>386</td>
      </tr>
      <tr valign="top">
        <td colspan="1">APPLY</td>
        <td colspan="1">@Recordset AS R OUTER APPLY (SELECT Min(RouteServiceWindow.StartTime) AS StartTime,
                                    Max(RouteServiceWindow.EndTime) AS EndTime
                             FROM   RouteServiceWindow WITH (NOLOCK)
                             WHERE  RouteServiceWindow.RouteID = R.RouteID) AS SS</td>
        <td>111</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">@Recordset AS R OUTER APPLY (SELECT Sum(CASE WHEN MS.SubStopOrdinal = 1 THEN 1 ELSE 0 END) AS CustomerStopsT,
                                    Sum(CASE WHEN MS.ClientAccountID IS NOT NULL
                                                  AND MS.VisitTypeID &lt;&gt; 0 THEN 1 ELSE 0 END) AS CustomerCountT,
                                    Sum(CASE WHEN MS.SubStopOrdinal = 1
                                                  AND IsNull(MSS.VisitStatusID, 0) = 1 THEN 1 ELSE 0 END) AS CustomerStopsC,
                                    Sum(CASE WHEN MS.ClientAccountID IS NOT NULL
                                                  AND MS.VisitTypeID &lt;&gt; 0
                                                  AND IsNull(MSS.VisitStatusID, 0) = 1 THEN 1 ELSE 0 END) AS CustomerCountC,
                                    Sum(CASE WHEN MS.ClientAccountID IS NOT NULL
                                                  AND MS.VisitTypeID &lt;&gt; 0
                                                  AND IsNull(MSS.VisitStatusID, 0) = 1 THEN MSS.BagsQuantity ELSE 0 END) AS CustomerBagsC,
                                    Sum(CASE WHEN MS.SubStopOrdinal = 1
                                                  AND IsNull(MSS.VisitStatusID, 0) = 0
                                                  AND MS.ETAOffsetSeconds IS NOT NULL
                                                  AND ETA.ETA &lt; @CurrentDateTime THEN 1 ELSE 0 END) AS CustomerStopsL,
                                    Sum(CASE WHEN MS.ClientAccountID IS NOT NULL
                                                  AND MS.VisitTypeID &lt;&gt; 0
                                                  AND IsNull(MSS.VisitStatusID, 0) = 0
                                                  AND MS.ETAOffsetSeconds IS NOT NULL
                                                  AND ETA.ETA &lt; @CurrentDateTime THEN 1 ELSE 0 END) AS CustomerCountL,
                                    Sum(CASE WHEN MS.SubStopOrdinal = 1
                                                  AND IsNull(MSS.VisitStatusID, 0) = 2 THEN 1 ELSE 0 END) AS CustomerStopsDNV,
                                    Sum(CASE WHEN MS.ClientAccountID IS NOT NULL
                                                  AND MS.VisitTypeID &lt;&gt; 0
                                                  AND IsNull(MSS.VisitStatusID, 0) = 2 THEN 1 ELSE 0 END) AS CustomerCountDNV
                             FROM   ManifestHistoryStop AS MS WITH (NOLOCK)
                                    LEFT OUTER JOIN
                                    ManifestHistoryStopStatus AS MSS WITH (NOLOCK)
                                    ON MSS.ManifestHistoryStopID = MS.InstanceID OUTER APPLY (SELECT dbo.RouteGetStopEndingTime(R.SchedStartDateTime, MS.TimeRange, MS.ETAOffsetSeconds) AS ETA) AS ETA
                             WHERE  MS.ManifestID = R.ManifestID
                                    AND MS.ClientAccountID &lt;&gt; 'D796891E-02F2-4803-999A-1AD0BF9BE58B') AS SS</td>
        <td>135</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryStop AS MS WITH (NOLOCK)
LEFT OUTER JOIN
ManifestHistoryStopStatus AS MSS WITH (NOLOCK)
ON MSS.ManifestHistoryStopID = MS.InstanceID OUTER APPLY (SELECT dbo.RouteGetStopEndingTime(R.SchedStartDateTime, MS.TimeRange, MS.ETAOffsetSeconds) AS ETA) AS ETA</td>
        <td>150</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">@Recordset AS R OUTER APPLY (SELECT Count(DISTINCT DC.InvoiceID) AS CustomerOrdersT,
                                    Sum(CASE WHEN DC.OrderStatusID = 1 THEN 1 ELSE 0 END) AS CustomerOrdersDeliveredC,
                                    Sum(CASE WHEN DC.OrderStatusID = 2 THEN 1 ELSE 0 END) AS CustomerOrdersNonDeliveredC
                             FROM   ManifestHistoryStop AS MS WITH (NOLOCK)
                                    LEFT OUTER JOIN
                                    ManifestHistoryStopStatus AS MSS WITH (NOLOCK)
                                    ON MSS.ManifestHistoryStopID = MS.InstanceID OUTER APPLY (SELECT MI.InvoiceID,
                                                                                                     IsNull(MIS.OrderStatusID, 0) AS OrderStatusID
                                                                                              FROM   ManifestHistoryInvoice AS MI WITH (NOLOCK)
                                                                                                     LEFT OUTER JOIN
                                                                                                     ManifestHistoryInvoiceStatus AS MIS WITH (NOLOCK)
                                                                                                     ON MIS.ManifestHistoryInvoiceID = MI.InstanceID
                                                                                                        AND MIS.OrderStatusID IN (1, 2)
                                                                                              WHERE  MI.ManifestHistoryStopID = MS.InstanceID
                                                                                                     AND MI.ManifestExclusionReasonID IS NULL
                                                                                                     AND MI.DelayedFlag IS NULL) AS DC
                             WHERE  MS.ManifestID = R.ManifestID
                                    AND MS.ClientAccountID &lt;&gt; 'D796891E-02F2-4803-999A-1AD0BF9BE58B') AS SS</td>
        <td>167</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryStop AS MS WITH (NOLOCK)
LEFT OUTER JOIN
ManifestHistoryStopStatus AS MSS WITH (NOLOCK)
ON MSS.ManifestHistoryStopID = MS.InstanceID OUTER APPLY (SELECT MI.InvoiceID,
                                                                 IsNull(MIS.OrderStatusID, 0) AS OrderStatusID
                                                          FROM   ManifestHistoryInvoice AS MI WITH (NOLOCK)
                                                                 LEFT OUTER JOIN
                                                                 ManifestHistoryInvoiceStatus AS MIS WITH (NOLOCK)
                                                                 ON MIS.ManifestHistoryInvoiceID = MI.InstanceID
                                                                    AND MIS.OrderStatusID IN (1, 2)
                                                          WHERE  MI.ManifestHistoryStopID = MS.InstanceID
                                                                 AND MI.ManifestExclusionReasonID IS NULL
                                                                 AND MI.DelayedFlag IS NULL) AS DC</td>
        <td>173</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">@Recordset AS R OUTER APPLY (SELECT Sum(CASE WHEN MS.SubStopOrdinal = 1 THEN 1 ELSE 0 END) AS CustomerStopsT,
                                    Sum(CASE WHEN MS.ClientAccountID IS NOT NULL
                                                  AND MS.VisitTypeID &lt;&gt; 0 THEN 1 ELSE 0 END) AS CustomerCountT,
                                    Sum(CASE WHEN MS.SubStopOrdinal = 1
                                                  AND IsNull(MSS.VisitStatusID, 0) = 1 THEN 1 ELSE 0 END) AS CustomerStopsC,
                                    Sum(CASE WHEN MS.ClientAccountID IS NOT NULL
                                                  AND MS.VisitTypeID &lt;&gt; 0
                                                  AND IsNull(MSS.VisitStatusID, 0) = 1 THEN 1 ELSE 0 END) AS CustomerCountC,
                                    Sum(CASE WHEN MS.ClientAccountID IS NOT NULL
                                                  AND MS.VisitTypeID &lt;&gt; 0
                                                  AND IsNull(MSS.VisitStatusID, 0) = 1 THEN MSS.BagsQuantity ELSE 0 END) AS CustomerBagsC,
                                    Sum(CASE WHEN MS.SubStopOrdinal = 1
                                                  AND IsNull(MSS.VisitStatusID, 0) = 0
                                                  AND MS.ETAOffsetSeconds IS NOT NULL
                                                  AND ETA.ETA &lt; @CurrentDateTime THEN 1 ELSE 0 END) AS CustomerStopsL,
                                    Sum(CASE WHEN MS.ClientAccountID IS NOT NULL
                                                  AND MS.VisitTypeID &lt;&gt; 0
                                                  AND IsNull(MSS.VisitStatusID, 0) = 0
                                                  AND MS.ETAOffsetSeconds IS NOT NULL
                                                  AND ETA.ETA &lt; @CurrentDateTime THEN 1 ELSE 0 END) AS CustomerCountL,
                                    Sum(CASE WHEN MS.SubStopOrdinal = 1
                                                  AND IsNull(MSS.VisitStatusID, 0) = 2 THEN 1 ELSE 0 END) AS CustomerStopsDNV,
                                    Sum(CASE WHEN MS.ClientAccountID IS NOT NULL
                                                  AND MS.VisitTypeID &lt;&gt; 0
                                                  AND IsNull(MSS.VisitStatusID, 0) = 2 THEN 1 ELSE 0 END) AS CustomerCountDNV
                             FROM   ManifestHistoryStop AS MS WITH (NOLOCK)
                                    LEFT OUTER JOIN
                                    RouteStop AS RS WITH (NOLOCK)
                                    ON RS.InstanceID = MS.StopID
                                    LEFT OUTER JOIN
                                    ManifestHistoryStopStatus AS MSS WITH (NOLOCK)
                                    ON MSS.ManifestHistoryStopID = MS.InstanceID OUTER APPLY (SELECT dbo.RouteGetStopEndingTime(R.SchedStartDateTime, MS.TimeRange, MS.ETAOffsetSeconds) AS ETA) AS ETA
                             WHERE  MS.ManifestID = R.ManifestID
                                    AND MS.ClientAccountID &lt;&gt; 'D796891E-02F2-4803-999A-1AD0BF9BE58B'
                                    AND ((RS.ServiceType &amp; 15) &lt;&gt; 0
                                         OR MS.StopID IS NULL)) AS SS</td>
        <td>205</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryStop AS MS WITH (NOLOCK)
LEFT OUTER JOIN
RouteStop AS RS WITH (NOLOCK)
ON RS.InstanceID = MS.StopID
LEFT OUTER JOIN
ManifestHistoryStopStatus AS MSS WITH (NOLOCK)
ON MSS.ManifestHistoryStopID = MS.InstanceID OUTER APPLY (SELECT dbo.RouteGetStopEndingTime(R.SchedStartDateTime, MS.TimeRange, MS.ETAOffsetSeconds) AS ETA) AS ETA</td>
        <td>220</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">@Recordset AS R OUTER APPLY (SELECT Count(DISTINCT DC.InvoiceID) AS CustomerOrdersT,
                                    Sum(CASE WHEN DC.OrderStatusID = 1 THEN 1 ELSE 0 END) AS CustomerOrdersDeliveredC,
                                    Sum(CASE WHEN DC.OrderStatusID = 2 THEN 1 ELSE 0 END) AS CustomerOrdersNonDeliveredC
                             FROM   ManifestHistoryStop AS MS WITH (NOLOCK)
                                    LEFT OUTER JOIN
                                    RouteStop AS RS WITH (NOLOCK)
                                    ON RS.InstanceID = MS.StopID
                                    LEFT OUTER JOIN
                                    ManifestHistoryStopStatus AS MSS WITH (NOLOCK)
                                    ON MSS.ManifestHistoryStopID = MS.InstanceID OUTER APPLY (SELECT MI.InvoiceID,
                                                                                                     IsNull(MIS.OrderStatusID, 0) AS OrderStatusID
                                                                                              FROM   ManifestHistoryInvoice AS MI WITH (NOLOCK)
                                                                                                     LEFT OUTER JOIN
                                                                                                     ManifestHistoryInvoiceStatus AS MIS WITH (NOLOCK)
                                                                                                     ON MIS.ManifestHistoryInvoiceID = MI.InstanceID
                                                                                                        AND MIS.OrderStatusID IN (1, 2)
                                                                                              WHERE  MI.ManifestHistoryStopID = MS.InstanceID
                                                                                                     AND MI.ManifestExclusionReasonID IS NULL
                                                                                                     AND MI.DelayedFlag IS NULL) AS DC
                             WHERE  MS.ManifestID = R.ManifestID
                                    AND MS.ClientAccountID &lt;&gt; 'D796891E-02F2-4803-999A-1AD0BF9BE58B'
                                    AND ((RS.ServiceType &amp; 15) &lt;&gt; 0
                                         OR MS.StopID IS NULL)) AS SS</td>
        <td>239</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryStop AS MS WITH (NOLOCK)
LEFT OUTER JOIN
RouteStop AS RS WITH (NOLOCK)
ON RS.InstanceID = MS.StopID
LEFT OUTER JOIN
ManifestHistoryStopStatus AS MSS WITH (NOLOCK)
ON MSS.ManifestHistoryStopID = MS.InstanceID OUTER APPLY (SELECT MI.InvoiceID,
                                                                 IsNull(MIS.OrderStatusID, 0) AS OrderStatusID
                                                          FROM   ManifestHistoryInvoice AS MI WITH (NOLOCK)
                                                                 LEFT OUTER JOIN
                                                                 ManifestHistoryInvoiceStatus AS MIS WITH (NOLOCK)
                                                                 ON MIS.ManifestHistoryInvoiceID = MI.InstanceID
                                                                    AND MIS.OrderStatusID IN (1, 2)
                                                          WHERE  MI.ManifestHistoryStopID = MS.InstanceID
                                                                 AND MI.ManifestExclusionReasonID IS NULL
                                                                 AND MI.DelayedFlag IS NULL) AS DC</td>
        <td>245</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">@Recordset AS R OUTER APPLY (SELECT Count(DISTINCT RS.InstanceID) AS LockerStopsT,
                                    Sum(CASE WHEN RS_C.StopSubType = 'P' THEN 1 ELSE 0 END) AS LockerPickupsT,
                                    Sum(CASE WHEN RS_C.StopSubType = 'D' THEN 1 ELSE 0 END) AS LockerDeliveriesT
                             FROM   ManifestHistoryStop AS MS WITH (NOLOCK)
                                    INNER JOIN
                                    RouteStop AS RS WITH (NOLOCK)
                                    ON RS.InstanceID = MS.StopID
                                       AND RS.LockerID IS NOT NULL
                                       AND (RS.ServiceType &amp; 48) &lt;&gt; 0 OUTER APPLY (SELECT DISTINCT ClientAccountID,
                                                                                                   StopSubType
                                                                                   FROM   RouteStop WITH (NOLOCK)
                                                                                   WHERE  RouteStop.InstanceID = MS.StopID
                                                                                          AND (RouteStop.ServiceType &amp; 48) &lt;&gt; 0
                                                                                          AND RouteStop.LockerID IS NOT NULL
                                                                                          AND MS.StopSubType IN ('D', 'P')) AS RS_C
                             WHERE  MS.ManifestID = R.ManifestID
                                    AND MS.ClientAccountID &lt;&gt; 'D796891E-02F2-4803-999A-1AD0BF9BE58B') AS SS</td>
        <td>270</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryStop AS MS WITH (NOLOCK)
INNER JOIN
RouteStop AS RS WITH (NOLOCK)
ON RS.InstanceID = MS.StopID
   AND RS.LockerID IS NOT NULL
   AND (RS.ServiceType &amp; 48) &lt;&gt; 0 OUTER APPLY (SELECT DISTINCT ClientAccountID,
                                                               StopSubType
                                               FROM   RouteStop WITH (NOLOCK)
                                               WHERE  RouteStop.InstanceID = MS.StopID
                                                      AND (RouteStop.ServiceType &amp; 48) &lt;&gt; 0
                                                      AND RouteStop.LockerID IS NOT NULL
                                                      AND MS.StopSubType IN ('D', 'P')) AS RS_C</td>
        <td>276</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">@Recordset AS R OUTER APPLY (SELECT Count(DISTINCT MI.InvoiceID) AS LockerOrderCountT
                             FROM   ManifestHistoryStop AS MS WITH (NOLOCK)
                                    INNER JOIN
                                    RouteStop AS RS WITH (NOLOCK)
                                    ON RS.InstanceID = MS.StopID
                                       AND RS.LockerID IS NOT NULL
                                       AND (RS.ServiceType &amp; 48) &lt;&gt; 0
                                    INNER JOIN
                                    ManifestHistoryInvoice AS MI WITH (NOLOCK)
                                    ON MI.ManifestHistoryStopID = MS.InstanceID
                                       AND MI.ManifestExclusionReasonID IS NULL
                                       AND MI.DelayedFlag IS NULL
                             WHERE  MS.ManifestID = R.ManifestID
                                    AND MS.ClientAccountID &lt;&gt; 'D796891E-02F2-4803-999A-1AD0BF9BE58B'
                                    AND MS.StopSubType = 'D') AS SS</td>
        <td>291</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">@Recordset AS R OUTER APPLY (SELECT Count(DISTINCT LE_End.InstanceNumber) AS LockerStopsC,
                                    Sum(CASE WHEN LE_Counts.EventType = 'C' THEN LE_Counts.Cnt ELSE 0 END) AS LockerBagCountC,
                                    Sum(CASE WHEN LE_Counts.EventType = 'R' THEN LE_Counts.Cnt ELSE 0 END) AS DeliveryOrderCountC,
                                    Sum(CASE WHEN LE_Counts.EventType = 'N' THEN LE_Counts.Cnt ELSE 0 END) AS NonDeliveryOrderCountC
                             FROM   ManifestHistoryStop AS MS WITH (NOLOCK)
                                    INNER JOIN
                                    RouteStop AS RS WITH (NOLOCK)
                                    ON RS.InstanceID = MS.StopID
                                       AND RS.LockerID IS NOT NULL
                                       AND (RS.ServiceType &amp; 48) &lt;&gt; 0 OUTER APPLY (SELECT   TOP 1 LE.InstanceNumber
                                                                                   FROM     InvoiceLockerEvent AS LE WITH (NOLOCK)
                                                                                   WHERE    LE.MRSessionID = R.MRSessionID
                                                                                            AND LE.LockerID = RS.LockerID
                                                                                            AND LE.EventType = 'Z'
                                                                                   ORDER BY LE.InstanceNumber DESC) AS LE_End OUTER APPLY (SELECT   LE.EventType,
                                                                                                                                                    (SELECT CAST (Val AS INT)
                                                                                                                                                     FROM   dbo.fnVarcharListToTable(LE.AncillaryData) AS AD
                                                                                                                                                     WHERE  AD.ID = 1) AS Cnt
                                                                                                                                           FROM     InvoiceLockerEvent AS LE WITH (NOLOCK)
                                                                                                                                           WHERE    LE.MRSessionID = R.MRSessionID
                                                                                                                                                    AND LE.LockerID = RS.LockerID
                                                                                                                                                    AND LE.EventType = 'C'
                                                                                                                                                    AND LE.InvoiceID IS NULL
                                                                                                                                                    AND LE.AncillaryData IS NOT NULL
                                                                                                                                           UNION
                                                                                                                                           SELECT   LE.EventType,
                                                                                                                                                    Count(*) AS Cnt
                                                                                                                                           FROM     InvoiceLockerEvent AS LE WITH (NOLOCK)
                                                                                                                                           WHERE    LE.MRSessionID = R.MRSessionID
                                                                                                                                                    AND LE.LockerID = RS.LockerID
                                                                                                                                                    AND LE.EventType IN ('N', 'R')
                                                                                                                                                    AND LE.InvoiceID IS NOT NULL
                                                                                                                                           GROUP BY LE.EventType) AS LE_Counts
                             WHERE  MS.ManifestID = R.ManifestID
                                    AND MS.ClientAccountID &lt;&gt; 'D796891E-02F2-4803-999A-1AD0BF9BE58B'
                                    AND LE_End.InstanceNumber IS NOT NULL) AS SS</td>
        <td>314</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryStop AS MS WITH (NOLOCK)
INNER JOIN
RouteStop AS RS WITH (NOLOCK)
ON RS.InstanceID = MS.StopID
   AND RS.LockerID IS NOT NULL
   AND (RS.ServiceType &amp; 48) &lt;&gt; 0 OUTER APPLY (SELECT   TOP 1 LE.InstanceNumber
                                               FROM     InvoiceLockerEvent AS LE WITH (NOLOCK)
                                               WHERE    LE.MRSessionID = R.MRSessionID
                                                        AND LE.LockerID = RS.LockerID
                                                        AND LE.EventType = 'Z'
                                               ORDER BY LE.InstanceNumber DESC) AS LE_End OUTER APPLY (SELECT   LE.EventType,
                                                                                                                (SELECT CAST (Val AS INT)
                                                                                                                 FROM   dbo.fnVarcharListToTable(LE.AncillaryData) AS AD
                                                                                                                 WHERE  AD.ID = 1) AS Cnt
                                                                                                       FROM     InvoiceLockerEvent AS LE WITH (NOLOCK)
                                                                                                       WHERE    LE.MRSessionID = R.MRSessionID
                                                                                                                AND LE.LockerID = RS.LockerID
                                                                                                                AND LE.EventType = 'C'
                                                                                                                AND LE.InvoiceID IS NULL
                                                                                                                AND LE.AncillaryData IS NOT NULL
                                                                                                       UNION
                                                                                                       SELECT   LE.EventType,
                                                                                                                Count(*) AS Cnt
                                                                                                       FROM     InvoiceLockerEvent AS LE WITH (NOLOCK)
                                                                                                       WHERE    LE.MRSessionID = R.MRSessionID
                                                                                                                AND LE.LockerID = RS.LockerID
                                                                                                                AND LE.EventType IN ('N', 'R')
                                                                                                                AND LE.InvoiceID IS NOT NULL
                                                                                                       GROUP BY LE.EventType) AS LE_Counts</td>
        <td>321</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryStop AS MS WITH (NOLOCK)
INNER JOIN
RouteStop AS RS WITH (NOLOCK)
ON RS.InstanceID = MS.StopID
   AND RS.LockerID IS NOT NULL
   AND (RS.ServiceType &amp; 48) &lt;&gt; 0 OUTER APPLY (SELECT   TOP 1 LE.InstanceNumber
                                               FROM     InvoiceLockerEvent AS LE WITH (NOLOCK)
                                               WHERE    LE.MRSessionID = R.MRSessionID
                                                        AND LE.LockerID = RS.LockerID
                                                        AND LE.EventType = 'Z'
                                               ORDER BY LE.InstanceNumber DESC) AS LE_End</td>
        <td>321</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">@Recordset AS R OUTER APPLY (SELECT Sum(CASE WHEN MS.SubStopOrdinal = 1 THEN 1 ELSE 0 END) AS OtherStopsT,
                                    Sum(CASE WHEN MS.SubStopOrdinal = 1
                                                  AND IsNull(MSS.VisitStatusID, 0) = 1 THEN 1 ELSE 0 END) AS OtherStopsC
                             FROM   ManifestHistoryStop AS MS WITH (NOLOCK)
                                    INNER JOIN
                                    RouteStop AS RS WITH (NOLOCK)
                                    ON RS.InstanceID = MS.StopID
                                       AND (RS.ServiceType &amp; 32768) &lt;&gt; 0
                                    LEFT OUTER JOIN
                                    ManifestHistoryStopStatus AS MSS WITH (NOLOCK)
                                    ON MSS.ManifestHistoryStopID = MS.InstanceID
                             WHERE  MS.ManifestID = R.ManifestID
                                    AND MS.ClientAccountID &lt;&gt; 'D796891E-02F2-4803-999A-1AD0BF9BE58B') AS SS</td>
        <td>381</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">@Recordset AS R
INNER JOIN
ManifestHistoryStop AS MS WITH (NOLOCK)
ON MS.ManifestID = R.ManifestID
   AND MS.SubStopOrdinal = 1
   AND MS.ClientAccountID &lt;&gt; 'D796891E-02F2-4803-999A-1AD0BF9BE58B'
LEFT OUTER JOIN
RouteStop AS RS WITH (NOLOCK)
ON RS.InstanceID = MS.StopID
LEFT OUTER JOIN
ManifestHistoryStopStatus AS MSS WITH (NOLOCK)
ON MSS.ManifestHistoryStopID = MS.InstanceID OUTER APPLY (SELECT dbo.RouteGetStopEndingTime(R.SchedStartDateTime, MS.TimeRange, MS.ETAOffsetSeconds) AS ETA) AS ETA</td>
        <td>431</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">Subquery</td>
        <td colspan="1">(SELECT Min(RouteServiceWindow.StartTime) AS StartTime,
        Max(RouteServiceWindow.EndTime) AS EndTime
 FROM   RouteServiceWindow WITH (NOLOCK)
 WHERE  RouteServiceWindow.RouteID = R.RouteID) AS SS</td>
        <td>112</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">(SELECT Sum(CASE WHEN MS.SubStopOrdinal = 1 THEN 1 ELSE 0 END) AS CustomerStopsT,
        Sum(CASE WHEN MS.ClientAccountID IS NOT NULL
                      AND MS.VisitTypeID &lt;&gt; 0 THEN 1 ELSE 0 END) AS CustomerCountT,
        Sum(CASE WHEN MS.SubStopOrdinal = 1
                      AND IsNull(MSS.VisitStatusID, 0) = 1 THEN 1 ELSE 0 END) AS CustomerStopsC,
        Sum(CASE WHEN MS.ClientAccountID IS NOT NULL
                      AND MS.VisitTypeID &lt;&gt; 0
                      AND IsNull(MSS.VisitStatusID, 0) = 1 THEN 1 ELSE 0 END) AS CustomerCountC,
        Sum(CASE WHEN MS.ClientAccountID IS NOT NULL
                      AND MS.VisitTypeID &lt;&gt; 0
                      AND IsNull(MSS.VisitStatusID, 0) = 1 THEN MSS.BagsQuantity ELSE 0 END) AS CustomerBagsC,
        Sum(CASE WHEN MS.SubStopOrdinal = 1
                      AND IsNull(MSS.VisitStatusID, 0) = 0
                      AND MS.ETAOffsetSeconds IS NOT NULL
                      AND ETA.ETA &lt; @CurrentDateTime THEN 1 ELSE 0 END) AS CustomerStopsL,
        Sum(CASE WHEN MS.ClientAccountID IS NOT NULL
                      AND MS.VisitTypeID &lt;&gt; 0
                      AND IsNull(MSS.VisitStatusID, 0) = 0
                      AND MS.ETAOffsetSeconds IS NOT NULL
                      AND ETA.ETA &lt; @CurrentDateTime THEN 1 ELSE 0 END) AS CustomerCountL,
        Sum(CASE WHEN MS.SubStopOrdinal = 1
                      AND IsNull(MSS.VisitStatusID, 0) = 2 THEN 1 ELSE 0 END) AS CustomerStopsDNV,
        Sum(CASE WHEN MS.ClientAccountID IS NOT NULL
                      AND MS.VisitTypeID &lt;&gt; 0
                      AND IsNull(MSS.VisitStatusID, 0) = 2 THEN 1 ELSE 0 END) AS CustomerCountDNV
 FROM   ManifestHistoryStop AS MS WITH (NOLOCK)
        LEFT OUTER JOIN
        ManifestHistoryStopStatus AS MSS WITH (NOLOCK)
        ON MSS.ManifestHistoryStopID = MS.InstanceID OUTER APPLY (SELECT dbo.RouteGetStopEndingTime(R.SchedStartDateTime, MS.TimeRange, MS.ETAOffsetSeconds) AS ETA) AS ETA
 WHERE  MS.ManifestID = R.ManifestID
        AND MS.ClientAccountID &lt;&gt; 'D796891E-02F2-4803-999A-1AD0BF9BE58B') AS SS</td>
        <td>136</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">(SELECT dbo.RouteGetStopEndingTime(R.SchedStartDateTime, MS.TimeRange, MS.ETAOffsetSeconds) AS ETA) AS ETA</td>
        <td>152</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">(SELECT Count(DISTINCT DC.InvoiceID) AS CustomerOrdersT,
        Sum(CASE WHEN DC.OrderStatusID = 1 THEN 1 ELSE 0 END) AS CustomerOrdersDeliveredC,
        Sum(CASE WHEN DC.OrderStatusID = 2 THEN 1 ELSE 0 END) AS CustomerOrdersNonDeliveredC
 FROM   ManifestHistoryStop AS MS WITH (NOLOCK)
        LEFT OUTER JOIN
        ManifestHistoryStopStatus AS MSS WITH (NOLOCK)
        ON MSS.ManifestHistoryStopID = MS.InstanceID OUTER APPLY (SELECT MI.InvoiceID,
                                                                         IsNull(MIS.OrderStatusID, 0) AS OrderStatusID
                                                                  FROM   ManifestHistoryInvoice AS MI WITH (NOLOCK)
                                                                         LEFT OUTER JOIN
                                                                         ManifestHistoryInvoiceStatus AS MIS WITH (NOLOCK)
                                                                         ON MIS.ManifestHistoryInvoiceID = MI.InstanceID
                                                                            AND MIS.OrderStatusID IN (1, 2)
                                                                  WHERE  MI.ManifestHistoryStopID = MS.InstanceID
                                                                         AND MI.ManifestExclusionReasonID IS NULL
                                                                         AND MI.DelayedFlag IS NULL) AS DC
 WHERE  MS.ManifestID = R.ManifestID
        AND MS.ClientAccountID &lt;&gt; 'D796891E-02F2-4803-999A-1AD0BF9BE58B') AS SS</td>
        <td>168</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">(SELECT MI.InvoiceID,
        IsNull(MIS.OrderStatusID, 0) AS OrderStatusID
 FROM   ManifestHistoryInvoice AS MI WITH (NOLOCK)
        LEFT OUTER JOIN
        ManifestHistoryInvoiceStatus AS MIS WITH (NOLOCK)
        ON MIS.ManifestHistoryInvoiceID = MI.InstanceID
           AND MIS.OrderStatusID IN (1, 2)
 WHERE  MI.ManifestHistoryStopID = MS.InstanceID
        AND MI.ManifestExclusionReasonID IS NULL
        AND MI.DelayedFlag IS NULL) AS DC</td>
        <td>175</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">(SELECT Sum(CASE WHEN MS.SubStopOrdinal = 1 THEN 1 ELSE 0 END) AS CustomerStopsT,
        Sum(CASE WHEN MS.ClientAccountID IS NOT NULL
                      AND MS.VisitTypeID &lt;&gt; 0 THEN 1 ELSE 0 END) AS CustomerCountT,
        Sum(CASE WHEN MS.SubStopOrdinal = 1
                      AND IsNull(MSS.VisitStatusID, 0) = 1 THEN 1 ELSE 0 END) AS CustomerStopsC,
        Sum(CASE WHEN MS.ClientAccountID IS NOT NULL
                      AND MS.VisitTypeID &lt;&gt; 0
                      AND IsNull(MSS.VisitStatusID, 0) = 1 THEN 1 ELSE 0 END) AS CustomerCountC,
        Sum(CASE WHEN MS.ClientAccountID IS NOT NULL
                      AND MS.VisitTypeID &lt;&gt; 0
                      AND IsNull(MSS.VisitStatusID, 0) = 1 THEN MSS.BagsQuantity ELSE 0 END) AS CustomerBagsC,
        Sum(CASE WHEN MS.SubStopOrdinal = 1
                      AND IsNull(MSS.VisitStatusID, 0) = 0
                      AND MS.ETAOffsetSeconds IS NOT NULL
                      AND ETA.ETA &lt; @CurrentDateTime THEN 1 ELSE 0 END) AS CustomerStopsL,
        Sum(CASE WHEN MS.ClientAccountID IS NOT NULL
                      AND MS.VisitTypeID &lt;&gt; 0
                      AND IsNull(MSS.VisitStatusID, 0) = 0
                      AND MS.ETAOffsetSeconds IS NOT NULL
                      AND ETA.ETA &lt; @CurrentDateTime THEN 1 ELSE 0 END) AS CustomerCountL,
        Sum(CASE WHEN MS.SubStopOrdinal = 1
                      AND IsNull(MSS.VisitStatusID, 0) = 2 THEN 1 ELSE 0 END) AS CustomerStopsDNV,
        Sum(CASE WHEN MS.ClientAccountID IS NOT NULL
                      AND MS.VisitTypeID &lt;&gt; 0
                      AND IsNull(MSS.VisitStatusID, 0) = 2 THEN 1 ELSE 0 END) AS CustomerCountDNV
 FROM   ManifestHistoryStop AS MS WITH (NOLOCK)
        LEFT OUTER JOIN
        RouteStop AS RS WITH (NOLOCK)
        ON RS.InstanceID = MS.StopID
        LEFT OUTER JOIN
        ManifestHistoryStopStatus AS MSS WITH (NOLOCK)
        ON MSS.ManifestHistoryStopID = MS.InstanceID OUTER APPLY (SELECT dbo.RouteGetStopEndingTime(R.SchedStartDateTime, MS.TimeRange, MS.ETAOffsetSeconds) AS ETA) AS ETA
 WHERE  MS.ManifestID = R.ManifestID
        AND MS.ClientAccountID &lt;&gt; 'D796891E-02F2-4803-999A-1AD0BF9BE58B'
        AND ((RS.ServiceType &amp; 15) &lt;&gt; 0
             OR MS.StopID IS NULL)) AS SS</td>
        <td>206</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">(SELECT dbo.RouteGetStopEndingTime(R.SchedStartDateTime, MS.TimeRange, MS.ETAOffsetSeconds) AS ETA) AS ETA</td>
        <td>223</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">(SELECT Count(DISTINCT DC.InvoiceID) AS CustomerOrdersT,
        Sum(CASE WHEN DC.OrderStatusID = 1 THEN 1 ELSE 0 END) AS CustomerOrdersDeliveredC,
        Sum(CASE WHEN DC.OrderStatusID = 2 THEN 1 ELSE 0 END) AS CustomerOrdersNonDeliveredC
 FROM   ManifestHistoryStop AS MS WITH (NOLOCK)
        LEFT OUTER JOIN
        RouteStop AS RS WITH (NOLOCK)
        ON RS.InstanceID = MS.StopID
        LEFT OUTER JOIN
        ManifestHistoryStopStatus AS MSS WITH (NOLOCK)
        ON MSS.ManifestHistoryStopID = MS.InstanceID OUTER APPLY (SELECT MI.InvoiceID,
                                                                         IsNull(MIS.OrderStatusID, 0) AS OrderStatusID
                                                                  FROM   ManifestHistoryInvoice AS MI WITH (NOLOCK)
                                                                         LEFT OUTER JOIN
                                                                         ManifestHistoryInvoiceStatus AS MIS WITH (NOLOCK)
                                                                         ON MIS.ManifestHistoryInvoiceID = MI.InstanceID
                                                                            AND MIS.OrderStatusID IN (1, 2)
                                                                  WHERE  MI.ManifestHistoryStopID = MS.InstanceID
                                                                         AND MI.ManifestExclusionReasonID IS NULL
                                                                         AND MI.DelayedFlag IS NULL) AS DC
 WHERE  MS.ManifestID = R.ManifestID
        AND MS.ClientAccountID &lt;&gt; 'D796891E-02F2-4803-999A-1AD0BF9BE58B'
        AND ((RS.ServiceType &amp; 15) &lt;&gt; 0
             OR MS.StopID IS NULL)) AS SS</td>
        <td>240</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">(SELECT MI.InvoiceID,
        IsNull(MIS.OrderStatusID, 0) AS OrderStatusID
 FROM   ManifestHistoryInvoice AS MI WITH (NOLOCK)
        LEFT OUTER JOIN
        ManifestHistoryInvoiceStatus AS MIS WITH (NOLOCK)
        ON MIS.ManifestHistoryInvoiceID = MI.InstanceID
           AND MIS.OrderStatusID IN (1, 2)
 WHERE  MI.ManifestHistoryStopID = MS.InstanceID
        AND MI.ManifestExclusionReasonID IS NULL
        AND MI.DelayedFlag IS NULL) AS DC</td>
        <td>248</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">(SELECT Count(DISTINCT RS.InstanceID) AS LockerStopsT,
        Sum(CASE WHEN RS_C.StopSubType = 'P' THEN 1 ELSE 0 END) AS LockerPickupsT,
        Sum(CASE WHEN RS_C.StopSubType = 'D' THEN 1 ELSE 0 END) AS LockerDeliveriesT
 FROM   ManifestHistoryStop AS MS WITH (NOLOCK)
        INNER JOIN
        RouteStop AS RS WITH (NOLOCK)
        ON RS.InstanceID = MS.StopID
           AND RS.LockerID IS NOT NULL
           AND (RS.ServiceType &amp; 48) &lt;&gt; 0 OUTER APPLY (SELECT DISTINCT ClientAccountID,
                                                                       StopSubType
                                                       FROM   RouteStop WITH (NOLOCK)
                                                       WHERE  RouteStop.InstanceID = MS.StopID
                                                              AND (RouteStop.ServiceType &amp; 48) &lt;&gt; 0
                                                              AND RouteStop.LockerID IS NOT NULL
                                                              AND MS.StopSubType IN ('D', 'P')) AS RS_C
 WHERE  MS.ManifestID = R.ManifestID
        AND MS.ClientAccountID &lt;&gt; 'D796891E-02F2-4803-999A-1AD0BF9BE58B') AS SS</td>
        <td>271</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">(SELECT DISTINCT ClientAccountID,
                 StopSubType
 FROM   RouteStop WITH (NOLOCK)
 WHERE  RouteStop.InstanceID = MS.StopID
        AND (RouteStop.ServiceType &amp; 48) &lt;&gt; 0
        AND RouteStop.LockerID IS NOT NULL
        AND MS.StopSubType IN ('D', 'P')) AS RS_C</td>
        <td>278</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">(SELECT Count(DISTINCT MI.InvoiceID) AS LockerOrderCountT
 FROM   ManifestHistoryStop AS MS WITH (NOLOCK)
        INNER JOIN
        RouteStop AS RS WITH (NOLOCK)
        ON RS.InstanceID = MS.StopID
           AND RS.LockerID IS NOT NULL
           AND (RS.ServiceType &amp; 48) &lt;&gt; 0
        INNER JOIN
        ManifestHistoryInvoice AS MI WITH (NOLOCK)
        ON MI.ManifestHistoryStopID = MS.InstanceID
           AND MI.ManifestExclusionReasonID IS NULL
           AND MI.DelayedFlag IS NULL
 WHERE  MS.ManifestID = R.ManifestID
        AND MS.ClientAccountID &lt;&gt; 'D796891E-02F2-4803-999A-1AD0BF9BE58B'
        AND MS.StopSubType = 'D') AS SS</td>
        <td>292</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">(SELECT Count(DISTINCT LE_End.InstanceNumber) AS LockerStopsC,
        Sum(CASE WHEN LE_Counts.EventType = 'C' THEN LE_Counts.Cnt ELSE 0 END) AS LockerBagCountC,
        Sum(CASE WHEN LE_Counts.EventType = 'R' THEN LE_Counts.Cnt ELSE 0 END) AS DeliveryOrderCountC,
        Sum(CASE WHEN LE_Counts.EventType = 'N' THEN LE_Counts.Cnt ELSE 0 END) AS NonDeliveryOrderCountC
 FROM   ManifestHistoryStop AS MS WITH (NOLOCK)
        INNER JOIN
        RouteStop AS RS WITH (NOLOCK)
        ON RS.InstanceID = MS.StopID
           AND RS.LockerID IS NOT NULL
           AND (RS.ServiceType &amp; 48) &lt;&gt; 0 OUTER APPLY (SELECT   TOP 1 LE.InstanceNumber
                                                       FROM     InvoiceLockerEvent AS LE WITH (NOLOCK)
                                                       WHERE    LE.MRSessionID = R.MRSessionID
                                                                AND LE.LockerID = RS.LockerID
                                                                AND LE.EventType = 'Z'
                                                       ORDER BY LE.InstanceNumber DESC) AS LE_End OUTER APPLY (SELECT   LE.EventType,
                                                                                                                        (SELECT CAST (Val AS INT)
                                                                                                                         FROM   dbo.fnVarcharListToTable(LE.AncillaryData) AS AD
                                                                                                                         WHERE  AD.ID = 1) AS Cnt
                                                                                                               FROM     InvoiceLockerEvent AS LE WITH (NOLOCK)
                                                                                                               WHERE    LE.MRSessionID = R.MRSessionID
                                                                                                                        AND LE.LockerID = RS.LockerID
                                                                                                                        AND LE.EventType = 'C'
                                                                                                                        AND LE.InvoiceID IS NULL
                                                                                                                        AND LE.AncillaryData IS NOT NULL
                                                                                                               UNION
                                                                                                               SELECT   LE.EventType,
                                                                                                                        Count(*) AS Cnt
                                                                                                               FROM     InvoiceLockerEvent AS LE WITH (NOLOCK)
                                                                                                               WHERE    LE.MRSessionID = R.MRSessionID
                                                                                                                        AND LE.LockerID = RS.LockerID
                                                                                                                        AND LE.EventType IN ('N', 'R')
                                                                                                                        AND LE.InvoiceID IS NOT NULL
                                                                                                               GROUP BY LE.EventType) AS LE_Counts
 WHERE  MS.ManifestID = R.ManifestID
        AND MS.ClientAccountID &lt;&gt; 'D796891E-02F2-4803-999A-1AD0BF9BE58B'
        AND LE_End.InstanceNumber IS NOT NULL) AS SS</td>
        <td>315</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">(SELECT   TOP 1 LE.InstanceNumber
 FROM     InvoiceLockerEvent AS LE WITH (NOLOCK)
 WHERE    LE.MRSessionID = R.MRSessionID
          AND LE.LockerID = RS.LockerID
          AND LE.EventType = 'Z'
 ORDER BY LE.InstanceNumber DESC) AS LE_End</td>
        <td>323</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">(SELECT   LE.EventType,
          (SELECT CAST (Val AS INT)
           FROM   dbo.fnVarcharListToTable(LE.AncillaryData) AS AD
           WHERE  AD.ID = 1) AS Cnt
 FROM     InvoiceLockerEvent AS LE WITH (NOLOCK)
 WHERE    LE.MRSessionID = R.MRSessionID
          AND LE.LockerID = RS.LockerID
          AND LE.EventType = 'C'
          AND LE.InvoiceID IS NULL
          AND LE.AncillaryData IS NOT NULL
 UNION
 SELECT   LE.EventType,
          Count(*) AS Cnt
 FROM     InvoiceLockerEvent AS LE WITH (NOLOCK)
 WHERE    LE.MRSessionID = R.MRSessionID
          AND LE.LockerID = RS.LockerID
          AND LE.EventType IN ('N', 'R')
          AND LE.InvoiceID IS NOT NULL
 GROUP BY LE.EventType) AS LE_Counts</td>
        <td>324</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">(SELECT CAST (Val AS INT)
 FROM   dbo.fnVarcharListToTable(LE.AncillaryData) AS AD
 WHERE  AD.ID = 1)</td>
        <td>324</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">(SELECT Sum(CASE WHEN MS.SubStopOrdinal = 1 THEN 1 ELSE 0 END) AS OtherStopsT,
        Sum(CASE WHEN MS.SubStopOrdinal = 1
                      AND IsNull(MSS.VisitStatusID, 0) = 1 THEN 1 ELSE 0 END) AS OtherStopsC
 FROM   ManifestHistoryStop AS MS WITH (NOLOCK)
        INNER JOIN
        RouteStop AS RS WITH (NOLOCK)
        ON RS.InstanceID = MS.StopID
           AND (RS.ServiceType &amp; 32768) &lt;&gt; 0
        LEFT OUTER JOIN
        ManifestHistoryStopStatus AS MSS WITH (NOLOCK)
        ON MSS.ManifestHistoryStopID = MS.InstanceID
 WHERE  MS.ManifestID = R.ManifestID
        AND MS.ClientAccountID &lt;&gt; 'D796891E-02F2-4803-999A-1AD0BF9BE58B') AS SS</td>
        <td>382</td>
      </tr>
      <tr valign="top">
        <td colspan="1">DISTINCT</td>
        <td colspan="1">Count(DISTINCT DC.InvoiceID)</td>
        <td>169</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">Count(DISTINCT DC.InvoiceID)</td>
        <td>241</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">Count(DISTINCT RS.InstanceID)</td>
        <td>272</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">Count(DISTINCT MI.InvoiceID)</td>
        <td>293</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">Count(DISTINCT LE_End.InstanceNumber)</td>
        <td>316</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">*</td>
        <td colspan="1">SELECT   'RS' AS RecordType,
         R.*
FROM     @Recordset AS R
ORDER BY R.ID</td>
        <td>397</td>
      </tr>
      <tr valign="top">
        <td colspan="1">LEFT</td>
        <td colspan="1">LEFT(CONVERT (VARCHAR (50), DateAdd(second, MS.ETAOffsetSeconds, R.SchedEndDateTime), 126), 19)</td>
        <td>424</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">LEFT(CONVERT (VARCHAR (50), ETA.ETA, 126), 19)</td>
        <td>425</td>
      </tr>
    </table>
  </body>
</html>