<?xml version="1.0" encoding="utf-8"?>
<html>
  <head>
    <title>Native Compilation Advisor evaluation results for [API_SPOT2000].[SPReport_RouteTracActivity]</title>
  </head>
  <body>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 14pt;">
      <b>Native Compilation Advisor evaluation results for [API_SPOT2000].[SPReport_RouteTracActivity]</b>
    </p>
    <p STYLE="font-family: Verdana, Arial, sans-serif; font-size: 10pt;">
      <b>Report Date/Time:</b>3/11/2019 10:31 AM<br /></p>
    <table border="1" cellpadding="5" cellspacing="0" STYLE="font-family: Verdana, Arial, sans-serif; font-size: 9pt;">
      <tr style="background-color:Silver">
        <th colspan="1" align="center">Transact-SQL Element</th>
        <th align="center">Transact-SQL Code</th>
        <th align="center">Line Number</th>
      </tr>
      <tr valign="top">
        <td colspan="1">SET OPTION ON</td>
        <td colspan="1">SET NOCOUNT ON</td>
        <td>6</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">CASE</td>
        <td colspan="1">CASE WHEN MRSession.EndDateTime IS NULL THEN NULL WHEN MRSession.EndDateTime &lt;= MRSession.StartDateTime THEN 0 ELSE DateDiff(second, MRSession.StartDateTime, MRSession.EndDateTime) END</td>
        <td>33</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN MRSession.EndMileage IS NULL THEN NULL WHEN MRSession.EndMileage &lt;= MRSession.StartMileage THEN 0 ELSE MRSession.EndMileage - MRSession.StartMileage END</td>
        <td>37</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN IsNull(@UseMetricDistanceUnits, 0) = 0 THEN IsNull(MH.EstimatedDistanceM, 0) * 0.0006213709999975145 ELSE IsNull(MH.EstimatedDistanceM, 0) END</td>
        <td>38</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN MS.DeliveryDays IN ('-------', 'On Dmnd') THEN '' ELSE 'Static' END</td>
        <td>100</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN MS.DeliveryDays IN ('-------', 'On Dmnd') THEN 'Yes' ELSE '' END</td>
        <td>101</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN IsNull(Route.StartTime, 0) &gt; 0
          AND MS.ETAOffsetSeconds IS NOT NULL
          AND MS.ETAOffsetSeconds &gt;= 0 THEN DateAdd(second, MS.ETAOffsetSeconds, DateAdd(minute, Route.StartTime, ACT.ManifestDate)) ELSE NULL END</td>
        <td>115</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN MSS.VisitStatusID IS NULL THEN CASE WHEN ACT.RouteEndDateTime IS NOT NULL THEN 'Skipped' WHEN ACT.RouteStartDateTime &lt; @AssumedEndDateTime THEN 'Skipped*' ELSE 'Pending' END WHEN MSS.VisitStatusID IN (0, 1) THEN CASE WHEN IsNull(MSS.BagsQuantity, 0) &gt; 0 THEN 'Pickup' ELSE 'No Pickup' END ELSE CASE WHEN IsNull(MSS.VisitStatusReason, '') = '' THEN 'Did Not Visit' ELSE MSS.VisitStatusReason END END</td>
        <td>116</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN ACT.RouteEndDateTime IS NOT NULL THEN 'Skipped' WHEN ACT.RouteStartDateTime &lt; @AssumedEndDateTime THEN 'Skipped*' ELSE 'Pending' END</td>
        <td>117</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN IsNull(MSS.BagsQuantity, 0) &gt; 0 THEN 'Pickup' ELSE 'No Pickup' END</td>
        <td>119</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN IsNull(MSS.VisitStatusReason, '') = '' THEN 'Did Not Visit' ELSE MSS.VisitStatusReason END</td>
        <td>121</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN MSS.LocationVariance IS NULL THEN NULL ELSE CASE WHEN IsNull(@UseMetricDistanceUnits, 0) = 0 THEN CONVERT (FLOAT, MSS.LocationVariance) * 3.28084 ELSE CONVERT (FLOAT, MSS.LocationVariance) END END</td>
        <td>124</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN IsNull(@UseMetricDistanceUnits, 0) = 0 THEN CONVERT (FLOAT, MSS.LocationVariance) * 3.28084 ELSE CONVERT (FLOAT, MSS.LocationVariance) END</td>
        <td>124</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN IsNull(MSS.VisitStatusID, 2) IN (0, 1) THEN IsNull(MSS.BagsQuantity, 0) ELSE 0 END</td>
        <td>125</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN IsNull(MSS.VisitStatusID, 2) IN (0, 1)
          AND IsNull(MSS.BagsQuantity, 0) &gt; 0 THEN dbo.RouteTrac_RetrieveVisitID(ACT.ClientAccountID, MSS.EntryDateTime) ELSE NULL END</td>
        <td>126</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN IsNull(Route.StartTime, 0) &gt; 0
          AND MS.ETAOffsetSeconds IS NOT NULL
          AND MS.ETAOffsetSeconds &gt;= 0 THEN DateAdd(second, MS.ETAOffsetSeconds, DateAdd(minute, Route.StartTime, ACT.ManifestDate)) ELSE NULL END</td>
        <td>145</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN MIS.OrderStatusID IS NULL THEN 'No Delivery Attempt' WHEN MIS.OrderStatusID = 0 THEN 'No Delivery Attempt' WHEN MIS.OrderStatusID = 1 THEN 'Delivery' WHEN MIS.OrderStatusID = 2 THEN 'Not Delivered' ELSE 'Unknown Status' END</td>
        <td>146</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN MIS.LocationVariance IS NULL THEN NULL ELSE CASE WHEN IsNull(@UseMetricDistanceUnits, 0) = 0 THEN CONVERT (FLOAT, MIS.LocationVariance) * 3.28084 ELSE CONVERT (FLOAT, MIS.LocationVariance) END END</td>
        <td>148</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">CASE WHEN IsNull(@UseMetricDistanceUnits, 0) = 0 THEN CONVERT (FLOAT, MIS.LocationVariance) * 3.28084 ELSE CONVERT (FLOAT, MIS.LocationVariance) END</td>
        <td>148</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">APPLY</td>
        <td colspan="1">MRSession WITH (NOLOCK)
INNER JOIN
dbo.fnGUIDListToTable(@RouteIDList) AS RouteList
ON RouteList.ID = MRSession.RouteID
INNER JOIN
ESM_SPUser AS SPUser WITH (NOLOCK)
ON SPUser.InstanceID = MRSession.SPUserID
INNER JOIN
Route WITH (NOLOCK)
ON Route.InstanceID = MRSession.RouteID
INNER JOIN
ManifestHistory AS MH WITH (NOLOCK)
ON MH.InstanceID = MRSession.ManifestID
   AND MH.ManifestDateTime BETWEEN @StartDate AND @EndDate OUTER APPLY (SELECT 'Stop' AS EntryType,
                                                                               ManifestHistoryStop.InstanceID AS StopID,
                                                                               NULL AS DeliveryID
                                                                        FROM   ManifestHistoryStop WITH (NOLOCK)
                                                                        WHERE  ManifestHistoryStop.ManifestID = MH.InstanceID
                                                                               AND ManifestHistoryStop.ClientAccountID &lt;&gt; 'D796891E-02F2-4803-999A-1AD0BF9BE58B'
                                                                        UNION
                                                                        SELECT 'Delivery' AS EntryType,
                                                                               ManifestHistoryInvoice.ManifestHistoryStopID AS StopID,
                                                                               ManifestHistoryInvoice.InstanceID AS DeliveryID
                                                                        FROM   ManifestHistoryInvoice WITH (NOLOCK)
                                                                        WHERE  ManifestHistoryInvoice.ManifestID = MH.InstanceID) AS Entries</td>
        <td>71</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">@Activity AS ACT
INNER JOIN
Visit WITH (NOLOCK)
ON Visit.InstanceID = ACT.PickedUpVisitID OUTER APPLY (SELECT Sum(PieceCount) AS PieceCount,
                                                              Sum(Price) AS Price
                                                       FROM   Invoice WITH (NOLOCK)
                                                       WHERE  Invoice.ClientAccountID = ACT.ClientAccountID
                                                              AND Invoice.Voided = 0
                                                              AND dbo.dateNoTime(Invoice.InitialVisitDateTime) = dbo.dateNoTime(Visit.VisitDateTime)) AS Invoices</td>
        <td>139</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">One-part names</td>
        <td colspan="1">MRSession WITH (NOLOCK)</td>
        <td>71</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">ESM_SPUser AS SPUser WITH (NOLOCK)</td>
        <td>73</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">Route WITH (NOLOCK)</td>
        <td>74</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistory AS MH WITH (NOLOCK)</td>
        <td>75</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryStop WITH (NOLOCK)</td>
        <td>79</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryInvoice WITH (NOLOCK)</td>
        <td>88</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">ACT</td>
        <td>93</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryStop AS MS WITH (NOLOCK)</td>
        <td>103</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">ClientAccount AS CA WITH (NOLOCK)</td>
        <td>104</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">ACT</td>
        <td>114</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">Route WITH (NOLOCK)</td>
        <td>130</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryStop AS MS WITH (NOLOCK)</td>
        <td>131</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryStopStatus AS MSS WITH (NOLOCK)</td>
        <td>132</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">ACT</td>
        <td>135</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">Visit WITH (NOLOCK)</td>
        <td>140</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">Invoice WITH (NOLOCK)</td>
        <td>141</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">ACT</td>
        <td>144</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">Route WITH (NOLOCK)</td>
        <td>154</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryStop AS MS WITH (NOLOCK)</td>
        <td>155</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryInvoice AS MI WITH (NOLOCK)</td>
        <td>156</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">Invoice AS I WITH (NOLOCK)</td>
        <td>157</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">ManifestHistoryInvoiceStatus AS MIS WITH (NOLOCK)</td>
        <td>158</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">NOLOCK</td>
        <td colspan="1">NOLOCK</td>
        <td>71</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>73</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>74</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>75</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>79</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>88</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>103</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>104</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>130</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>131</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>132</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>140</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>141</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>154</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>155</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>156</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>157</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">NOLOCK</td>
        <td>158</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">Table-valued functions</td>
        <td colspan="1">dbo.fnGUIDListToTable(@RouteIDList) AS RouteList</td>
        <td>72</td>
      </tr>
      <tr valign="top">
        <td colspan="1">UPDATE with FROM clause</td>
        <td colspan="1">
FROM @Activity AS ACT
     INNER JOIN
     ManifestHistoryStop AS MS WITH (NOLOCK)
     ON MS.InstanceID = ACT.ManifestStopID
     INNER JOIN
     ClientAccount AS CA WITH (NOLOCK)
     ON CA.InstanceID = MS.ClientAccountID</td>
        <td>102</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">
FROM @Activity AS ACT
     INNER JOIN
     Route WITH (NOLOCK)
     ON Route.InstanceID = ACT.RouteID
     INNER JOIN
     ManifestHistoryStop AS MS WITH (NOLOCK)
     ON MS.InstanceID = ACT.ManifestStopID
     LEFT OUTER JOIN
     ManifestHistoryStopStatus AS MSS WITH (NOLOCK)
     ON MSS.ManifestHistoryStopID = MS.InstanceID</td>
        <td>129</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">
FROM @Activity AS ACT
     INNER JOIN
     Visit WITH (NOLOCK)
     ON Visit.InstanceID = ACT.PickedUpVisitID OUTER APPLY (SELECT Sum(PieceCount) AS PieceCount,
                                                                   Sum(Price) AS Price
                                                            FROM   Invoice WITH (NOLOCK)
                                                            WHERE  Invoice.ClientAccountID = ACT.ClientAccountID
                                                                   AND Invoice.Voided = 0
                                                                   AND dbo.dateNoTime(Invoice.InitialVisitDateTime) = dbo.dateNoTime(Visit.VisitDateTime)) AS Invoices</td>
        <td>139</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1"></td>
        <td colspan="1">
FROM Invoice WITH (NOLOCK)</td>
        <td>141</td>
      </tr>
      <tr valign="top">
        <td colspan="1"></td>
        <td colspan="1">
FROM @Activity AS ACT
     INNER JOIN
     Route WITH (NOLOCK)
     ON Route.InstanceID = ACT.RouteID
     INNER JOIN
     ManifestHistoryStop AS MS WITH (NOLOCK)
     ON MS.InstanceID = ACT.ManifestStopID
     INNER JOIN
     ManifestHistoryInvoice AS MI WITH (NOLOCK)
     ON MI.InstanceID = ACT.ManifestInvoiceID
     INNER JOIN
     Invoice AS I WITH (NOLOCK)
     ON I.InstanceID = MI.InvoiceID
     LEFT OUTER JOIN
     ManifestHistoryInvoiceStatus AS MIS WITH (NOLOCK)
     ON MIS.ManifestHistoryInvoiceID = MI.InstanceID</td>
        <td>153</td>
      </tr>
      <tr valign="top" style="background-color:LightYellow">
        <td colspan="1">LEFT</td>
        <td colspan="1">LEFT(MS.Phone1, 16)</td>
        <td>97</td>
      </tr>
      <tr valign="top">
        <td colspan="1">Subquery</td>
        <td colspan="1">(SELECT Sum(PieceCount) AS PieceCount,
        Sum(Price) AS Price
 FROM   Invoice WITH (NOLOCK)
 WHERE  Invoice.ClientAccountID = ACT.ClientAccountID
        AND Invoice.Voided = 0
        AND dbo.dateNoTime(Invoice.InitialVisitDateTime) = dbo.dateNoTime(Visit.VisitDateTime)) AS Invoices</td>
        <td>141</td>
      </tr>
    </table>
  </body>
</html>